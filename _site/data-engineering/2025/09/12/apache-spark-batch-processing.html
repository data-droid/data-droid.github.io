<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="/assets/css/style.css">
  <!-- Head includes for Jekyll -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SEO -->

<meta name="description" content="Apache Sparkì˜ ê³ ê¸‰ ë°°ì¹˜ ì²˜ë¦¬ ê¸°ë²•, UDF ì‘ì„±, ê·¸ë¦¬ê³  Dockerì™€ Kubernetesë¥¼ í™œìš©í•œ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ì¶•ê¹Œì§€ ë‹¤ë£¹ë‹ˆë‹¤.">



<title>Part 2: Apache Spark ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ì²˜ë¦¬ì™€ UDF í™œìš© - ì‹¤ë¬´ í”„ë¡œì íŠ¸ - Data Droid Blog</title>


<!-- Open Graph -->
<meta property="og:title" content="Part 2: Apache Spark ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ì²˜ë¦¬ì™€ UDF í™œìš© - ì‹¤ë¬´ í”„ë¡œì íŠ¸">
<meta property="og:description" content="Apache Sparkì˜ ê³ ê¸‰ ë°°ì¹˜ ì²˜ë¦¬ ê¸°ë²•, UDF ì‘ì„±, ê·¸ë¦¬ê³  Dockerì™€ Kubernetesë¥¼ í™œìš©í•œ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ì¶•ê¹Œì§€ ë‹¤ë£¹ë‹ˆë‹¤.">
<meta property="og:url" content="http://localhost:4000/data-engineering/2025/09/12/apache-spark-batch-processing.html">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Part 2: Apache Spark ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ì²˜ë¦¬ì™€ UDF í™œìš© - ì‹¤ë¬´ í”„ë¡œì íŠ¸">
<meta name="twitter:description" content="Apache Sparkì˜ ê³ ê¸‰ ë°°ì¹˜ ì²˜ë¦¬ ê¸°ë²•, UDF ì‘ì„±, ê·¸ë¦¬ê³  Dockerì™€ Kubernetesë¥¼ í™œìš©í•œ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ì¶•ê¹Œì§€ ë‹¤ë£¹ë‹ˆë‹¤.">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Data Droid Blog" href="/feed.xml">

<!-- Google Analytics -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GP9LT745PP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GP9LT745PP');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <div class="site-title">
      <a href="/">Data Droid Blog</a>
    </div>
    
    <!-- Mobile menu toggle button -->
    <button class="mobile-menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    
    <nav class="site-nav">
      <ul class="nav-list">
        <li><a href="/">í™ˆ</a></li>
                  <li class="dropdown">
            <a href="#" class="dropdown-toggle">ì¹´í…Œê³ ë¦¬</a>
            <ul class="dropdown-menu">

              <li><a href="/categories/data-engineering/">ë°ì´í„° ì—”ì§€ë‹ˆì–´ë§</a></li>
              <li><a href="/categories/bi-engineering/">BI ì—”ì§€ë‹ˆì–´ë§</a></li>
              <li><a href="/categories/infrastructure-tools/">ì¸í”„ë¼ & ë„êµ¬</a></li>
              <li><a href="/categories/data-quality/">ë°ì´í„° í’ˆì§ˆ</a></li>
              <li><a href="/categories/data-ai/">Data AI</a></li>
            </ul>
          </li>
        <li><a href="/blog/">ë¸”ë¡œê·¸</a></li>
        <li><a href="/about/">ì†Œê°œ</a></li>
      </ul>
    </nav>
    
    <div class="language-switcher">
      
        <!-- í¬ìŠ¤íŠ¸ìš© ì–¸ì–´ ì „í™˜ -->
        
          <a href="/data-engineering/2025/09/12/apache-spark-batch-processing.html" class="lang-btn active">í•œêµ­ì–´</a>
          
          <a href="/en_posts/2025-09-12-apache-spark-batch-processing.html" class="lang-btn">English</a>
        
      
    </div>
  </div>
</header>

  
  <main class="site-main">
    <div class="container">
      <article class="post">
  <header class="post-header">
    <div class="post-meta">
      <span class="post-category">Data engineering</span>
      <span class="post-date">2025ë…„ 09ì›” 12ì¼</span>
      <span class="post-author">Data Droid</span>
    </div>
    
    <h1 class="post-title">Part 2: Apache Spark ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ì²˜ë¦¬ì™€ UDF í™œìš© - ì‹¤ë¬´ í”„ë¡œì íŠ¸</h1>
    
    
    <div class="post-tags">
      
        <span class="tag">Apache-Spark</span>
      
        <span class="tag">UDF</span>
      
        <span class="tag">ë°°ì¹˜ì²˜ë¦¬</span>
      
        <span class="tag">Docker</span>
      
        <span class="tag">Kubernetes</span>
      
        <span class="tag">Airflow</span>
      
        <span class="tag">ì„±ëŠ¥ìµœì í™”</span>
      
        <span class="tag">Python</span>
      
    </div>
    
    
    
    <div class="post-series">
      <span class="series-badge">ğŸ“š Apache spark complete guide ì‹œë¦¬ì¦ˆ</span>
      <span class="series-order">Part 3</span>
    </div>
    
    
    
    <div class="post-info">
      
        <span class="reading-time">â±ï¸ 45ë¶„</span>
      
      
        <span class="difficulty">ğŸ“Š ê³ ê¸‰</span>
      
    </div>
    
  </header>

  <div class="post-content">
    <h1 id="part-2-apache-spark-ëŒ€ìš©ëŸ‰-ë°°ì¹˜-ì²˜ë¦¬ì™€-udf-í™œìš©---ì‹¤ë¬´-í”„ë¡œì íŠ¸">Part 2: Apache Spark ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ì²˜ë¦¬ì™€ UDF í™œìš© - ì‹¤ë¬´ í”„ë¡œì íŠ¸</h1>

<blockquote>
  <p>Apache Sparkì˜ ê³ ê¸‰ ë°°ì¹˜ ì²˜ë¦¬ ê¸°ë²•, UDF ì‘ì„±, ê·¸ë¦¬ê³  Dockerì™€ Kubernetesë¥¼ í™œìš©í•œ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ì¶•ê¹Œì§€ ë‹¤ë£¹ë‹ˆë‹¤.</p>
</blockquote>

<h2 id="ëª©ì°¨">ğŸ“‹ ëª©ì°¨</h2>

<ol>
  <li><a href="#udf-user-defined-function-ì™„ì „-ì •ë¦¬">UDF (User Defined Function) ì™„ì „ ì •ë¦¬</a></li>
  <li><a href="#ê³ ê¸‰-ì§‘ê³„ì™€-ìœˆë„ìš°-í•¨ìˆ˜">ê³ ê¸‰ ì§‘ê³„ì™€ ìœˆë„ìš° í•¨ìˆ˜</a></li>
  <li><a href="#íŒŒí‹°ì…”ë‹-ì „ëµê³¼-ì„±ëŠ¥-ìµœì í™”">íŒŒí‹°ì…”ë‹ ì „ëµê³¼ ì„±ëŠ¥ ìµœì í™”</a></li>
  <li><a href="#ì‹¤ë¬´-í”„ë¡œì íŠ¸-ì „ììƒê±°ë˜-ë°ì´í„°-ë¶„ì„">ì‹¤ë¬´ í”„ë¡œì íŠ¸: ì „ììƒê±°ë˜ ë°ì´í„° ë¶„ì„</a></li>
  <li><a href="#dockerì™€-kubernetes-ë°°í¬">Dockerì™€ Kubernetes ë°°í¬</a></li>
  <li><a href="#airflow-ìŠ¤ì¼€ì¤„ë§">Airflow ìŠ¤ì¼€ì¤„ë§</a></li>
  <li><a href="#í•™ìŠµ-ìš”ì•½">í•™ìŠµ ìš”ì•½</a></li>
</ol>

<h2 id="udf-user-defined-function-ì™„ì „-ì •ë¦¬">ğŸ”§ UDF (User Defined Function) ì™„ì „ ì •ë¦¬</h2>

<h3 id="udfë€">UDFë€?</h3>

<p>UDFëŠ” Sparkì—ì„œ ì œê³µí•˜ì§€ ì•ŠëŠ” ì»¤ìŠ¤í…€ í•¨ìˆ˜ë¥¼ ì‘ì„±í•˜ì—¬ ë°ì´í„° ë³€í™˜ì— ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.</p>

<h3 id="udf-ì‘ì„±-ë°©ë²•">UDF ì‘ì„± ë°©ë²•</h3>

<h4 id="1-ê¸°ë³¸-udf-ì‘ì„±"><strong>1. ê¸°ë³¸ UDF ì‘ì„±</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">BooleanType</span>

<span class="c1"># ê°„ë‹¨í•œ ë¬¸ìì—´ ì²˜ë¦¬ UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">  </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ìˆ˜í•™ ê³„ì‚° UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount_rate</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">discount_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">discount_rate</span><span class="p">))</span>

<span class="c1"># ì¡°ê±´ë¶€ ì²˜ë¦¬ UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">categorize_price</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Unknown</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Low</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Medium</span><span class="sh">"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">High</span><span class="sh">"</span>

<span class="c1"># ì‚¬ìš© ì˜ˆì œ
</span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">  Product A  </span><span class="sh">"</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">Product B</span><span class="sh">"</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mf">600.0</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount_rate</span><span class="sh">"</span><span class="p">])</span>

<span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">clean_name</span><span class="sh">"</span><span class="p">,</span> <span class="nf">clean_text</span><span class="p">(</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">final_price</span><span class="sh">"</span><span class="p">,</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount_rate</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">price_category</span><span class="sh">"</span><span class="p">,</span> <span class="nf">categorize_price</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="2-ë³µì¡í•œ-udf---json-íŒŒì‹±"><strong>2. ë³µì¡í•œ UDF - JSON íŒŒì‹±</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">MapType</span><span class="p">,</span> <span class="n">StringType</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">MapType</span><span class="p">(</span><span class="nc">StringType</span><span class="p">(),</span> <span class="nc">StringType</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">parse_json_metadata</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_str</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="c1"># ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
</span>        <span class="k">return</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nf">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="c1"># ì‚¬ìš© ì˜ˆì œ
</span><span class="n">json_data</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">electronics</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Samsung</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">rating</span><span class="sh">"</span><span class="s">: 4.5}</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">clothing</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Nike</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">rating</span><span class="sh">"</span><span class="s">: 4.2}</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">invalid json</span><span class="sh">'</span><span class="p">)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">])</span>

<span class="n">json_data</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">parsed_metadata</span><span class="sh">"</span><span class="p">,</span> <span class="nf">parse_json_metadata</span><span class="p">(</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="3-ê³ ê¸‰-udf---ë¨¸ì‹ ëŸ¬ë‹-ëª¨ë¸-ì ìš©"><strong>3. ê³ ê¸‰ UDF - ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ ì ìš©</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">FloatType</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">IsolationForest</span>

<span class="c1"># ì „ì—­ ëª¨ë¸ ë³€ìˆ˜
</span><span class="n">model</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">initialize_model</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="c1"># ê°„ë‹¨í•œ ì´ìƒ íƒì§€ ëª¨ë¸ ì´ˆê¸°í™”
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">IsolationForest</span><span class="p">(</span><span class="n">contamination</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="c1"># ë”ë¯¸ ë°ì´í„°ë¡œ í›ˆë ¨
</span>    <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)</span>

<span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">anomaly_score</span><span class="p">(</span><span class="n">features_array</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nf">initialize_model</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">features_array</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">features_array</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">features_array</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">decision_function</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

<span class="c1"># ì‚¬ìš© ì˜ˆì œ
</span><span class="n">features_data</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">([</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">],),</span>
    <span class="p">([</span><span class="mf">10.5</span><span class="p">,</span> <span class="mf">15.2</span><span class="p">,</span> <span class="mf">8.9</span><span class="p">],),</span>
    <span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">features</span><span class="sh">"</span><span class="p">])</span>

<span class="n">features_data</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">anomaly_score</span><span class="sh">"</span><span class="p">,</span> <span class="nf">anomaly_score</span><span class="p">(</span><span class="sh">"</span><span class="s">features</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="udf-ìµœì í™”-íŒ">UDF ìµœì í™” íŒ</h3>

<h4 id="1-vectorized-udf-ì‚¬ìš©"><strong>1. Vectorized UDF ì‚¬ìš©</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">pandas_udf</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">FloatType</span>

<span class="c1"># Pandas UDFëŠ” ë” ë¹ ë¥¸ ì„±ëŠ¥ì„ ì œê³µ
</span><span class="nd">@pandas_udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">fast_calculation</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="c1"># ë²¡í„°í™”ëœ ì—°ì‚°ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ
</span>    <span class="k">return</span> <span class="n">series</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># ì‚¬ìš©
</span><span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">fast_result</span><span class="sh">"</span><span class="p">,</span> <span class="nf">fast_calculation</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="2-udf-ìºì‹±ê³¼-ì¬ì‚¬ìš©"><strong>2. UDF ìºì‹±ê³¼ ì¬ì‚¬ìš©</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># UDFë¥¼ í•¨ìˆ˜ë¡œ ì •ì˜í•˜ì—¬ ì¬ì‚¬ìš©
</span><span class="k">def</span> <span class="nf">create_text_processor</span><span class="p">():</span>
    <span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">process_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">process_text</span>

<span class="c1"># ì—¬ëŸ¬ DataFrameì—ì„œ ì¬ì‚¬ìš©
</span><span class="n">text_processor</span> <span class="o">=</span> <span class="nf">create_text_processor</span><span class="p">()</span>
<span class="n">df1</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">processed</span><span class="sh">"</span><span class="p">,</span> <span class="nf">text_processor</span><span class="p">(</span><span class="sh">"</span><span class="s">text1</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
<span class="n">df2</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">processed</span><span class="sh">"</span><span class="p">,</span> <span class="nf">text_processor</span><span class="p">(</span><span class="sh">"</span><span class="s">text2</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="ê³ ê¸‰-ì§‘ê³„ì™€-ìœˆë„ìš°-í•¨ìˆ˜">ğŸ“Š ê³ ê¸‰ ì§‘ê³„ì™€ ìœˆë„ìš° í•¨ìˆ˜</h2>

<h3 id="ê³ ê¸‰-ìœˆë„ìš°-í•¨ìˆ˜">ê³ ê¸‰ ìœˆë„ìš° í•¨ìˆ˜</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">row_number</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">lead</span><span class="p">,</span> 
    <span class="n">first_value</span><span class="p">,</span> <span class="n">last_value</span><span class="p">,</span> <span class="n">nth_value</span><span class="p">,</span>
    <span class="n">cume_dist</span><span class="p">,</span> <span class="n">percent_rank</span><span class="p">,</span> <span class="n">ntile</span>
<span class="p">)</span>

<span class="c1"># ë³µì¡í•œ ìœˆë„ìš° ìŠ¤í™ ì •ì˜
</span><span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ë‹¤ì–‘í•œ ìœˆë„ìš° í•¨ìˆ˜ ì ìš©
</span><span class="n">df_advanced</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">row_num</span><span class="sh">"</span><span class="p">,</span> <span class="nf">row_number</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">dense_rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">dense_rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">lag</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">next_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">lead</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">first_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">first_value</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">last_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">last_value</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">cumulative_dist</span><span class="sh">"</span><span class="p">,</span> <span class="nf">cume_dist</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">percentile_rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">percent_rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">quartile</span><span class="sh">"</span><span class="p">,</span> <span class="nf">ntile</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="ê³ ê¸‰-ì§‘ê³„-í•¨ìˆ˜">ê³ ê¸‰ ì§‘ê³„ í•¨ìˆ˜</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">collect_list</span><span class="p">,</span> <span class="n">collect_set</span><span class="p">,</span> <span class="n">array_agg</span><span class="p">,</span>
    <span class="n">stddev</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">skewness</span><span class="p">,</span> <span class="n">kurtosis</span><span class="p">,</span>
    <span class="n">corr</span><span class="p">,</span> <span class="n">covar_pop</span><span class="p">,</span> <span class="n">covar_samp</span>
<span class="p">)</span>

<span class="c1"># í†µê³„ì  ì§‘ê³„
</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">stddev</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">stddev_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">variance</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">variance_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">skewness</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">skewness_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">kurtosis</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">kurtosis_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">collect_list</span><span class="p">(</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">all_products</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">collect_set</span><span class="p">(</span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_brands</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<h2 id="íŒŒí‹°ì…”ë‹-ì „ëµê³¼-ì„±ëŠ¥-ìµœì í™”">âš¡ íŒŒí‹°ì…”ë‹ ì „ëµê³¼ ì„±ëŠ¥ ìµœì í™”</h2>

<h3 id="íŒŒí‹°ì…”ë‹-ì „ëµ">íŒŒí‹°ì…”ë‹ ì „ëµ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. ì»¬ëŸ¼ ê¸°ë°˜ íŒŒí‹°ì…”ë‹
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">year</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">month</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">path/to/partitioned_data</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2. ë²„í‚·íŒ…
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">bucketBy</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">sortBy</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">saveAsTable</span><span class="p">(</span><span class="sh">"</span><span class="s">bucketed_table</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 3. ë™ì  íŒŒí‹°ì…”ë‹
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">128MB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="ì„±ëŠ¥-ìµœì í™”-ì„¤ì •">ì„±ëŠ¥ ìµœì í™” ì„¤ì •</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ë©”ëª¨ë¦¬ ìµœì í™”
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ìºì‹± ì „ëµ
</span><span class="n">df</span><span class="p">.</span><span class="nf">cache</span><span class="p">()</span>  <span class="c1"># ë©”ëª¨ë¦¬ ìºì‹±
</span><span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_AND_DISK</span><span class="p">)</span>  <span class="c1"># ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ ìºì‹±
</span>
<span class="c1"># ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì¡°ì¸
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.autoBroadcastJoinThreshold</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10MB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="-ì‹¤ë¬´-í”„ë¡œì íŠ¸-ì „ììƒê±°ë˜-ë°ì´í„°-ë¶„ì„">ğŸ›’ ì‹¤ë¬´ í”„ë¡œì íŠ¸: ì „ììƒê±°ë˜ ë°ì´í„° ë¶„ì„</h2>

<h3 id="í”„ë¡œì íŠ¸-êµ¬ì¡°">í”„ë¡œì íŠ¸ êµ¬ì¡°</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ecommerce-analysis/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data_processing.py
â”‚   â”œâ”€â”€ analytics.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ spark_config.py
â”‚   â””â”€â”€ app_config.yaml
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_data_processing.py
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ kubernetes/
â”‚   â”œâ”€â”€ spark-job.yaml
â”‚   â””â”€â”€ airflow-dag.py
â””â”€â”€ README.md
</code></pre></div></div>

<h3 id="1-ë°ì´í„°-ì²˜ë¦¬-ëª¨ë“ˆ">1. ë°ì´í„° ì²˜ë¦¬ ëª¨ë“ˆ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/data_processing.py
</span><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="n">logging</span>

<span class="k">class</span> <span class="nc">EcommerceDataProcessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë°ì´í„° ë¡œë“œ</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Loading data from </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ë‹¤ì–‘í•œ ë°ì´í„° ì†ŒìŠ¤ ë¡œë“œ
</span>        <span class="n">orders_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/orders</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">products_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/products</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customers_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/customers</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span>
    
    <span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë°ì´í„° ì •ì œ</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Cleaning data...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ì¤‘ë³µ ì œê±°
</span>        <span class="n">orders_clean</span> <span class="o">=</span> <span class="n">orders_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">order_id</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">products_clean</span> <span class="o">=</span> <span class="n">products_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">customers_clean</span> <span class="o">=</span> <span class="n">customers_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">])</span>
        
        <span class="c1"># NULL ê°’ ì²˜ë¦¬
</span>        <span class="n">orders_clean</span> <span class="o">=</span> <span class="n">orders_clean</span><span class="p">.</span><span class="nf">fillna</span><span class="p">({</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">products_clean</span> <span class="o">=</span> <span class="n">products_clean</span><span class="p">.</span><span class="nf">fillna</span><span class="p">({</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Unknown</span><span class="sh">"</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span>
    
    <span class="k">def</span> <span class="nf">enrich_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë°ì´í„° í’ë¶€í™”</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Enriching data...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ì¡°ì¸ì„ í†µí•œ ë°ì´í„° í’ë¶€í™”
</span>        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">orders_df</span> \
            <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">products_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">customers_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ê³„ì‚°ëœ ì»¬ëŸ¼ ì¶”ê°€
</span>        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">,</span> 
            <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">discount</span><span class="sh">"</span><span class="p">))</span>
        <span class="p">)</span>
        
        <span class="c1"># ê³ ê° ë“±ê¸‰ ê³„ì‚° UDF
</span>        <span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">calculate_customer_tier</span><span class="p">(</span><span class="n">total_spent</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">VIP</span><span class="sh">"</span>
            <span class="k">elif</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Gold</span><span class="sh">"</span>
            <span class="k">elif</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Silver</span><span class="sh">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Bronze</span><span class="sh">"</span>
        
        <span class="c1"># ê³ ê°ë³„ ì´ êµ¬ë§¤ì•¡ ê³„ì‚°
</span>        <span class="n">customer_totals</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">customer_totals</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_tier</span><span class="sh">"</span><span class="p">,</span> <span class="nf">calculate_customer_tier</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">enriched_df</span>
</code></pre></div></div>

<h3 id="2-ê³ ê¸‰-ë¶„ì„-ëª¨ë“ˆ">2. ê³ ê¸‰ ë¶„ì„ ëª¨ë“ˆ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/analytics.py
</span><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="k">class</span> <span class="nc">EcommerceAnalytics</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">sales_analysis</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë§¤ì¶œ ë¶„ì„</span><span class="sh">"""</span>
        <span class="c1"># ì¼ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ
</span>        <span class="n">daily_sales</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">daily_revenue</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">daily_customers</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_order_value</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ì œí’ˆë³„ ë§¤ì¶œ ë¶„ì„
</span>        <span class="n">product_sales</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_quantity</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_revenue</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_customers</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="sh">"</span><span class="s">total_revenue</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">daily_sales</span><span class="p">,</span> <span class="n">product_sales</span>
    
    <span class="k">def</span> <span class="nf">customer_analysis</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ê³ ê° ë¶„ì„</span><span class="sh">"""</span>
        <span class="c1"># ê³ ê°ë³„ êµ¬ë§¤ íŒ¨í„´
</span>        <span class="n">customer_patterns</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_tier</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_orders</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_order_value</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">min</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">first_purchase</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">last_purchase</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># RFM ë¶„ì„ (Recency, Frequency, Monetary)
</span>        <span class="n">rfm_analysis</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">datediff</span><span class="p">(</span><span class="nf">current_date</span><span class="p">(),</span> <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">recency</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">frequency</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">monetary</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">customer_patterns</span><span class="p">,</span> <span class="n">rfm_analysis</span>
    
    <span class="k">def</span> <span class="nf">advanced_analytics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ê³ ê¸‰ ë¶„ì„</span><span class="sh">"""</span>
        <span class="c1"># ì½”í˜¸íŠ¸ ë¶„ì„
</span>        <span class="n">cohort_analysis</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_month</span><span class="sh">"</span><span class="p">,</span> <span class="nf">date_format</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yyyy-MM</span><span class="sh">"</span><span class="p">))</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_month</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span><span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_size</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="c1"># ìƒí’ˆ ì¶”ì²œì„ ìœ„í•œ í˜‘ì—… í•„í„°ë§ ê¸°ì´ˆ
</span>        <span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="n">customer_product_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">row_number</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
            <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># ìµœê·¼ 10ê°œ êµ¬ë§¤ ìƒí’ˆ
</span>        
        <span class="k">return</span> <span class="n">cohort_analysis</span><span class="p">,</span> <span class="n">customer_product_matrix</span>
</code></pre></div></div>

<h3 id="3-ì„¤ì •-íŒŒì¼">3. ì„¤ì • íŒŒì¼</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/spark_config.py
</span><span class="k">def</span> <span class="nf">get_spark_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">spark.app.name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">EcommerceAnalysis</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.master</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local[*]</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">128MB</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.serializer</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">org.apache.spark.serializer.KryoSerializer</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.execution.arrow.pyspark.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionFactor</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">5</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">256MB</span><span class="sh">"</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/app_config.yaml</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">input_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/input"</span>
  <span class="na">output_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/output"</span>
  <span class="na">checkpoint_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/checkpoint"</span>

<span class="na">processing</span><span class="pi">:</span>
  <span class="na">batch_size</span><span class="pi">:</span> <span class="m">10000</span>
  <span class="na">parallelism</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">cache_enabled</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">output</span><span class="pi">:</span>
  <span class="na">format</span><span class="pi">:</span> <span class="s2">"</span><span class="s">parquet"</span>
  <span class="na">compression</span><span class="pi">:</span> <span class="s2">"</span><span class="s">snappy"</span>
  <span class="na">partition_by</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">year"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">month"</span><span class="pi">]</span>
</code></pre></div></div>

<h2 id="-dockerì™€-kubernetes-ë°°í¬">ğŸ³ Dockerì™€ Kubernetes ë°°í¬</h2>

<h3 id="1-dockerfile">1. Dockerfile</h3>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="s"> openjdk:8-jdk-alpine</span>

<span class="c"># Python ì„¤ì¹˜</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> python3 py3-pip

<span class="c"># Spark ì„¤ì¹˜</span>
<span class="k">ENV</span><span class="s"> SPARK_VERSION=3.4.0</span>
<span class="k">ENV</span><span class="s"> HADOOP_VERSION=3</span>
<span class="k">ENV</span><span class="s"> SPARK_HOME=/opt/spark</span>
<span class="k">ENV</span><span class="s"> PATH=$PATH:$SPARK_HOME/bin</span>

<span class="k">RUN </span>wget <span class="nt">-q</span> https://archive.apache.org/dist/spark/spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span>/spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">tar </span>xzf spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">mv </span>spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span> <span class="k">${</span><span class="nv">SPARK_HOME</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">rm </span>spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz

<span class="c"># Python ì˜ì¡´ì„± ì„¤ì¹˜</span>
<span class="k">COPY</span><span class="s"> requirements.txt /app/</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬</span>
<span class="k">COPY</span><span class="s"> src/ /app/src/</span>
<span class="k">COPY</span><span class="s"> config/ /app/config/</span>

<span class="c"># ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /app/src/main.py

<span class="c"># í¬íŠ¸ ë…¸ì¶œ</span>
<span class="k">EXPOSE</span><span class="s"> 4040 8080</span>

<span class="c"># ì‹¤í–‰ ëª…ë ¹</span>
<span class="k">CMD</span><span class="s"> ["python3", "/app/src/main.py"]</span>
</code></pre></div></div>

<h3 id="2-kubernetes-job-ì„¤ì •">2. Kubernetes Job ì„¤ì •</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubernetes/spark-job.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ecommerce-analysis-job</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spark-driver</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">ecommerce-analysis:latest</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">python3"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/app/src/main.py"</span><span class="pi">]</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_MASTER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">k8s://https://kubernetes.default.svc.cluster.local:443"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_APP_NAME</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ecommerce-analysis"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_DRIVER_HOST</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.podIP</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_DRIVER_PORT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">7077"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_UI_PORT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">4040"</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">4Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/data</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app/config</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data-volume</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">data-pvc</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">app-config</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
  <span class="na">backoffLimit</span><span class="pi">:</span> <span class="m">3</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">data-pvc</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">100Gi</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">app-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">app_config.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">data:</span>
      <span class="s">input_path: "/data/input"</span>
      <span class="s">output_path: "/data/output"</span>
    <span class="s">processing:</span>
      <span class="s">batch_size: 10000</span>
      <span class="s">parallelism: 4</span>
</code></pre></div></div>

<h3 id="3-spark-application-ì‹¤í–‰">3. Spark Application ì‹¤í–‰</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">data_processing</span> <span class="kn">import</span> <span class="n">EcommerceDataProcessor</span>
<span class="kn">from</span> <span class="n">analytics</span> <span class="kn">import</span> <span class="n">EcommerceAnalytics</span>
<span class="kn">from</span> <span class="n">config.spark_config</span> <span class="kn">import</span> <span class="n">get_spark_config</span>

<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%(asctime)s - %(name)s - %(levelname)s - %(message)s</span><span class="sh">'</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nf">setup_logging</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Spark ì„¸ì…˜ ìƒì„±
</span>        <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
            <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="nf">get_spark_config</span><span class="p">())</span> \
            <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Spark session created successfully</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ë°ì´í„° ì²˜ë¦¬ê¸° ì´ˆê¸°í™”
</span>        <span class="n">processor</span> <span class="o">=</span> <span class="nc">EcommerceDataProcessor</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">analytics</span> <span class="o">=</span> <span class="nc">EcommerceAnalytics</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        
        <span class="c1"># ë°ì´í„° ê²½ë¡œ ì„¤ì •
</span>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">INPUT_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/data/input</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OUTPUT_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/data/output</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">load_data</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Cleaning data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">clean_data</span><span class="p">(</span>
            <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span>
        <span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Enriching data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">enrich_data</span><span class="p">(</span>
            <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span>
        <span class="p">)</span>
        
        <span class="c1"># ë¶„ì„ ìˆ˜í–‰
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing sales analysis...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">daily_sales</span><span class="p">,</span> <span class="n">product_sales</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">sales_analysis</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing customer analysis...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customer_patterns</span><span class="p">,</span> <span class="n">rfm_analysis</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">customer_analysis</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing advanced analytics...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">cohort_analysis</span><span class="p">,</span> <span class="n">customer_product_matrix</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">advanced_analytics</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="c1"># ê²°ê³¼ ì €ì¥
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Saving results...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">enriched_df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/enriched_data</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">daily_sales</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/daily_sales</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">product_sales</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/product_sales</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customer_patterns</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/customer_patterns</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rfm_analysis</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/rfm_analysis</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Job completed successfully!</span><span class="sh">"</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Job failed with error: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">spark</span><span class="sh">'</span> <span class="ow">in</span> <span class="nf">locals</span><span class="p">():</span>
            <span class="n">spark</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="airflow-ìŠ¤ì¼€ì¤„ë§">ğŸ”„ Airflow ìŠ¤ì¼€ì¤„ë§</h2>

<h3 id="airflow-dag">Airflow DAG</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubernetes/airflow-dag.py
</span><span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="n">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="n">airflow.kubernetes</span> <span class="kn">import</span> <span class="n">KubernetesPodOperator</span>
<span class="kn">from</span> <span class="n">airflow.operators.dummy</span> <span class="kn">import</span> <span class="n">DummyOperator</span>
<span class="kn">from</span> <span class="n">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>

<span class="c1"># ê¸°ë³¸ ì¸ìˆ˜
</span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">owner</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-engineering</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">depends_on_past</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="nf">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">email_on_failure</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">email_on_retry</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">retries</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">retry_delay</span><span class="sh">'</span><span class="p">:</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># DAG ì •ì˜
</span><span class="n">dag</span> <span class="o">=</span> <span class="nc">DAG</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">ecommerce_analysis_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">ì „ììƒê±°ë˜ ë°ì´í„° ë¶„ì„ íŒŒì´í”„ë¼ì¸</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="sh">'</span><span class="s">0 2 * * *</span><span class="sh">'</span><span class="p">,</span>  <span class="c1"># ë§¤ì¼ ì˜¤ì „ 2ì‹œ ì‹¤í–‰
</span>    <span class="n">catchup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">ecommerce</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">spark</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">analytics</span><span class="sh">'</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># ì‹œì‘ ì‘ì—…
</span><span class="n">start_task</span> <span class="o">=</span> <span class="nc">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">start_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ë°ì´í„° ê²€ì¦ ì‘ì—…
</span><span class="k">def</span> <span class="nf">validate_input_data</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">os</span>
    <span class="n">input_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/input</span><span class="sh">"</span>
    <span class="n">required_files</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">orders</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">products</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">customers</span><span class="sh">"</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">required_files</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Required file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Input data validation completed successfully</span><span class="sh">"</span><span class="p">)</span>

<span class="n">validate_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">validate_input_data</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">validate_input_data</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Spark ë¶„ì„ ì‘ì—…
</span><span class="n">spark_analysis_task</span> <span class="o">=</span> <span class="nc">KubernetesPodOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">spark_ecommerce_analysis</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="sh">'</span><span class="s">data-engineering</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="sh">'</span><span class="s">ecommerce-analysis:latest</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">spark-analysis-pod</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">cmds</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">python3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">/app/src/main.py</span><span class="sh">'</span><span class="p">],</span>
    <span class="n">env_vars</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">INPUT_PATH</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data/input</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">OUTPUT_PATH</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data/output</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">SPARK_MASTER</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">k8s://https://kubernetes.default.svc.cluster.local:443</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">SPARK_APP_NAME</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ecommerce-analysis</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">request_memory</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2Gi</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">request_cpu</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">limit_memory</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">4Gi</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">limit_cpu</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">volumes</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-volume</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">persistentVolumeClaim</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">claimName</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-pvc</span><span class="sh">'</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="n">volume_mounts</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-volume</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">mountPath</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data</span><span class="sh">'</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="n">get_logs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">is_delete_operator_pod</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ê²°ê³¼ ê²€ì¦ ì‘ì—…
</span><span class="k">def</span> <span class="nf">validate_output_data</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">os</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/output</span><span class="sh">"</span>
    <span class="n">required_outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">enriched_data</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">daily_sales</span><span class="sh">"</span><span class="p">,</span> 
        <span class="sh">"</span><span class="s">product_sales</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">customer_patterns</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">rfm_analysis</span><span class="sh">"</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">required_outputs</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Output directory not found: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
</span>        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Output directory is empty: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Output data validation completed successfully</span><span class="sh">"</span><span class="p">)</span>

<span class="n">validate_output_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">validate_output_data</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">validate_output_data</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ì•Œë¦¼ ì‘ì—…
</span><span class="k">def</span> <span class="nf">send_completion_notification</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Ecommerce analysis pipeline completed successfully!</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Slack, Email ë“±ìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡
</span>    <span class="c1"># slack_webhook_url = os.getenv('SLACK_WEBHOOK_URL')
</span>    <span class="c1"># send_slack_notification(slack_webhook_url, "Pipeline completed successfully")
</span>
<span class="n">notification_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">send_completion_notification</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">send_completion_notification</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ì¢…ë£Œ ì‘ì—…
</span><span class="n">end_task</span> <span class="o">=</span> <span class="nc">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">end_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ì‘ì—… ì˜ì¡´ì„± ì •ì˜
</span><span class="n">start_task</span> <span class="o">&gt;&gt;</span> <span class="n">validate_task</span> <span class="o">&gt;&gt;</span> <span class="n">spark_analysis_task</span> <span class="o">&gt;&gt;</span> <span class="n">validate_output_task</span> <span class="o">&gt;&gt;</span> <span class="n">notification_task</span> <span class="o">&gt;&gt;</span> <span class="n">end_task</span>
</code></pre></div></div>

<h3 id="ë°°í¬-ìŠ¤í¬ë¦½íŠ¸">ë°°í¬ ìŠ¤í¬ë¦½íŠ¸</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># deploy.sh</span>

<span class="nb">echo</span> <span class="s2">"Building Docker image..."</span>
docker build <span class="nt">-t</span> ecommerce-analysis:latest <span class="nb">.</span>

<span class="nb">echo</span> <span class="s2">"Loading image to Kubernetes cluster..."</span>
kind load docker-image ecommerce-analysis:latest

<span class="nb">echo</span> <span class="s2">"Applying Kubernetes manifests..."</span>
kubectl apply <span class="nt">-f</span> kubernetes/spark-job.yaml

<span class="nb">echo</span> <span class="s2">"Deploying Airflow DAG..."</span>
kubectl <span class="nb">cp </span>kubernetes/airflow-dag.py airflow-web-0:/opt/airflow/dags/

<span class="nb">echo</span> <span class="s2">"Deployment completed!"</span>
</code></pre></div></div>

<h2 id="ë°°ì¹˜-ì²˜ë¦¬-ì²˜ë¦¬ëŸ‰-ìµœì í™”">âš¡ ë°°ì¹˜ ì²˜ë¦¬ ì²˜ë¦¬ëŸ‰ ìµœì í™”</h2>

<h3 id="ì²˜ë¦¬ëŸ‰-ë¶„ì„-ë„êµ¬">ì²˜ë¦¬ëŸ‰ ë¶„ì„ ë„êµ¬</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ë°°ì¹˜ ì²˜ë¦¬ëŸ‰ ë¶„ì„ ë° ìµœì í™” ë„êµ¬
</span><span class="k">class</span> <span class="nc">BatchThroughputOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        
    <span class="k">def</span> <span class="nf">analyze_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">operation_name</span><span class="o">=</span><span class="sh">"</span><span class="s">batch_operation</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì²˜ë¦¬ëŸ‰ ë¶„ì„</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span>
        
        <span class="c1"># ë°ì´í„° í¬ê¸° ì¸¡ì •
</span>        <span class="n">row_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        <span class="n">num_partitions</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span>
        
        <span class="c1"># ì²˜ë¦¬ ì‹œê°„ ì¸¡ì •
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="c1"># ìƒ˜í”Œ ì‘ì—… ì‹¤í–‰ (ì‹¤ì œ ì‘ì—…ìœ¼ë¡œ ëŒ€ì²´)
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_count</span><span class="sh">"</span><span class="p">)).</span><span class="nf">collect</span><span class="p">()</span>
        
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">processing_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        
        <span class="c1"># ì²˜ë¦¬ëŸ‰ ê³„ì‚°
</span>        <span class="n">throughput_records_per_second</span> <span class="o">=</span> <span class="n">row_count</span> <span class="o">/</span> <span class="n">processing_time</span> <span class="k">if</span> <span class="n">processing_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation_name</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">:</span> <span class="n">row_count</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">num_partitions</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_partitions</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">processing_time_seconds</span><span class="sh">'</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">throughput_records_per_second</span><span class="sh">'</span><span class="p">:</span> <span class="n">throughput_records_per_second</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">throughput_records_per_minute</span><span class="sh">'</span><span class="p">:</span> <span class="n">throughput_records_per_second</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_records_per_partition</span><span class="sh">'</span><span class="p">:</span> <span class="n">row_count</span> <span class="o">/</span> <span class="n">num_partitions</span> <span class="k">if</span> <span class="n">num_partitions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">optimize_partitioning_for_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target_records_per_partition</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì²˜ë¦¬ëŸ‰ì„ ìœ„í•œ íŒŒí‹°ì…”ë‹ ìµœì í™”</span><span class="sh">"""</span>
        <span class="n">current_partitions</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span>
        <span class="n">row_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        
        <span class="c1"># ìµœì  íŒŒí‹°ì…˜ ìˆ˜ ê³„ì‚°
</span>        <span class="n">optimal_partitions</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_count</span> <span class="o">//</span> <span class="n">target_records_per_partition</span><span class="p">)</span>
        
        <span class="c1"># íŒŒí‹°ì…˜ í¬ê¸° ê¸°ë°˜ ì¡°ì •
</span>        <span class="k">if</span> <span class="n">optimal_partitions</span> <span class="o">&gt;</span> <span class="n">current_partitions</span><span class="p">:</span>
            <span class="c1"># íŒŒí‹°ì…˜ ìˆ˜ ì¦ê°€
</span>            <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="n">optimal_partitions</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">repartitioned from </span><span class="si">{</span><span class="n">current_partitions</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">optimal_partitions</span><span class="si">}</span><span class="s"> partitions</span><span class="sh">"</span>
        <span class="k">elif</span> <span class="n">optimal_partitions</span> <span class="o">&lt;</span> <span class="n">current_partitions</span><span class="p">:</span>
            <span class="c1"># íŒŒí‹°ì…˜ ìˆ˜ ê°ì†Œ
</span>            <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">coalesce</span><span class="p">(</span><span class="n">optimal_partitions</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">coalesced from </span><span class="si">{</span><span class="n">current_partitions</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">optimal_partitions</span><span class="si">}</span><span class="s"> partitions</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">action</span> <span class="o">=</span> <span class="sh">"</span><span class="s">no partitioning change needed</span><span class="sh">"</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">optimized_dataframe</span><span class="sh">'</span><span class="p">:</span> <span class="n">optimized_df</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">original_partitions</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_partitions</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">optimized_partitions</span><span class="sh">'</span><span class="p">:</span> <span class="n">optimal_partitions</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">action_taken</span><span class="sh">'</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">target_records_per_partition</span><span class="sh">'</span><span class="p">:</span> <span class="n">target_records_per_partition</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">optimize_memory_for_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì²˜ë¦¬ëŸ‰ì„ ìœ„í•œ ë©”ëª¨ë¦¬ ìµœì í™”</span><span class="sh">"""</span>
        <span class="n">memory_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># ë©”ëª¨ë¦¬ ê´€ë ¨ ì„¤ì •
</span>            <span class="sh">'</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">128MB</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            
            <span class="c1"># ì§ë ¬í™” ìµœì í™”
</span>            <span class="sh">'</span><span class="s">spark.serializer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">org.apache.spark.serializer.KryoSerializer</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.pyspark.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.maxRecordsPerBatch</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">10000</span><span class="sh">'</span><span class="p">,</span>
            
            <span class="c1"># ìºì‹± ìµœì í™”
</span>            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.pyspark.fallback.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.localShuffleReader.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            
            <span class="c1"># ì¡°ì¸ ìµœì í™”
</span>            <span class="sh">'</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionFactor</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">256MB</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">memory_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">spark_session</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">memory_configs</span>
    
    <span class="k">def</span> <span class="nf">implement_parallel_processing</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">parallelism_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë³‘ë ¬ ì²˜ë¦¬ êµ¬í˜„</span><span class="sh">"""</span>
        <span class="n">current_partitions</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span>
        <span class="n">optimized_partitions</span> <span class="o">=</span> <span class="n">current_partitions</span> <span class="o">*</span> <span class="n">parallelism_factor</span>
        
        <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="n">optimized_partitions</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">optimize_data_loading</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">format_type</span><span class="o">=</span><span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë°ì´í„° ë¡œë”© ìµœì í™”</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Parquet íŒŒì¼ ìµœì í™”
</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="c1"># íŒŒí‹°ì…˜ í”„ë£¨ë‹ í™œì„±í™”
</span>            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.optimizer.metadataOnly</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.filterPushdown</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.mergeSchema</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># CSV íŒŒì¼ ìµœì í™”
</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">).</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">inferSchema</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">).</span><span class="nf">csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="c1"># ë³‘ë ¬ ë¡œë”©ì„ ìœ„í•œ íŒŒí‹°ì…”ë‹
</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">df</span>

<span class="c1"># ì²˜ë¦¬ëŸ‰ ìµœì í™” ì˜ˆì œ
</span><span class="k">def</span> <span class="nf">batch_throughput_optimization_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">BatchThroughputOptimization</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="nc">BatchThroughputOptimizer</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># ìƒ˜í”Œ ë°ì´í„° ìƒì„±
</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">product_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">10.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># ì²˜ë¦¬ëŸ‰ ë¶„ì„
</span>    <span class="n">throughput_analysis</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">analyze_throughput</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sh">"</span><span class="s">sample_analysis</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Batch Throughput Analysis ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Records: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Processing Time: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">processing_time_seconds</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Throughput: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">throughput_records_per_second</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Partitions: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">num_partitions</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># íŒŒí‹°ì…”ë‹ ìµœì í™”
</span>    <span class="n">partitioning_result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_partitioning_for_throughput</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Partitioning Optimization: </span><span class="si">{</span><span class="n">partitioning_result</span><span class="p">[</span><span class="sh">'</span><span class="s">action_taken</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># ë©”ëª¨ë¦¬ ìµœì í™”
</span>    <span class="n">memory_configs</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_memory_for_throughput</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Memory Optimization Configs ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">memory_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># ë³‘ë ¬ ì²˜ë¦¬ ìµœì í™”
</span>    <span class="n">parallel_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">implement_parallel_processing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Parallel Processing: </span><span class="si">{</span><span class="n">parallel_df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span><span class="si">}</span><span class="s"> partitions</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimizer</span>
</code></pre></div></div>

<h3 id="ê³ ê¸‰-ì²˜ë¦¬ëŸ‰-ìµœì í™”-ê¸°ë²•">ê³ ê¸‰ ì²˜ë¦¬ëŸ‰ ìµœì í™” ê¸°ë²•</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê³ ê¸‰ ì²˜ë¦¬ëŸ‰ ìµœì í™” í´ë˜ìŠ¤
</span><span class="k">class</span> <span class="nc">AdvancedThroughputOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">implement_columnar_processing</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì»¬ëŸ¼í˜• ì²˜ë¦¬ ìµœì í™”</span><span class="sh">"""</span>
        <span class="c1"># Parquet í˜•ì‹ìœ¼ë¡œ ì €ì¥í•˜ì—¬ ì»¬ëŸ¼í˜• ì²˜ë¦¬ í™œì„±í™”
</span>        <span class="n">temp_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/tmp/optimized_data</span><span class="sh">"</span>
        
        <span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
        
        <span class="c1"># ìµœì í™”ëœ ì„¤ì •ìœ¼ë¡œ ë‹¤ì‹œ ì½ê¸°
</span>        <span class="n">optimized_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.filterPushdown</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.mergeSchema</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">false</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.enableVectorizedReader</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.columnarReaderBatchSize</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">4096</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">optimized_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">optimize_joins_for_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">join_key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì¡°ì¸ ìµœì í™”</span><span class="sh">"""</span>
        <span class="c1"># ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì¡°ì¸ íŒíŠ¸ ì ìš© (ì‘ì€ í…Œì´ë¸”ì˜ ê²½ìš°)
</span>        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">broadcast</span>
        
        <span class="c1"># í…Œì´ë¸” í¬ê¸° ë¹„êµ
</span>        <span class="n">size1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        <span class="n">size2</span> <span class="o">=</span> <span class="n">df2</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">size1</span> <span class="o">&lt;</span> <span class="n">size2</span> <span class="ow">and</span> <span class="n">size1</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">:</span>  <span class="c1"># 10ë§Œ ë ˆì½”ë“œ ë¯¸ë§Œ
</span>            <span class="n">optimized_df1</span> <span class="o">=</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
            <span class="n">optimized_df2</span> <span class="o">=</span> <span class="n">df2</span>
        <span class="k">elif</span> <span class="n">size2</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="n">optimized_df1</span> <span class="o">=</span> <span class="n">df1</span>
            <span class="n">optimized_df2</span> <span class="o">=</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimized_df1</span> <span class="o">=</span> <span class="n">df1</span>
            <span class="n">optimized_df2</span> <span class="o">=</span> <span class="n">df2</span>
        
        <span class="c1"># ì¡°ì¸ ì‹¤í–‰
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">optimized_df1</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">optimized_df2</span><span class="p">,</span> <span class="n">join_key</span><span class="p">,</span> <span class="sh">"</span><span class="s">inner</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">implement_bucketing_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">bucket_columns</span><span class="p">,</span> <span class="n">num_buckets</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë²„í‚·íŒ… ì „ëµ êµ¬í˜„</span><span class="sh">"""</span>
        <span class="c1"># ë²„í‚·íŒ…ì„ ìœ„í•œ ì„ì‹œ í…Œì´ë¸” ìƒì„±
</span>        <span class="n">temp_table_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">temp_bucketed_table</span><span class="sh">"</span>
        
        <span class="c1"># ë²„í‚·íŒ… ì„¤ì •
</span>        <span class="n">bucketing_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">spark.sql.sources.bucketing.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.sources.bucketing.autoBucketedScan.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">bucketing_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># ë²„í‚·íŒ…ëœ í…Œì´ë¸”ë¡œ ì €ì¥
</span>        <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
            <span class="p">.</span><span class="nf">bucketBy</span><span class="p">(</span><span class="n">num_buckets</span><span class="p">,</span> <span class="o">*</span><span class="n">bucket_columns</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">saveAsTable</span><span class="p">(</span><span class="n">temp_table_name</span><span class="p">)</span>
        
        <span class="c1"># ë²„í‚·íŒ…ëœ í…Œì´ë¸” ì½ê¸°
</span>        <span class="n">bucketed_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="nf">table</span><span class="p">(</span><span class="n">temp_table_name</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">bucketed_df</span>
    
    <span class="k">def</span> <span class="nf">optimize_aggregations</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">group_columns</span><span class="p">,</span> <span class="n">agg_columns</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì§‘ê³„ ìµœì í™”</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="nb">sum</span> <span class="k">as</span> <span class="n">spark_sum</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">max</span> <span class="k">as</span> <span class="n">spark_max</span>
        
        <span class="c1"># ì§‘ê³„ ì „ íŒŒí‹°ì…”ë‹ ìµœì í™”
</span>        <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="o">*</span><span class="n">group_columns</span><span class="p">)</span>
        
        <span class="c1"># ì§‘ê³„ ì‹¤í–‰
</span>        <span class="n">aggregation_result</span> <span class="o">=</span> <span class="n">optimized_df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="o">*</span><span class="n">group_columns</span><span class="p">).</span><span class="nf">agg</span><span class="p">(</span>
            <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">record_count</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">spark_sum</span><span class="p">(</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">alias</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">total_</span><span class="si">{</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">avg</span><span class="p">(</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">alias</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">avg_</span><span class="si">{</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">spark_max</span><span class="p">(</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">alias</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">max_</span><span class="si">{</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">aggregation_result</span>
    
    <span class="k">def</span> <span class="nf">implement_caching_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">access_frequency</span><span class="o">=</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ìºì‹± ì „ëµ êµ¬í˜„</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark</span> <span class="kn">import</span> <span class="n">StorageLevel</span>
        
        <span class="k">if</span> <span class="n">access_frequency</span> <span class="o">==</span> <span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ëŠ” ë©”ëª¨ë¦¬ì— ìºì‹±
</span>            <span class="n">cached_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_ONLY</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">access_frequency</span> <span class="o">==</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ì¤‘ê°„ ë¹ˆë„ëŠ” ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ ìºì‹±
</span>            <span class="n">cached_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_AND_DISK_SER</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ë‚®ì€ ë¹ˆë„ëŠ” ë””ìŠ¤í¬ ìºì‹±
</span>            <span class="n">cached_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">DISK_ONLY</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cached_df</span>
    
    <span class="k">def</span> <span class="nf">optimize_file_formats</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">format_type</span><span class="o">=</span><span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">íŒŒì¼ í˜•ì‹ ìµœì í™”</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Parquet ìµœì í™” ì„¤ì •
</span>            <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
                <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">snappy</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">parquet.block.size</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">134217728</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">parquet.page.size</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1048576</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ORC ìµœì í™” ì„¤ì •
</span>            <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
                <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">zlib</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.stripe.size</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">67108864</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">orc</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">delta</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Delta Lake ìµœì í™” ì„¤ì •
</span>            <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
                <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">delta</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">delta.autoOptimize.optimizeWrite</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">delta.autoOptimize.autoCompact</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Data saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s"> in </span><span class="si">{</span><span class="n">format_type</span><span class="si">}</span><span class="s"> format</span><span class="sh">"</span>

<span class="c1"># ê³ ê¸‰ ì²˜ë¦¬ëŸ‰ ìµœì í™” ì˜ˆì œ
</span><span class="k">def</span> <span class="nf">advanced_throughput_optimization_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">AdvancedThroughputOptimization</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="nc">AdvancedThroughputOptimizer</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># ìƒ˜í”Œ ë°ì´í„° ìƒì„±
</span>    <span class="n">data1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">product_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">10.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">500000</span><span class="p">)]</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category_id</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="n">data2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">category_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">category_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category_name</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># ì»¬ëŸ¼í˜• ì²˜ë¦¬ ìµœì í™”
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Implementing Columnar Processing ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">columnar_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">implement_columnar_processing</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Columnar processing implemented: </span><span class="si">{</span><span class="n">columnar_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">}</span><span class="s"> records</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># ì¡°ì¸ ìµœì í™”
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Optimizing Joins ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_joins_for_throughput</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="sh">"</span><span class="s">category_id</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Join optimization completed: </span><span class="si">{</span><span class="n">joined_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">}</span><span class="s"> records</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># ì§‘ê³„ ìµœì í™”
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Optimizing Aggregations ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">aggregated_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_aggregations</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">category_name</span><span class="sh">"</span><span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Aggregation optimization completed: </span><span class="si">{</span><span class="n">aggregated_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">}</span><span class="s"> groups</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># íŒŒì¼ í˜•ì‹ ìµœì í™”
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Optimizing File Formats ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">output_result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_file_formats</span><span class="p">(</span><span class="n">aggregated_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">/tmp/optimized_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">output_result</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimizer</span>
</code></pre></div></div>

<h3 id="ì²˜ë¦¬ëŸ‰-ëª¨ë‹ˆí„°ë§-ì‹œìŠ¤í…œ">ì²˜ë¦¬ëŸ‰ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì²˜ë¦¬ëŸ‰ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
</span><span class="k">class</span> <span class="nc">ThroughputMonitoringSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">monitor_batch_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë°°ì¹˜ ì²˜ë¦¬ëŸ‰ ëª¨ë‹ˆí„°ë§</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        
        <span class="n">total_records</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_records</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
        
        <span class="n">batch_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nf">min</span><span class="p">((</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">total_records</span><span class="p">)</span>
            
            <span class="c1"># ë°°ì¹˜ ë°ì´í„° ì¶”ì¶œ
</span>            <span class="n">batch_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">end_idx</span><span class="p">).</span><span class="nf">subtract</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">start_idx</span><span class="p">))</span>
            
            <span class="c1"># ë°°ì¹˜ ì²˜ë¦¬ ì‹œê°„ ì¸¡ì •
</span>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">batch_count</span> <span class="o">=</span> <span class="n">batch_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            
            <span class="n">processing_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">throughput</span> <span class="o">=</span> <span class="n">batch_count</span> <span class="o">/</span> <span class="n">processing_time</span> <span class="k">if</span> <span class="n">processing_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="n">batch_metric</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation_name</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">batch_idx</span><span class="sh">'</span><span class="p">:</span> <span class="n">batch_idx</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">batch_size</span><span class="sh">'</span><span class="p">:</span> <span class="n">batch_count</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">processing_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">throughput_records_per_second</span><span class="sh">'</span><span class="p">:</span> <span class="n">throughput</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="p">}</span>
            
            <span class="n">batch_metrics</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">batch_metric</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Batch </span><span class="si">{</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">throughput</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># ì „ì²´ í†µê³„ ê³„ì‚°
</span>        <span class="n">total_time</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">processing_time</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="p">)</span>
        <span class="n">avg_throughput</span> <span class="o">=</span> <span class="n">total_records</span> <span class="o">/</span> <span class="n">total_time</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation_name</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_records</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_batches</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_batches</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_throughput</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">batch_metrics</span><span class="sh">'</span><span class="p">:</span> <span class="n">batch_metrics</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary</span>
    
    <span class="k">def</span> <span class="nf">generate_throughput_report</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì²˜ë¦¬ëŸ‰ ë³´ê³ ì„œ ìƒì„±</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">No metrics available</span><span class="sh">"</span><span class="p">}</span>
        
        <span class="c1"># ì „ì²´ í†µê³„ ê³„ì‚°
</span>        <span class="n">total_operations</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">total_records</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">overall_throughput</span> <span class="o">=</span> <span class="n">total_records</span> <span class="o">/</span> <span class="n">total_time</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># ìµœê³ /ìµœì € ì²˜ë¦¬ëŸ‰ ì°¾ê¸°
</span>        <span class="n">max_throughput</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">min_throughput</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">total_operations</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_operations</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">total_records_processed</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_records</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">overall_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">overall_throughput</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">max_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">max_throughput</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">min_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">min_throughput</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">operation_details</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_generate_throughput_recommendations</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">report</span>
    
    <span class="k">def</span> <span class="nf">_generate_throughput_recommendations</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì²˜ë¦¬ëŸ‰ ê°œì„  ê¶Œì¥ì‚¬í•­ ìƒì„±</span><span class="sh">"""</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">recommendations</span>
        
        <span class="c1"># í‰ê·  ì²˜ë¦¬ëŸ‰ ê³„ì‚°
</span>        <span class="n">avg_throughput</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        
        <span class="c1"># ì²˜ë¦¬ëŸ‰ì´ ë‚®ì€ ê²½ìš° ê¶Œì¥ì‚¬í•­
</span>        <span class="k">if</span> <span class="n">avg_throughput</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>  <span class="c1"># 10,000 records/sec ë¯¸ë§Œ
</span>            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">partitioning</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">íŒŒí‹°ì…˜ ìˆ˜ë¥¼ ì¦ê°€ì‹œì¼œ ë³‘ë ¬ ì²˜ë¦¬ë¥¼ í–¥ìƒì‹œí‚¤ì„¸ìš”</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">repartition() ë˜ëŠ” coalesce() ì‚¬ìš© ê³ ë ¤</span><span class="sh">'</span>
            <span class="p">})</span>
            
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">caching</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ë¥¼ ìºì‹±í•˜ì„¸ìš”</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">cache() ë˜ëŠ” persist() ì‚¬ìš©</span><span class="sh">'</span>
            <span class="p">})</span>
        
        <span class="c1"># ì²˜ë¦¬ëŸ‰ ë³€ë™ì´ í° ê²½ìš°
</span>        <span class="n">throughputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">]</span>
        <span class="n">throughput_variance</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">throughputs</span><span class="p">)</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="n">throughputs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">throughput_variance</span> <span class="o">&gt;</span> <span class="n">avg_throughput</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># ë³€ë™ì´ í‰ê· ì˜ 50% ì´ìƒ
</span>            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">stability</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ì²˜ë¦¬ëŸ‰ ì•ˆì •ì„±ì„ ìœ„í•´ ë°ì´í„° ë¶„í¬ë¥¼ ê°œì„ í•˜ì„¸ìš”</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ë°ì´í„° ìŠ¤í ë¬¸ì œ í™•ì¸ ë° í•´ê²°</span><span class="sh">'</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">recommendations</span>
    
    <span class="k">def</span> <span class="nf">export_metrics_to_monitoring_system</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œìœ¼ë¡œ ë©”íŠ¸ë¦­ ë‚´ë³´ë‚´ê¸°</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">requests</span>
        <span class="kn">import</span> <span class="n">json</span>
        
        <span class="c1"># Prometheus í˜•ì‹ìœ¼ë¡œ ë©”íŠ¸ë¦­ ë³€í™˜
</span>        <span class="n">prometheus_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">operation_details</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">metric_name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">spark_batch_throughput</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">labels</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">operation</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation</span><span class="p">[</span><span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="n">prometheus_metrics</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        
        <span class="c1"># ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Prometheus Pushgatewayë¡œ ì „ì†¡
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Exported Metrics to Monitoring System ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">prometheus_metrics</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">metric_name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">labels</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ì²˜ë¦¬ëŸ‰ ëª¨ë‹ˆí„°ë§ ì˜ˆì œ
</span><span class="k">def</span> <span class="nf">throughput_monitoring_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">ThroughputMonitoring</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="nc">ThroughputMonitoringSystem</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># ìƒ˜í”Œ ë°ì´í„° ìƒì„±
</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># ì²˜ë¦¬ëŸ‰ ëª¨ë‹ˆí„°ë§
</span>    <span class="n">throughput_summary</span> <span class="o">=</span> <span class="n">monitor</span><span class="p">.</span><span class="nf">monitor_batch_throughput</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sh">"</span><span class="s">sample_processing</span><span class="sh">"</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Throughput Summary ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Records: </span><span class="si">{</span><span class="n">throughput_summary</span><span class="p">[</span><span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average Throughput: </span><span class="si">{</span><span class="n">throughput_summary</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Processing Time: </span><span class="si">{</span><span class="n">throughput_summary</span><span class="p">[</span><span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># ë³´ê³ ì„œ ìƒì„±
</span>    <span class="n">report</span> <span class="o">=</span> <span class="n">monitor</span><span class="p">.</span><span class="nf">generate_throughput_report</span><span class="p">()</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Throughput Report ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Overall Throughput: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">overall_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Max Throughput: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">max_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Min Throughput: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">min_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># ê¶Œì¥ì‚¬í•­ ì¶œë ¥
</span>    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">]:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Recommendations ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">priority_icon</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ğŸ”´</span><span class="sh">"</span> <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span> <span class="k">else</span> <span class="sh">"</span><span class="s">ğŸŸ¡</span><span class="sh">"</span> <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span> <span class="k">else</span> <span class="sh">"</span><span class="s">ğŸŸ¢</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">priority_icon</span><span class="si">}</span><span class="s"> [</span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">   Details: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># ë©”íŠ¸ë¦­ ë‚´ë³´ë‚´ê¸°
</span>    <span class="n">monitor</span><span class="p">.</span><span class="nf">export_metrics_to_monitoring_system</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">monitor</span>
</code></pre></div></div>

<h2 id="í•™ìŠµ-ìš”ì•½">ğŸ“š í•™ìŠµ ìš”ì•½</h2>

<h3 id="ì´ë²ˆ-íŒŒíŠ¸ì—ì„œ-í•™ìŠµí•œ-ë‚´ìš©">ì´ë²ˆ íŒŒíŠ¸ì—ì„œ í•™ìŠµí•œ ë‚´ìš©</h3>

<ol>
  <li><strong>UDF (User Defined Function)</strong>
    <ul>
      <li>ê¸°ë³¸ UDF ì‘ì„±ê³¼ í™œìš©</li>
      <li>ë³µì¡í•œ UDF (JSON íŒŒì‹±, ML ëª¨ë¸ ì ìš©)</li>
      <li>UDF ìµœì í™” ê¸°ë²•</li>
    </ul>
  </li>
  <li><strong>ê³ ê¸‰ ì§‘ê³„ì™€ ìœˆë„ìš° í•¨ìˆ˜</strong>
    <ul>
      <li>ë‹¤ì–‘í•œ ìœˆë„ìš° í•¨ìˆ˜ í™œìš©</li>
      <li>í†µê³„ì  ì§‘ê³„ í•¨ìˆ˜</li>
      <li>RFM ë¶„ì„ ë“± ê³ ê¸‰ ë¶„ì„</li>
    </ul>
  </li>
  <li><strong>ì„±ëŠ¥ ìµœì í™”</strong>
    <ul>
      <li>íŒŒí‹°ì…”ë‹ ì „ëµ</li>
      <li>ë©”ëª¨ë¦¬ ìµœì í™” ì„¤ì •</li>
      <li>ìºì‹± ì „ëµ</li>
    </ul>
  </li>
  <li><strong>ì‹¤ë¬´ í”„ë¡œì íŠ¸</strong>
    <ul>
      <li>ì „ììƒê±°ë˜ ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œ</li>
      <li>ëª¨ë“ˆí™”ëœ ì½”ë“œ êµ¬ì¡°</li>
      <li>ì—ëŸ¬ ì²˜ë¦¬ì™€ ë¡œê¹…</li>
    </ul>
  </li>
  <li><strong>í”„ë¡œë•ì…˜ ë°°í¬</strong>
    <ul>
      <li>Docker ì»¨í…Œì´ë„ˆí™”</li>
      <li>Kubernetes Job ë°°í¬</li>
      <li>Airflow ìŠ¤ì¼€ì¤„ë§</li>
    </ul>
  </li>
  <li><strong>ë°°ì¹˜ ì²˜ë¦¬ ì²˜ë¦¬ëŸ‰ ìµœì í™”</strong>
    <ul>
      <li>ì²˜ë¦¬ëŸ‰ ë¶„ì„ ë„êµ¬</li>
      <li>ê³ ê¸‰ ì²˜ë¦¬ëŸ‰ ìµœì í™” ê¸°ë²•</li>
      <li>ì²˜ë¦¬ëŸ‰ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</li>
    </ul>
  </li>
</ol>

<h3 id="í•µì‹¬-ê¸°ìˆ -ìŠ¤íƒ">í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ</h3>

<table>
  <thead>
    <tr>
      <th>ê¸°ìˆ </th>
      <th>ìš©ë„</th>
      <th>ì¤‘ìš”ë„</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>UDF</strong></td>
      <td>ì»¤ìŠ¤í…€ ë°ì´í„° ë³€í™˜</td>
      <td>â­â­â­â­â­</td>
    </tr>
    <tr>
      <td><strong>ìœˆë„ìš° í•¨ìˆ˜</strong></td>
      <td>ê³ ê¸‰ ë¶„ì„</td>
      <td>â­â­â­â­â­</td>
    </tr>
    <tr>
      <td><strong>Docker</strong></td>
      <td>ì»¨í…Œì´ë„ˆí™”</td>
      <td>â­â­â­â­</td>
    </tr>
    <tr>
      <td><strong>Kubernetes</strong></td>
      <td>ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜</td>
      <td>â­â­â­â­</td>
    </tr>
    <tr>
      <td><strong>Airflow</strong></td>
      <td>ì›Œí¬í”Œë¡œìš° ê´€ë¦¬</td>
      <td>â­â­â­â­</td>
    </tr>
  </tbody>
</table>

<h3 id="ë‹¤ìŒ-íŒŒíŠ¸-ë¯¸ë¦¬ë³´ê¸°">ë‹¤ìŒ íŒŒíŠ¸ ë¯¸ë¦¬ë³´ê¸°</h3>

<p><strong>Part 3: ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬</strong>ì—ì„œëŠ” ë‹¤ìŒ ë‚´ìš©ì„ ë‹¤ë£¹ë‹ˆë‹¤:</p>
<ul>
  <li>Spark Streamingê³¼ Structured Streaming</li>
  <li>Kafka ì—°ë™ê³¼ ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬</li>
  <li>ì›Œí„°ë§ˆí‚¹ê³¼ ì§€ì—° ë°ì´í„° ì²˜ë¦¬</li>
  <li>ì‹¤ì‹œê°„ ë¶„ì„ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•</li>
</ul>

<hr />

<p><strong>ë‹¤ìŒ íŒŒíŠ¸</strong>: <a href="/data-engineering/2025/09/13/apache-spark-streaming.html">Part 3: ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ì™€ Kafka ì—°ë™</a></p>

<hr />

<p><em>ì´ì œ ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ì²˜ë¦¬ì™€ í”„ë¡œë•ì…˜ ë°°í¬ê¹Œì§€ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤! ë‹¤ìŒ íŒŒíŠ¸ì—ì„œëŠ” ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ì˜ ì„¸ê³„ë¡œ ë“¤ì–´ê°€ê² ìŠµë‹ˆë‹¤.</em> ğŸš€</p>

  </div>

  
  <div class="post-navigation">
    <div class="nav-links">
      
      
      
        
      
        
          
          
      
      
        
        
        <a href="/data-engineering/2025/09/11/apache-spark-basics.html" class="nav-link prev">
          â† ì´ì „: Part 1: Apache Spark ê¸°ì´ˆì™€ í•µì‹¬ ê°œë… - RDDë¶€í„° DataFrameê¹Œì§€
        </a>
      
      
      
        
        
        <a href="/data-engineering/2025/09/12/apache-spark-streaming.html" class="nav-link next">
          ë‹¤ìŒ: Part 3: Apache Spark ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ì™€ Kafka ì—°ë™ - ì‹¤ë¬´ í”„ë¡œì íŠ¸ â†’
        </a>
      
    </div>
    
    <div class="series-overview">
      <a href="/categories/data-engineering/" class="btn btn-secondary">
        ğŸ“š ì‹œë¦¬ì¦ˆ ì „ì²´ ë³´ê¸°
      </a>
    </div>
  </div>
  
</article>

    </div>
  </main>
  
  
  <footer class="site-footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h3>Data Droid Blog</h3>
        <p>ë°ì´í„° ì—”ì§€ë‹ˆì–´ê°€ ë‹¤ë£¨ëŠ” ê¸°ìˆ  ë¸”ë¡œê·¸</p>
      </div>
      
      <div class="footer-section">
        <h4>ì¹´í…Œê³ ë¦¬</h4>
        <ul>
          <li><a href="/categories/data-engineering/">ë°ì´í„° ì—”ì§€ë‹ˆì–´ë§</a></li>
          <li><a href="/categories/bi-engineering/">BI ì—”ì§€ë‹ˆì–´ë§</a></li>
          <li><a href="/categories/infrastructure-tools/">ì¸í”„ë¼ & ë„êµ¬</a></li>
          <li><a href="/categories/data-quality/">ë°ì´í„° í’ˆì§ˆ</a></li>
          <li><a href="/categories/data-ai/">Data AI</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>ë§í¬</h4>
        <ul>
          <li><a href="/">í™ˆ</a></li>
          <li><a href="/blog/">ë¸”ë¡œê·¸</a></li>
          <li><a href="/about/">ì†Œê°œ</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>ì†Œì…œ</h4>
        <ul>
          
          <li><a href="https://github.com/data-droid">GitHub</a></li>
          
          <li><a href="https://www.linkedin.com/in/jaekyung-lee-a61ab2193/">LinkedIn</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 Data Droid Blog. ëª¨ë“  ê¶Œë¦¬ ë³´ìœ </p>
    </div>
  </div>
</footer>



  
  <script src="/assets/js/main.js"></script>
</body>
</html>
