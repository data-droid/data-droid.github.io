<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="/assets/css/style.css">
  <!-- Head includes for Jekyll -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SEO -->

<meta name="description" content="Apache Spark의 고급 배치 처리 기법, UDF 작성, 그리고 Docker와 Kubernetes를 활용한 프로덕션 환경 구축까지 다룹니다.">



<title>Part 2: Apache Spark 대용량 배치 처리와 UDF 활용 - 실무 프로젝트 - Data Droid Blog</title>


<!-- Open Graph -->
<meta property="og:title" content="Part 2: Apache Spark 대용량 배치 처리와 UDF 활용 - 실무 프로젝트">
<meta property="og:description" content="Apache Spark의 고급 배치 처리 기법, UDF 작성, 그리고 Docker와 Kubernetes를 활용한 프로덕션 환경 구축까지 다룹니다.">
<meta property="og:url" content="http://localhost:4000/data-engineering/2025/09/12/apache-spark-batch-processing.html">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Part 2: Apache Spark 대용량 배치 처리와 UDF 활용 - 실무 프로젝트">
<meta name="twitter:description" content="Apache Spark의 고급 배치 처리 기법, UDF 작성, 그리고 Docker와 Kubernetes를 활용한 프로덕션 환경 구축까지 다룹니다.">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Data Droid Blog" href="/feed.xml">

<!-- Google Analytics -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GP9LT745PP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GP9LT745PP');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <div class="site-title">
      <a href="/">Data Droid Blog</a>
    </div>
    
    <!-- Mobile menu toggle button -->
    <button class="mobile-menu-toggle" aria-label="메뉴 열기/닫기">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    
    <nav class="site-nav">
      <ul class="nav-list">
        <li><a href="/">홈</a></li>
                  <li class="dropdown">
            <a href="#" class="dropdown-toggle">카테고리</a>
            <ul class="dropdown-menu">

              <li><a href="/categories/data-engineering/">데이터 엔지니어링</a></li>
              <li><a href="/categories/bi-engineering/">BI 엔지니어링</a></li>
              <li><a href="/categories/infrastructure-tools/">인프라 & 도구</a></li>
              <li><a href="/categories/data-quality/">데이터 품질</a></li>
              <li><a href="/categories/data-ai/">Data AI</a></li>
            </ul>
          </li>
        <li><a href="/blog/">블로그</a></li>
        <li><a href="/about/">소개</a></li>
      </ul>
    </nav>
    
    <div class="language-switcher">
      
        <!-- 포스트용 언어 전환 -->
        
          <a href="/data-engineering/2025/09/12/apache-spark-batch-processing.html" class="lang-btn active">한국어</a>
          
          <a href="/en_posts/2025-09-12-apache-spark-batch-processing.html" class="lang-btn">English</a>
        
      
    </div>
  </div>
</header>

  
  <main class="site-main">
    <div class="container">
      <article class="post">
  <header class="post-header">
    <div class="post-meta">
      <span class="post-category">Data engineering</span>
      <span class="post-date">2025년 09월 12일</span>
      <span class="post-author">Data Droid</span>
    </div>
    
    <h1 class="post-title">Part 2: Apache Spark 대용량 배치 처리와 UDF 활용 - 실무 프로젝트</h1>
    
    
    <div class="post-tags">
      
        <span class="tag">Apache-Spark</span>
      
        <span class="tag">UDF</span>
      
        <span class="tag">배치처리</span>
      
        <span class="tag">Docker</span>
      
        <span class="tag">Kubernetes</span>
      
        <span class="tag">Airflow</span>
      
        <span class="tag">성능최적화</span>
      
        <span class="tag">Python</span>
      
    </div>
    
    
    
    <div class="post-series">
      <span class="series-badge">📚 Apache spark complete guide 시리즈</span>
      <span class="series-order">Part 3</span>
    </div>
    
    
    
    <div class="post-info">
      
        <span class="reading-time">⏱️ 45분</span>
      
      
        <span class="difficulty">📊 고급</span>
      
    </div>
    
  </header>

  <div class="post-content">
    <h1 id="part-2-apache-spark-대용량-배치-처리와-udf-활용---실무-프로젝트">Part 2: Apache Spark 대용량 배치 처리와 UDF 활용 - 실무 프로젝트</h1>

<blockquote>
  <p>Apache Spark의 고급 배치 처리 기법, UDF 작성, 그리고 Docker와 Kubernetes를 활용한 프로덕션 환경 구축까지 다룹니다.</p>
</blockquote>

<h2 id="목차">📋 목차</h2>

<ol>
  <li><a href="#udf-user-defined-function-완전-정리">UDF (User Defined Function) 완전 정리</a></li>
  <li><a href="#고급-집계와-윈도우-함수">고급 집계와 윈도우 함수</a></li>
  <li><a href="#파티셔닝-전략과-성능-최적화">파티셔닝 전략과 성능 최적화</a></li>
  <li><a href="#실무-프로젝트-전자상거래-데이터-분석">실무 프로젝트: 전자상거래 데이터 분석</a></li>
  <li><a href="#docker와-kubernetes-배포">Docker와 Kubernetes 배포</a></li>
  <li><a href="#airflow-스케줄링">Airflow 스케줄링</a></li>
  <li><a href="#학습-요약">학습 요약</a></li>
</ol>

<h2 id="udf-user-defined-function-완전-정리">🔧 UDF (User Defined Function) 완전 정리</h2>

<h3 id="udf란">UDF란?</h3>

<p>UDF는 Spark에서 제공하지 않는 커스텀 함수를 작성하여 데이터 변환에 사용하는 방법입니다.</p>

<h3 id="udf-작성-방법">UDF 작성 방법</h3>

<h4 id="1-기본-udf-작성"><strong>1. 기본 UDF 작성</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">BooleanType</span>

<span class="c1"># 간단한 문자열 처리 UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">  </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 수학 계산 UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount_rate</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">discount_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">discount_rate</span><span class="p">))</span>

<span class="c1"># 조건부 처리 UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">categorize_price</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Unknown</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Low</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Medium</span><span class="sh">"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">High</span><span class="sh">"</span>

<span class="c1"># 사용 예제
</span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">  Product A  </span><span class="sh">"</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">Product B</span><span class="sh">"</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mf">600.0</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount_rate</span><span class="sh">"</span><span class="p">])</span>

<span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">clean_name</span><span class="sh">"</span><span class="p">,</span> <span class="nf">clean_text</span><span class="p">(</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">final_price</span><span class="sh">"</span><span class="p">,</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount_rate</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">price_category</span><span class="sh">"</span><span class="p">,</span> <span class="nf">categorize_price</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="2-복잡한-udf---json-파싱"><strong>2. 복잡한 UDF - JSON 파싱</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">MapType</span><span class="p">,</span> <span class="n">StringType</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">MapType</span><span class="p">(</span><span class="nc">StringType</span><span class="p">(),</span> <span class="nc">StringType</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">parse_json_metadata</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_str</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="c1"># 문자열로 변환하여 반환
</span>        <span class="k">return</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nf">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="c1"># 사용 예제
</span><span class="n">json_data</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">electronics</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Samsung</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">rating</span><span class="sh">"</span><span class="s">: 4.5}</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">clothing</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Nike</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">rating</span><span class="sh">"</span><span class="s">: 4.2}</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">invalid json</span><span class="sh">'</span><span class="p">)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">])</span>

<span class="n">json_data</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">parsed_metadata</span><span class="sh">"</span><span class="p">,</span> <span class="nf">parse_json_metadata</span><span class="p">(</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="3-고급-udf---머신러닝-모델-적용"><strong>3. 고급 UDF - 머신러닝 모델 적용</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">FloatType</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">IsolationForest</span>

<span class="c1"># 전역 모델 변수
</span><span class="n">model</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">initialize_model</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="c1"># 간단한 이상 탐지 모델 초기화
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">IsolationForest</span><span class="p">(</span><span class="n">contamination</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="c1"># 더미 데이터로 훈련
</span>    <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)</span>

<span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">anomaly_score</span><span class="p">(</span><span class="n">features_array</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nf">initialize_model</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">features_array</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">features_array</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">features_array</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">decision_function</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

<span class="c1"># 사용 예제
</span><span class="n">features_data</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">([</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">],),</span>
    <span class="p">([</span><span class="mf">10.5</span><span class="p">,</span> <span class="mf">15.2</span><span class="p">,</span> <span class="mf">8.9</span><span class="p">],),</span>
    <span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">features</span><span class="sh">"</span><span class="p">])</span>

<span class="n">features_data</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">anomaly_score</span><span class="sh">"</span><span class="p">,</span> <span class="nf">anomaly_score</span><span class="p">(</span><span class="sh">"</span><span class="s">features</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="udf-최적화-팁">UDF 최적화 팁</h3>

<h4 id="1-vectorized-udf-사용"><strong>1. Vectorized UDF 사용</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">pandas_udf</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">FloatType</span>

<span class="c1"># Pandas UDF는 더 빠른 성능을 제공
</span><span class="nd">@pandas_udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">fast_calculation</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="c1"># 벡터화된 연산으로 성능 향상
</span>    <span class="k">return</span> <span class="n">series</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># 사용
</span><span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">fast_result</span><span class="sh">"</span><span class="p">,</span> <span class="nf">fast_calculation</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="2-udf-캐싱과-재사용"><strong>2. UDF 캐싱과 재사용</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># UDF를 함수로 정의하여 재사용
</span><span class="k">def</span> <span class="nf">create_text_processor</span><span class="p">():</span>
    <span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">process_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">process_text</span>

<span class="c1"># 여러 DataFrame에서 재사용
</span><span class="n">text_processor</span> <span class="o">=</span> <span class="nf">create_text_processor</span><span class="p">()</span>
<span class="n">df1</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">processed</span><span class="sh">"</span><span class="p">,</span> <span class="nf">text_processor</span><span class="p">(</span><span class="sh">"</span><span class="s">text1</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
<span class="n">df2</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">processed</span><span class="sh">"</span><span class="p">,</span> <span class="nf">text_processor</span><span class="p">(</span><span class="sh">"</span><span class="s">text2</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="고급-집계와-윈도우-함수">📊 고급 집계와 윈도우 함수</h2>

<h3 id="고급-윈도우-함수">고급 윈도우 함수</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">row_number</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">lead</span><span class="p">,</span> 
    <span class="n">first_value</span><span class="p">,</span> <span class="n">last_value</span><span class="p">,</span> <span class="n">nth_value</span><span class="p">,</span>
    <span class="n">cume_dist</span><span class="p">,</span> <span class="n">percent_rank</span><span class="p">,</span> <span class="n">ntile</span>
<span class="p">)</span>

<span class="c1"># 복잡한 윈도우 스펙 정의
</span><span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 다양한 윈도우 함수 적용
</span><span class="n">df_advanced</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">row_num</span><span class="sh">"</span><span class="p">,</span> <span class="nf">row_number</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">dense_rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">dense_rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">lag</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">next_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">lead</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">first_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">first_value</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">last_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">last_value</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">cumulative_dist</span><span class="sh">"</span><span class="p">,</span> <span class="nf">cume_dist</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">percentile_rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">percent_rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">quartile</span><span class="sh">"</span><span class="p">,</span> <span class="nf">ntile</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="고급-집계-함수">고급 집계 함수</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">collect_list</span><span class="p">,</span> <span class="n">collect_set</span><span class="p">,</span> <span class="n">array_agg</span><span class="p">,</span>
    <span class="n">stddev</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">skewness</span><span class="p">,</span> <span class="n">kurtosis</span><span class="p">,</span>
    <span class="n">corr</span><span class="p">,</span> <span class="n">covar_pop</span><span class="p">,</span> <span class="n">covar_samp</span>
<span class="p">)</span>

<span class="c1"># 통계적 집계
</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">stddev</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">stddev_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">variance</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">variance_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">skewness</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">skewness_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">kurtosis</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">kurtosis_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">collect_list</span><span class="p">(</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">all_products</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">collect_set</span><span class="p">(</span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_brands</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<h2 id="파티셔닝-전략과-성능-최적화">⚡ 파티셔닝 전략과 성능 최적화</h2>

<h3 id="파티셔닝-전략">파티셔닝 전략</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. 컬럼 기반 파티셔닝
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">year</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">month</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">path/to/partitioned_data</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2. 버킷팅
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">bucketBy</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">sortBy</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">saveAsTable</span><span class="p">(</span><span class="sh">"</span><span class="s">bucketed_table</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 3. 동적 파티셔닝
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">128MB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="성능-최적화-설정">성능 최적화 설정</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 메모리 최적화
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 캐싱 전략
</span><span class="n">df</span><span class="p">.</span><span class="nf">cache</span><span class="p">()</span>  <span class="c1"># 메모리 캐싱
</span><span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_AND_DISK</span><span class="p">)</span>  <span class="c1"># 메모리+디스크 캐싱
</span>
<span class="c1"># 브로드캐스트 조인
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.autoBroadcastJoinThreshold</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10MB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="-실무-프로젝트-전자상거래-데이터-분석">🛒 실무 프로젝트: 전자상거래 데이터 분석</h2>

<h3 id="프로젝트-구조">프로젝트 구조</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ecommerce-analysis/
├── src/
│   ├── data_processing.py
│   ├── analytics.py
│   └── utils.py
├── config/
│   ├── spark_config.py
│   └── app_config.yaml
├── tests/
│   └── test_data_processing.py
├── Dockerfile
├── requirements.txt
├── kubernetes/
│   ├── spark-job.yaml
│   └── airflow-dag.py
└── README.md
</code></pre></div></div>

<h3 id="1-데이터-처리-모듈">1. 데이터 처리 모듈</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/data_processing.py
</span><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="n">logging</span>

<span class="k">class</span> <span class="nc">EcommerceDataProcessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">데이터 로드</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Loading data from </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 다양한 데이터 소스 로드
</span>        <span class="n">orders_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/orders</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">products_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/products</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customers_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/customers</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span>
    
    <span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">데이터 정제</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Cleaning data...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 중복 제거
</span>        <span class="n">orders_clean</span> <span class="o">=</span> <span class="n">orders_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">order_id</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">products_clean</span> <span class="o">=</span> <span class="n">products_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">customers_clean</span> <span class="o">=</span> <span class="n">customers_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">])</span>
        
        <span class="c1"># NULL 값 처리
</span>        <span class="n">orders_clean</span> <span class="o">=</span> <span class="n">orders_clean</span><span class="p">.</span><span class="nf">fillna</span><span class="p">({</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">products_clean</span> <span class="o">=</span> <span class="n">products_clean</span><span class="p">.</span><span class="nf">fillna</span><span class="p">({</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Unknown</span><span class="sh">"</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span>
    
    <span class="k">def</span> <span class="nf">enrich_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">데이터 풍부화</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Enriching data...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 조인을 통한 데이터 풍부화
</span>        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">orders_df</span> \
            <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">products_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">customers_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 계산된 컬럼 추가
</span>        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">,</span> 
            <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">discount</span><span class="sh">"</span><span class="p">))</span>
        <span class="p">)</span>
        
        <span class="c1"># 고객 등급 계산 UDF
</span>        <span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">calculate_customer_tier</span><span class="p">(</span><span class="n">total_spent</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">VIP</span><span class="sh">"</span>
            <span class="k">elif</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Gold</span><span class="sh">"</span>
            <span class="k">elif</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Silver</span><span class="sh">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Bronze</span><span class="sh">"</span>
        
        <span class="c1"># 고객별 총 구매액 계산
</span>        <span class="n">customer_totals</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">customer_totals</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_tier</span><span class="sh">"</span><span class="p">,</span> <span class="nf">calculate_customer_tier</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">enriched_df</span>
</code></pre></div></div>

<h3 id="2-고급-분석-모듈">2. 고급 분석 모듈</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/analytics.py
</span><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="k">class</span> <span class="nc">EcommerceAnalytics</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">sales_analysis</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">매출 분석</span><span class="sh">"""</span>
        <span class="c1"># 일별 매출 트렌드
</span>        <span class="n">daily_sales</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">daily_revenue</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">daily_customers</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_order_value</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 제품별 매출 분석
</span>        <span class="n">product_sales</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_quantity</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_revenue</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_customers</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="sh">"</span><span class="s">total_revenue</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">daily_sales</span><span class="p">,</span> <span class="n">product_sales</span>
    
    <span class="k">def</span> <span class="nf">customer_analysis</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">고객 분석</span><span class="sh">"""</span>
        <span class="c1"># 고객별 구매 패턴
</span>        <span class="n">customer_patterns</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_tier</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_orders</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_order_value</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">min</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">first_purchase</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">last_purchase</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># RFM 분석 (Recency, Frequency, Monetary)
</span>        <span class="n">rfm_analysis</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">datediff</span><span class="p">(</span><span class="nf">current_date</span><span class="p">(),</span> <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">recency</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">frequency</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">monetary</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">customer_patterns</span><span class="p">,</span> <span class="n">rfm_analysis</span>
    
    <span class="k">def</span> <span class="nf">advanced_analytics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">고급 분석</span><span class="sh">"""</span>
        <span class="c1"># 코호트 분석
</span>        <span class="n">cohort_analysis</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_month</span><span class="sh">"</span><span class="p">,</span> <span class="nf">date_format</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yyyy-MM</span><span class="sh">"</span><span class="p">))</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_month</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span><span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_size</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="c1"># 상품 추천을 위한 협업 필터링 기초
</span>        <span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="n">customer_product_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">row_number</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
            <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 최근 10개 구매 상품
</span>        
        <span class="k">return</span> <span class="n">cohort_analysis</span><span class="p">,</span> <span class="n">customer_product_matrix</span>
</code></pre></div></div>

<h3 id="3-설정-파일">3. 설정 파일</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/spark_config.py
</span><span class="k">def</span> <span class="nf">get_spark_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">spark.app.name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">EcommerceAnalysis</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.master</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local[*]</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">128MB</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.serializer</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">org.apache.spark.serializer.KryoSerializer</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.execution.arrow.pyspark.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionFactor</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">5</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">256MB</span><span class="sh">"</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/app_config.yaml</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">input_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/input"</span>
  <span class="na">output_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/output"</span>
  <span class="na">checkpoint_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/checkpoint"</span>

<span class="na">processing</span><span class="pi">:</span>
  <span class="na">batch_size</span><span class="pi">:</span> <span class="m">10000</span>
  <span class="na">parallelism</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">cache_enabled</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">output</span><span class="pi">:</span>
  <span class="na">format</span><span class="pi">:</span> <span class="s2">"</span><span class="s">parquet"</span>
  <span class="na">compression</span><span class="pi">:</span> <span class="s2">"</span><span class="s">snappy"</span>
  <span class="na">partition_by</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">year"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">month"</span><span class="pi">]</span>
</code></pre></div></div>

<h2 id="-docker와-kubernetes-배포">🐳 Docker와 Kubernetes 배포</h2>

<h3 id="1-dockerfile">1. Dockerfile</h3>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="s"> openjdk:8-jdk-alpine</span>

<span class="c"># Python 설치</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> python3 py3-pip

<span class="c"># Spark 설치</span>
<span class="k">ENV</span><span class="s"> SPARK_VERSION=3.4.0</span>
<span class="k">ENV</span><span class="s"> HADOOP_VERSION=3</span>
<span class="k">ENV</span><span class="s"> SPARK_HOME=/opt/spark</span>
<span class="k">ENV</span><span class="s"> PATH=$PATH:$SPARK_HOME/bin</span>

<span class="k">RUN </span>wget <span class="nt">-q</span> https://archive.apache.org/dist/spark/spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span>/spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">tar </span>xzf spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">mv </span>spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span> <span class="k">${</span><span class="nv">SPARK_HOME</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">rm </span>spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz

<span class="c"># Python 의존성 설치</span>
<span class="k">COPY</span><span class="s"> requirements.txt /app/</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># 애플리케이션 코드 복사</span>
<span class="k">COPY</span><span class="s"> src/ /app/src/</span>
<span class="k">COPY</span><span class="s"> config/ /app/config/</span>

<span class="c"># 실행 권한 부여</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /app/src/main.py

<span class="c"># 포트 노출</span>
<span class="k">EXPOSE</span><span class="s"> 4040 8080</span>

<span class="c"># 실행 명령</span>
<span class="k">CMD</span><span class="s"> ["python3", "/app/src/main.py"]</span>
</code></pre></div></div>

<h3 id="2-kubernetes-job-설정">2. Kubernetes Job 설정</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubernetes/spark-job.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ecommerce-analysis-job</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spark-driver</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">ecommerce-analysis:latest</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">python3"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/app/src/main.py"</span><span class="pi">]</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_MASTER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">k8s://https://kubernetes.default.svc.cluster.local:443"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_APP_NAME</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ecommerce-analysis"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_DRIVER_HOST</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.podIP</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_DRIVER_PORT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">7077"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_UI_PORT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">4040"</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">4Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/data</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app/config</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data-volume</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">data-pvc</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">app-config</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
  <span class="na">backoffLimit</span><span class="pi">:</span> <span class="m">3</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">data-pvc</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">100Gi</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">app-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">app_config.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">data:</span>
      <span class="s">input_path: "/data/input"</span>
      <span class="s">output_path: "/data/output"</span>
    <span class="s">processing:</span>
      <span class="s">batch_size: 10000</span>
      <span class="s">parallelism: 4</span>
</code></pre></div></div>

<h3 id="3-spark-application-실행">3. Spark Application 실행</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">data_processing</span> <span class="kn">import</span> <span class="n">EcommerceDataProcessor</span>
<span class="kn">from</span> <span class="n">analytics</span> <span class="kn">import</span> <span class="n">EcommerceAnalytics</span>
<span class="kn">from</span> <span class="n">config.spark_config</span> <span class="kn">import</span> <span class="n">get_spark_config</span>

<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%(asctime)s - %(name)s - %(levelname)s - %(message)s</span><span class="sh">'</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nf">setup_logging</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Spark 세션 생성
</span>        <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
            <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="nf">get_spark_config</span><span class="p">())</span> \
            <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Spark session created successfully</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 데이터 처리기 초기화
</span>        <span class="n">processor</span> <span class="o">=</span> <span class="nc">EcommerceDataProcessor</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">analytics</span> <span class="o">=</span> <span class="nc">EcommerceAnalytics</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        
        <span class="c1"># 데이터 경로 설정
</span>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">INPUT_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/data/input</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OUTPUT_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/data/output</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 데이터 로드 및 처리
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">load_data</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Cleaning data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">clean_data</span><span class="p">(</span>
            <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span>
        <span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Enriching data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">enrich_data</span><span class="p">(</span>
            <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span>
        <span class="p">)</span>
        
        <span class="c1"># 분석 수행
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing sales analysis...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">daily_sales</span><span class="p">,</span> <span class="n">product_sales</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">sales_analysis</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing customer analysis...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customer_patterns</span><span class="p">,</span> <span class="n">rfm_analysis</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">customer_analysis</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing advanced analytics...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">cohort_analysis</span><span class="p">,</span> <span class="n">customer_product_matrix</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">advanced_analytics</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="c1"># 결과 저장
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Saving results...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">enriched_df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/enriched_data</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">daily_sales</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/daily_sales</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">product_sales</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/product_sales</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customer_patterns</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/customer_patterns</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rfm_analysis</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/rfm_analysis</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Job completed successfully!</span><span class="sh">"</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Job failed with error: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">spark</span><span class="sh">'</span> <span class="ow">in</span> <span class="nf">locals</span><span class="p">():</span>
            <span class="n">spark</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="airflow-스케줄링">🔄 Airflow 스케줄링</h2>

<h3 id="airflow-dag">Airflow DAG</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubernetes/airflow-dag.py
</span><span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="n">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="n">airflow.kubernetes</span> <span class="kn">import</span> <span class="n">KubernetesPodOperator</span>
<span class="kn">from</span> <span class="n">airflow.operators.dummy</span> <span class="kn">import</span> <span class="n">DummyOperator</span>
<span class="kn">from</span> <span class="n">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>

<span class="c1"># 기본 인수
</span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">owner</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-engineering</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">depends_on_past</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="nf">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">email_on_failure</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">email_on_retry</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">retries</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">retry_delay</span><span class="sh">'</span><span class="p">:</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># DAG 정의
</span><span class="n">dag</span> <span class="o">=</span> <span class="nc">DAG</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">ecommerce_analysis_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">전자상거래 데이터 분석 파이프라인</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="sh">'</span><span class="s">0 2 * * *</span><span class="sh">'</span><span class="p">,</span>  <span class="c1"># 매일 오전 2시 실행
</span>    <span class="n">catchup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">ecommerce</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">spark</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">analytics</span><span class="sh">'</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># 시작 작업
</span><span class="n">start_task</span> <span class="o">=</span> <span class="nc">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">start_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 데이터 검증 작업
</span><span class="k">def</span> <span class="nf">validate_input_data</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">os</span>
    <span class="n">input_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/input</span><span class="sh">"</span>
    <span class="n">required_files</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">orders</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">products</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">customers</span><span class="sh">"</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">required_files</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Required file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Input data validation completed successfully</span><span class="sh">"</span><span class="p">)</span>

<span class="n">validate_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">validate_input_data</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">validate_input_data</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Spark 분석 작업
</span><span class="n">spark_analysis_task</span> <span class="o">=</span> <span class="nc">KubernetesPodOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">spark_ecommerce_analysis</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="sh">'</span><span class="s">data-engineering</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="sh">'</span><span class="s">ecommerce-analysis:latest</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">spark-analysis-pod</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">cmds</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">python3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">/app/src/main.py</span><span class="sh">'</span><span class="p">],</span>
    <span class="n">env_vars</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">INPUT_PATH</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data/input</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">OUTPUT_PATH</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data/output</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">SPARK_MASTER</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">k8s://https://kubernetes.default.svc.cluster.local:443</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">SPARK_APP_NAME</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ecommerce-analysis</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">request_memory</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2Gi</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">request_cpu</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">limit_memory</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">4Gi</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">limit_cpu</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">volumes</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-volume</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">persistentVolumeClaim</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">claimName</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-pvc</span><span class="sh">'</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="n">volume_mounts</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-volume</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">mountPath</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data</span><span class="sh">'</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="n">get_logs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">is_delete_operator_pod</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 결과 검증 작업
</span><span class="k">def</span> <span class="nf">validate_output_data</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">os</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/output</span><span class="sh">"</span>
    <span class="n">required_outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">enriched_data</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">daily_sales</span><span class="sh">"</span><span class="p">,</span> 
        <span class="sh">"</span><span class="s">product_sales</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">customer_patterns</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">rfm_analysis</span><span class="sh">"</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">required_outputs</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Output directory not found: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 파일이 있는지 확인
</span>        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Output directory is empty: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Output data validation completed successfully</span><span class="sh">"</span><span class="p">)</span>

<span class="n">validate_output_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">validate_output_data</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">validate_output_data</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 알림 작업
</span><span class="k">def</span> <span class="nf">send_completion_notification</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Ecommerce analysis pipeline completed successfully!</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># 실제 환경에서는 Slack, Email 등으로 알림 전송
</span>    <span class="c1"># slack_webhook_url = os.getenv('SLACK_WEBHOOK_URL')
</span>    <span class="c1"># send_slack_notification(slack_webhook_url, "Pipeline completed successfully")
</span>
<span class="n">notification_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">send_completion_notification</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">send_completion_notification</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 종료 작업
</span><span class="n">end_task</span> <span class="o">=</span> <span class="nc">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">end_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 작업 의존성 정의
</span><span class="n">start_task</span> <span class="o">&gt;&gt;</span> <span class="n">validate_task</span> <span class="o">&gt;&gt;</span> <span class="n">spark_analysis_task</span> <span class="o">&gt;&gt;</span> <span class="n">validate_output_task</span> <span class="o">&gt;&gt;</span> <span class="n">notification_task</span> <span class="o">&gt;&gt;</span> <span class="n">end_task</span>
</code></pre></div></div>

<h3 id="배포-스크립트">배포 스크립트</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># deploy.sh</span>

<span class="nb">echo</span> <span class="s2">"Building Docker image..."</span>
docker build <span class="nt">-t</span> ecommerce-analysis:latest <span class="nb">.</span>

<span class="nb">echo</span> <span class="s2">"Loading image to Kubernetes cluster..."</span>
kind load docker-image ecommerce-analysis:latest

<span class="nb">echo</span> <span class="s2">"Applying Kubernetes manifests..."</span>
kubectl apply <span class="nt">-f</span> kubernetes/spark-job.yaml

<span class="nb">echo</span> <span class="s2">"Deploying Airflow DAG..."</span>
kubectl <span class="nb">cp </span>kubernetes/airflow-dag.py airflow-web-0:/opt/airflow/dags/

<span class="nb">echo</span> <span class="s2">"Deployment completed!"</span>
</code></pre></div></div>

<h2 id="배치-처리-처리량-최적화">⚡ 배치 처리 처리량 최적화</h2>

<h3 id="처리량-분석-도구">처리량 분석 도구</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 배치 처리량 분석 및 최적화 도구
</span><span class="k">class</span> <span class="nc">BatchThroughputOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        
    <span class="k">def</span> <span class="nf">analyze_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">operation_name</span><span class="o">=</span><span class="sh">"</span><span class="s">batch_operation</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">처리량 분석</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span>
        
        <span class="c1"># 데이터 크기 측정
</span>        <span class="n">row_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        <span class="n">num_partitions</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span>
        
        <span class="c1"># 처리 시간 측정
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="c1"># 샘플 작업 실행 (실제 작업으로 대체)
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_count</span><span class="sh">"</span><span class="p">)).</span><span class="nf">collect</span><span class="p">()</span>
        
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">processing_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        
        <span class="c1"># 처리량 계산
</span>        <span class="n">throughput_records_per_second</span> <span class="o">=</span> <span class="n">row_count</span> <span class="o">/</span> <span class="n">processing_time</span> <span class="k">if</span> <span class="n">processing_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation_name</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">:</span> <span class="n">row_count</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">num_partitions</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_partitions</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">processing_time_seconds</span><span class="sh">'</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">throughput_records_per_second</span><span class="sh">'</span><span class="p">:</span> <span class="n">throughput_records_per_second</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">throughput_records_per_minute</span><span class="sh">'</span><span class="p">:</span> <span class="n">throughput_records_per_second</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">avg_records_per_partition</span><span class="sh">'</span><span class="p">:</span> <span class="n">row_count</span> <span class="o">/</span> <span class="n">num_partitions</span> <span class="k">if</span> <span class="n">num_partitions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">optimize_partitioning_for_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target_records_per_partition</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">처리량을 위한 파티셔닝 최적화</span><span class="sh">"""</span>
        <span class="n">current_partitions</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span>
        <span class="n">row_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        
        <span class="c1"># 최적 파티션 수 계산
</span>        <span class="n">optimal_partitions</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_count</span> <span class="o">//</span> <span class="n">target_records_per_partition</span><span class="p">)</span>
        
        <span class="c1"># 파티션 크기 기반 조정
</span>        <span class="k">if</span> <span class="n">optimal_partitions</span> <span class="o">&gt;</span> <span class="n">current_partitions</span><span class="p">:</span>
            <span class="c1"># 파티션 수 증가
</span>            <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="n">optimal_partitions</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">repartitioned from </span><span class="si">{</span><span class="n">current_partitions</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">optimal_partitions</span><span class="si">}</span><span class="s"> partitions</span><span class="sh">"</span>
        <span class="k">elif</span> <span class="n">optimal_partitions</span> <span class="o">&lt;</span> <span class="n">current_partitions</span><span class="p">:</span>
            <span class="c1"># 파티션 수 감소
</span>            <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">coalesce</span><span class="p">(</span><span class="n">optimal_partitions</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">coalesced from </span><span class="si">{</span><span class="n">current_partitions</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">optimal_partitions</span><span class="si">}</span><span class="s"> partitions</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">action</span> <span class="o">=</span> <span class="sh">"</span><span class="s">no partitioning change needed</span><span class="sh">"</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">optimized_dataframe</span><span class="sh">'</span><span class="p">:</span> <span class="n">optimized_df</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">original_partitions</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_partitions</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">optimized_partitions</span><span class="sh">'</span><span class="p">:</span> <span class="n">optimal_partitions</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">action_taken</span><span class="sh">'</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">target_records_per_partition</span><span class="sh">'</span><span class="p">:</span> <span class="n">target_records_per_partition</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">optimize_memory_for_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">처리량을 위한 메모리 최적화</span><span class="sh">"""</span>
        <span class="n">memory_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># 메모리 관련 설정
</span>            <span class="sh">'</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">128MB</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            
            <span class="c1"># 직렬화 최적화
</span>            <span class="sh">'</span><span class="s">spark.serializer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">org.apache.spark.serializer.KryoSerializer</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.pyspark.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.maxRecordsPerBatch</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">10000</span><span class="sh">'</span><span class="p">,</span>
            
            <span class="c1"># 캐싱 최적화
</span>            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.pyspark.fallback.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.localShuffleReader.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            
            <span class="c1"># 조인 최적화
</span>            <span class="sh">'</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionFactor</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">256MB</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">memory_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">spark_session</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">memory_configs</span>
    
    <span class="k">def</span> <span class="nf">implement_parallel_processing</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">parallelism_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">병렬 처리 구현</span><span class="sh">"""</span>
        <span class="n">current_partitions</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span>
        <span class="n">optimized_partitions</span> <span class="o">=</span> <span class="n">current_partitions</span> <span class="o">*</span> <span class="n">parallelism_factor</span>
        
        <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="n">optimized_partitions</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">optimize_data_loading</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">format_type</span><span class="o">=</span><span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">데이터 로딩 최적화</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Parquet 파일 최적화
</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="c1"># 파티션 프루닝 활성화
</span>            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.optimizer.metadataOnly</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.filterPushdown</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.mergeSchema</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">csv</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># CSV 파일 최적화
</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">).</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">inferSchema</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">).</span><span class="nf">csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="c1"># 병렬 로딩을 위한 파티셔닝
</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">df</span>

<span class="c1"># 처리량 최적화 예제
</span><span class="k">def</span> <span class="nf">batch_throughput_optimization_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">BatchThroughputOptimization</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="nc">BatchThroughputOptimizer</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># 샘플 데이터 생성
</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">product_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">10.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># 처리량 분석
</span>    <span class="n">throughput_analysis</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">analyze_throughput</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sh">"</span><span class="s">sample_analysis</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Batch Throughput Analysis ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Records: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Processing Time: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">processing_time_seconds</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Throughput: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">throughput_records_per_second</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Partitions: </span><span class="si">{</span><span class="n">throughput_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">num_partitions</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 파티셔닝 최적화
</span>    <span class="n">partitioning_result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_partitioning_for_throughput</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Partitioning Optimization: </span><span class="si">{</span><span class="n">partitioning_result</span><span class="p">[</span><span class="sh">'</span><span class="s">action_taken</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 메모리 최적화
</span>    <span class="n">memory_configs</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_memory_for_throughput</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Memory Optimization Configs ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">memory_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 병렬 처리 최적화
</span>    <span class="n">parallel_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">implement_parallel_processing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Parallel Processing: </span><span class="si">{</span><span class="n">parallel_df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span><span class="si">}</span><span class="s"> partitions</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimizer</span>
</code></pre></div></div>

<h3 id="고급-처리량-최적화-기법">고급 처리량 최적화 기법</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 고급 처리량 최적화 클래스
</span><span class="k">class</span> <span class="nc">AdvancedThroughputOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">implement_columnar_processing</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">컬럼형 처리 최적화</span><span class="sh">"""</span>
        <span class="c1"># Parquet 형식으로 저장하여 컬럼형 처리 활성화
</span>        <span class="n">temp_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/tmp/optimized_data</span><span class="sh">"</span>
        
        <span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
        
        <span class="c1"># 최적화된 설정으로 다시 읽기
</span>        <span class="n">optimized_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.filterPushdown</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.mergeSchema</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">false</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.enableVectorizedReader</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.parquet.columnarReaderBatchSize</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">4096</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">optimized_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">optimize_joins_for_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">join_key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">조인 최적화</span><span class="sh">"""</span>
        <span class="c1"># 브로드캐스트 조인 힌트 적용 (작은 테이블의 경우)
</span>        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">broadcast</span>
        
        <span class="c1"># 테이블 크기 비교
</span>        <span class="n">size1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        <span class="n">size2</span> <span class="o">=</span> <span class="n">df2</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">size1</span> <span class="o">&lt;</span> <span class="n">size2</span> <span class="ow">and</span> <span class="n">size1</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">:</span>  <span class="c1"># 10만 레코드 미만
</span>            <span class="n">optimized_df1</span> <span class="o">=</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
            <span class="n">optimized_df2</span> <span class="o">=</span> <span class="n">df2</span>
        <span class="k">elif</span> <span class="n">size2</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="n">optimized_df1</span> <span class="o">=</span> <span class="n">df1</span>
            <span class="n">optimized_df2</span> <span class="o">=</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimized_df1</span> <span class="o">=</span> <span class="n">df1</span>
            <span class="n">optimized_df2</span> <span class="o">=</span> <span class="n">df2</span>
        
        <span class="c1"># 조인 실행
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">optimized_df1</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">optimized_df2</span><span class="p">,</span> <span class="n">join_key</span><span class="p">,</span> <span class="sh">"</span><span class="s">inner</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">implement_bucketing_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">bucket_columns</span><span class="p">,</span> <span class="n">num_buckets</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">버킷팅 전략 구현</span><span class="sh">"""</span>
        <span class="c1"># 버킷팅을 위한 임시 테이블 생성
</span>        <span class="n">temp_table_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">temp_bucketed_table</span><span class="sh">"</span>
        
        <span class="c1"># 버킷팅 설정
</span>        <span class="n">bucketing_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">spark.sql.sources.bucketing.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.sources.bucketing.autoBucketedScan.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">bucketing_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># 버킷팅된 테이블로 저장
</span>        <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
            <span class="p">.</span><span class="nf">bucketBy</span><span class="p">(</span><span class="n">num_buckets</span><span class="p">,</span> <span class="o">*</span><span class="n">bucket_columns</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">saveAsTable</span><span class="p">(</span><span class="n">temp_table_name</span><span class="p">)</span>
        
        <span class="c1"># 버킷팅된 테이블 읽기
</span>        <span class="n">bucketed_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="nf">table</span><span class="p">(</span><span class="n">temp_table_name</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">bucketed_df</span>
    
    <span class="k">def</span> <span class="nf">optimize_aggregations</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">group_columns</span><span class="p">,</span> <span class="n">agg_columns</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">집계 최적화</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="nb">sum</span> <span class="k">as</span> <span class="n">spark_sum</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">max</span> <span class="k">as</span> <span class="n">spark_max</span>
        
        <span class="c1"># 집계 전 파티셔닝 최적화
</span>        <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="o">*</span><span class="n">group_columns</span><span class="p">)</span>
        
        <span class="c1"># 집계 실행
</span>        <span class="n">aggregation_result</span> <span class="o">=</span> <span class="n">optimized_df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="o">*</span><span class="n">group_columns</span><span class="p">).</span><span class="nf">agg</span><span class="p">(</span>
            <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">record_count</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">spark_sum</span><span class="p">(</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">alias</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">total_</span><span class="si">{</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">avg</span><span class="p">(</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">alias</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">avg_</span><span class="si">{</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">spark_max</span><span class="p">(</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">alias</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">max_</span><span class="si">{</span><span class="n">agg_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">aggregation_result</span>
    
    <span class="k">def</span> <span class="nf">implement_caching_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">access_frequency</span><span class="o">=</span><span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">캐싱 전략 구현</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark</span> <span class="kn">import</span> <span class="n">StorageLevel</span>
        
        <span class="k">if</span> <span class="n">access_frequency</span> <span class="o">==</span> <span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># 자주 사용되는 데이터는 메모리에 캐싱
</span>            <span class="n">cached_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_ONLY</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">access_frequency</span> <span class="o">==</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># 중간 빈도는 메모리+디스크 캐싱
</span>            <span class="n">cached_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_AND_DISK_SER</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 낮은 빈도는 디스크 캐싱
</span>            <span class="n">cached_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">DISK_ONLY</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cached_df</span>
    
    <span class="k">def</span> <span class="nf">optimize_file_formats</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">format_type</span><span class="o">=</span><span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">파일 형식 최적화</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Parquet 최적화 설정
</span>            <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
                <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">snappy</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">parquet.block.size</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">134217728</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">parquet.page.size</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1048576</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># ORC 최적화 설정
</span>            <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
                <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">zlib</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.stripe.size</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">67108864</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">orc</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">delta</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># Delta Lake 최적화 설정
</span>            <span class="n">df</span><span class="p">.</span><span class="n">write</span> \
                <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">delta</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">delta.autoOptimize.optimizeWrite</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">delta.autoOptimize.autoCompact</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
                <span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Data saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s"> in </span><span class="si">{</span><span class="n">format_type</span><span class="si">}</span><span class="s"> format</span><span class="sh">"</span>

<span class="c1"># 고급 처리량 최적화 예제
</span><span class="k">def</span> <span class="nf">advanced_throughput_optimization_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">AdvancedThroughputOptimization</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="nc">AdvancedThroughputOptimizer</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># 샘플 데이터 생성
</span>    <span class="n">data1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">product_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">10.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">500000</span><span class="p">)]</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category_id</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="n">data2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">category_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">category_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category_name</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># 컬럼형 처리 최적화
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Implementing Columnar Processing ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">columnar_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">implement_columnar_processing</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Columnar processing implemented: </span><span class="si">{</span><span class="n">columnar_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">}</span><span class="s"> records</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 조인 최적화
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Optimizing Joins ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_joins_for_throughput</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="sh">"</span><span class="s">category_id</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Join optimization completed: </span><span class="si">{</span><span class="n">joined_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">}</span><span class="s"> records</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 집계 최적화
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Optimizing Aggregations ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">aggregated_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_aggregations</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">category_name</span><span class="sh">"</span><span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Aggregation optimization completed: </span><span class="si">{</span><span class="n">aggregated_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">}</span><span class="s"> groups</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 파일 형식 최적화
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Optimizing File Formats ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">output_result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_file_formats</span><span class="p">(</span><span class="n">aggregated_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">/tmp/optimized_output</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">parquet</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">output_result</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimizer</span>
</code></pre></div></div>

<h3 id="처리량-모니터링-시스템">처리량 모니터링 시스템</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 처리량 모니터링 시스템
</span><span class="k">class</span> <span class="nc">ThroughputMonitoringSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">monitor_batch_throughput</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">배치 처리량 모니터링</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">time</span>
        
        <span class="n">total_records</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_records</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
        
        <span class="n">batch_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nf">min</span><span class="p">((</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">total_records</span><span class="p">)</span>
            
            <span class="c1"># 배치 데이터 추출
</span>            <span class="n">batch_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">end_idx</span><span class="p">).</span><span class="nf">subtract</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">start_idx</span><span class="p">))</span>
            
            <span class="c1"># 배치 처리 시간 측정
</span>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">batch_count</span> <span class="o">=</span> <span class="n">batch_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            
            <span class="n">processing_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">throughput</span> <span class="o">=</span> <span class="n">batch_count</span> <span class="o">/</span> <span class="n">processing_time</span> <span class="k">if</span> <span class="n">processing_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="n">batch_metric</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation_name</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">batch_idx</span><span class="sh">'</span><span class="p">:</span> <span class="n">batch_idx</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">batch_size</span><span class="sh">'</span><span class="p">:</span> <span class="n">batch_count</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">processing_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">throughput_records_per_second</span><span class="sh">'</span><span class="p">:</span> <span class="n">throughput</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="p">}</span>
            
            <span class="n">batch_metrics</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">batch_metric</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Batch </span><span class="si">{</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">throughput</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 전체 통계 계산
</span>        <span class="n">total_time</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">processing_time</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="p">)</span>
        <span class="n">avg_throughput</span> <span class="o">=</span> <span class="n">total_records</span> <span class="o">/</span> <span class="n">total_time</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation_name</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_records</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_batches</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_batches</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">avg_throughput</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">batch_metrics</span><span class="sh">'</span><span class="p">:</span> <span class="n">batch_metrics</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary</span>
    
    <span class="k">def</span> <span class="nf">generate_throughput_report</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">처리량 보고서 생성</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">No metrics available</span><span class="sh">"</span><span class="p">}</span>
        
        <span class="c1"># 전체 통계 계산
</span>        <span class="n">total_operations</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">total_records</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">overall_throughput</span> <span class="o">=</span> <span class="n">total_records</span> <span class="o">/</span> <span class="n">total_time</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># 최고/최저 처리량 찾기
</span>        <span class="n">max_throughput</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        <span class="n">min_throughput</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">total_operations</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_operations</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">total_records_processed</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_records</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">overall_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">overall_throughput</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">max_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">max_throughput</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">min_throughput</span><span class="sh">'</span><span class="p">:</span> <span class="n">min_throughput</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">operation_details</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_generate_throughput_recommendations</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">report</span>
    
    <span class="k">def</span> <span class="nf">_generate_throughput_recommendations</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">처리량 개선 권장사항 생성</span><span class="sh">"""</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">recommendations</span>
        
        <span class="c1"># 평균 처리량 계산
</span>        <span class="n">avg_throughput</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">)</span>
        
        <span class="c1"># 처리량이 낮은 경우 권장사항
</span>        <span class="k">if</span> <span class="n">avg_throughput</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>  <span class="c1"># 10,000 records/sec 미만
</span>            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">partitioning</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">파티션 수를 증가시켜 병렬 처리를 향상시키세요</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">repartition() 또는 coalesce() 사용 고려</span><span class="sh">'</span>
            <span class="p">})</span>
            
            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">caching</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">자주 사용되는 데이터를 캐싱하세요</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">cache() 또는 persist() 사용</span><span class="sh">'</span>
            <span class="p">})</span>
        
        <span class="c1"># 처리량 변동이 큰 경우
</span>        <span class="n">throughputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">metrics_history</span><span class="p">]</span>
        <span class="n">throughput_variance</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">throughputs</span><span class="p">)</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="n">throughputs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">throughput_variance</span> <span class="o">&gt;</span> <span class="n">avg_throughput</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># 변동이 평균의 50% 이상
</span>            <span class="n">recommendations</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">stability</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">처리량 안정성을 위해 데이터 분포를 개선하세요</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">데이터 스큐 문제 확인 및 해결</span><span class="sh">'</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">recommendations</span>
    
    <span class="k">def</span> <span class="nf">export_metrics_to_monitoring_system</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">모니터링 시스템으로 메트릭 내보내기</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">requests</span>
        <span class="kn">import</span> <span class="n">json</span>
        
        <span class="c1"># Prometheus 형식으로 메트릭 변환
</span>        <span class="n">prometheus_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">operation_details</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">metric_name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">spark_batch_throughput</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">labels</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">operation</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation</span><span class="p">[</span><span class="sh">'</span><span class="s">operation_name</span><span class="sh">'</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">operation</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="n">prometheus_metrics</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        
        <span class="c1"># 실제 환경에서는 Prometheus Pushgateway로 전송
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Exported Metrics to Monitoring System ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">prometheus_metrics</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">metric_name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">labels</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 처리량 모니터링 예제
</span><span class="k">def</span> <span class="nf">throughput_monitoring_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">ThroughputMonitoring</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="nc">ThroughputMonitoringSystem</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># 샘플 데이터 생성
</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># 처리량 모니터링
</span>    <span class="n">throughput_summary</span> <span class="o">=</span> <span class="n">monitor</span><span class="p">.</span><span class="nf">monitor_batch_throughput</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sh">"</span><span class="s">sample_processing</span><span class="sh">"</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Throughput Summary ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Records: </span><span class="si">{</span><span class="n">throughput_summary</span><span class="p">[</span><span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average Throughput: </span><span class="si">{</span><span class="n">throughput_summary</span><span class="p">[</span><span class="sh">'</span><span class="s">average_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Processing Time: </span><span class="si">{</span><span class="n">throughput_summary</span><span class="p">[</span><span class="sh">'</span><span class="s">total_processing_time</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 보고서 생성
</span>    <span class="n">report</span> <span class="o">=</span> <span class="n">monitor</span><span class="p">.</span><span class="nf">generate_throughput_report</span><span class="p">()</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Throughput Report ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Overall Throughput: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">overall_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Max Throughput: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">max_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Min Throughput: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">min_throughput</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> records/sec</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 권장사항 출력
</span>    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">]:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Recommendations ===</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="sh">'</span><span class="s">recommendations</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">priority_icon</span> <span class="o">=</span> <span class="sh">"</span><span class="s">🔴</span><span class="sh">"</span> <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span> <span class="k">else</span> <span class="sh">"</span><span class="s">🟡</span><span class="sh">"</span> <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span> <span class="k">else</span> <span class="sh">"</span><span class="s">🟢</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">priority_icon</span><span class="si">}</span><span class="s"> [</span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">priority</span><span class="sh">'</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">   Details: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="sh">'</span><span class="s">details</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 메트릭 내보내기
</span>    <span class="n">monitor</span><span class="p">.</span><span class="nf">export_metrics_to_monitoring_system</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">monitor</span>
</code></pre></div></div>

<h2 id="학습-요약">📚 학습 요약</h2>

<h3 id="이번-파트에서-학습한-내용">이번 파트에서 학습한 내용</h3>

<ol>
  <li><strong>UDF (User Defined Function)</strong>
    <ul>
      <li>기본 UDF 작성과 활용</li>
      <li>복잡한 UDF (JSON 파싱, ML 모델 적용)</li>
      <li>UDF 최적화 기법</li>
    </ul>
  </li>
  <li><strong>고급 집계와 윈도우 함수</strong>
    <ul>
      <li>다양한 윈도우 함수 활용</li>
      <li>통계적 집계 함수</li>
      <li>RFM 분석 등 고급 분석</li>
    </ul>
  </li>
  <li><strong>성능 최적화</strong>
    <ul>
      <li>파티셔닝 전략</li>
      <li>메모리 최적화 설정</li>
      <li>캐싱 전략</li>
    </ul>
  </li>
  <li><strong>실무 프로젝트</strong>
    <ul>
      <li>전자상거래 데이터 분석 시스템</li>
      <li>모듈화된 코드 구조</li>
      <li>에러 처리와 로깅</li>
    </ul>
  </li>
  <li><strong>프로덕션 배포</strong>
    <ul>
      <li>Docker 컨테이너화</li>
      <li>Kubernetes Job 배포</li>
      <li>Airflow 스케줄링</li>
    </ul>
  </li>
  <li><strong>배치 처리 처리량 최적화</strong>
    <ul>
      <li>처리량 분석 도구</li>
      <li>고급 처리량 최적화 기법</li>
      <li>처리량 모니터링 시스템</li>
    </ul>
  </li>
</ol>

<h3 id="핵심-기술-스택">핵심 기술 스택</h3>

<table>
  <thead>
    <tr>
      <th>기술</th>
      <th>용도</th>
      <th>중요도</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>UDF</strong></td>
      <td>커스텀 데이터 변환</td>
      <td>⭐⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>윈도우 함수</strong></td>
      <td>고급 분석</td>
      <td>⭐⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>Docker</strong></td>
      <td>컨테이너화</td>
      <td>⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>Kubernetes</strong></td>
      <td>오케스트레이션</td>
      <td>⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>Airflow</strong></td>
      <td>워크플로우 관리</td>
      <td>⭐⭐⭐⭐</td>
    </tr>
  </tbody>
</table>

<h3 id="다음-파트-미리보기">다음 파트 미리보기</h3>

<p><strong>Part 3: 실시간 스트리밍 처리</strong>에서는 다음 내용을 다룹니다:</p>
<ul>
  <li>Spark Streaming과 Structured Streaming</li>
  <li>Kafka 연동과 실시간 데이터 처리</li>
  <li>워터마킹과 지연 데이터 처리</li>
  <li>실시간 분석 대시보드 구축</li>
</ul>

<hr />

<p><strong>다음 파트</strong>: <a href="/data-engineering/2025/09/13/apache-spark-streaming.html">Part 3: 실시간 스트리밍 처리와 Kafka 연동</a></p>

<hr />

<p><em>이제 대용량 배치 처리와 프로덕션 배포까지 마스터했습니다! 다음 파트에서는 실시간 스트리밍 처리의 세계로 들어가겠습니다.</em> 🚀</p>

  </div>

  
  <div class="post-navigation">
    <div class="nav-links">
      
      
      
        
      
        
          
          
      
      
        
        
        <a href="/data-engineering/2025/09/11/apache-spark-basics.html" class="nav-link prev">
          ← 이전: Part 1: Apache Spark 기초와 핵심 개념 - RDD부터 DataFrame까지
        </a>
      
      
      
        
        
        <a href="/data-engineering/2025/09/12/apache-spark-streaming.html" class="nav-link next">
          다음: Part 3: Apache Spark 실시간 스트리밍 처리와 Kafka 연동 - 실무 프로젝트 →
        </a>
      
    </div>
    
    <div class="series-overview">
      <a href="/categories/data-engineering/" class="btn btn-secondary">
        📚 시리즈 전체 보기
      </a>
    </div>
  </div>
  
</article>

    </div>
  </main>
  
  
  <footer class="site-footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h3>Data Droid Blog</h3>
        <p>데이터 엔지니어가 다루는 기술 블로그</p>
      </div>
      
      <div class="footer-section">
        <h4>카테고리</h4>
        <ul>
          <li><a href="/categories/data-engineering/">데이터 엔지니어링</a></li>
          <li><a href="/categories/bi-engineering/">BI 엔지니어링</a></li>
          <li><a href="/categories/infrastructure-tools/">인프라 & 도구</a></li>
          <li><a href="/categories/data-quality/">데이터 품질</a></li>
          <li><a href="/categories/data-ai/">Data AI</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>링크</h4>
        <ul>
          <li><a href="/">홈</a></li>
          <li><a href="/blog/">블로그</a></li>
          <li><a href="/about/">소개</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>소셜</h4>
        <ul>
          
          <li><a href="https://github.com/data-droid">GitHub</a></li>
          
          <li><a href="https://www.linkedin.com/in/jaekyung-lee-a61ab2193/">LinkedIn</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 Data Droid Blog. 모든 권리 보유</p>
    </div>
  </div>
</footer>



  
  <script src="/assets/js/main.js"></script>
</body>
</html>
