<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="/assets/css/style.css">
  <!-- Head includes for Jekyll -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SEO -->

<meta name="description" content="Apache Spark Streaming, Structured Streaming, Kafka 연동을 통한 실시간 데이터 처리와 분석 시스템을 구축합니다.">



<title>Part 3: Apache Spark 실시간 스트리밍 처리와 Kafka 연동 - 실무 프로젝트 - Data Droid Blog</title>


<!-- Open Graph -->
<meta property="og:title" content="Part 3: Apache Spark 실시간 스트리밍 처리와 Kafka 연동 - 실무 프로젝트">
<meta property="og:description" content="Apache Spark Streaming, Structured Streaming, Kafka 연동을 통한 실시간 데이터 처리와 분석 시스템을 구축합니다.">
<meta property="og:url" content="https://data-droid.github.io/data-engineering/2025/09/12/apache-spark-streaming.html">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Part 3: Apache Spark 실시간 스트리밍 처리와 Kafka 연동 - 실무 프로젝트">
<meta name="twitter:description" content="Apache Spark Streaming, Structured Streaming, Kafka 연동을 통한 실시간 데이터 처리와 분석 시스템을 구축합니다.">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Data Droid Blog" href="/feed.xml">

<!-- Google Analytics -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GP9LT745PP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GP9LT745PP');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <div class="site-title">
      <a href="/">Data Droid Blog</a>
    </div>
    
    <!-- Mobile menu toggle button -->
    <button class="mobile-menu-toggle" aria-label="메뉴 열기/닫기">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    
    <nav class="site-nav">
      <ul class="nav-list">
        <li><a href="/">홈</a></li>
                  <li class="dropdown">
            <a href="#" class="dropdown-toggle">카테고리</a>
            <ul class="dropdown-menu">

              <li><a href="/categories/data-engineering/">데이터 엔지니어링</a></li>
              <li><a href="/categories/bi-engineering/">BI 엔지니어링</a></li>
              <li><a href="/categories/infrastructure-tools/">인프라 & 도구</a></li>
              <li><a href="/categories/data-quality/">데이터 품질</a></li>
              <li><a href="/categories/data-ai/">Data AI</a></li>
            </ul>
          </li>
        <li><a href="/blog/">블로그</a></li>
        <li><a href="/about/">소개</a></li>
      </ul>
    </nav>
    
    <div class="language-switcher">
      
        <!-- 포스트용 언어 전환 -->
        
          <a href="/data-engineering/2025/09/12/apache-spark-streaming.html" class="lang-btn active">한국어</a>
          
          <a href="/en_posts/2025-09-12-apache-spark-streaming.html" class="lang-btn">English</a>
        
      
    </div>
  </div>
</header>

  
  <main class="site-main">
    <div class="container">
      <article class="post">
  <header class="post-header">
    <div class="post-meta">
      <span class="post-category">Data engineering</span>
      <span class="post-date">2025년 09월 12일</span>
      <span class="post-author">Data Droid</span>
    </div>
    
    <h1 class="post-title">Part 3: Apache Spark 실시간 스트리밍 처리와 Kafka 연동 - 실무 프로젝트</h1>
    
    
    <div class="post-tags">
      
        <span class="tag">Apache-Spark</span>
      
        <span class="tag">Spark-Streaming</span>
      
        <span class="tag">Kafka</span>
      
        <span class="tag">실시간처리</span>
      
        <span class="tag">스트리밍</span>
      
        <span class="tag">워터마킹</span>
      
        <span class="tag">Python</span>
      
    </div>
    
    
    
    <div class="post-series">
      <span class="series-badge">📚 Apache spark complete guide 시리즈</span>
      <span class="series-order">Part 4</span>
    </div>
    
    
    
    <div class="post-info">
      
        <span class="reading-time">⏱️ 50분</span>
      
      
        <span class="difficulty">📊 고급</span>
      
    </div>
    
  </header>

  <div class="post-content">
    <h1 id="part-3-apache-spark-실시간-스트리밍-처리와-kafka-연동---실무-프로젝트">Part 3: Apache Spark 실시간 스트리밍 처리와 Kafka 연동 - 실무 프로젝트</h1>

<blockquote>
  <p>Apache Spark Streaming, Structured Streaming, Kafka 연동을 통한 실시간 데이터 처리와 분석 시스템을 구축합니다.</p>
</blockquote>

<h2 id="목차">📋 목차</h2>

<ol>
  <li><a href="#spark-streaming-기초">Spark Streaming 기초</a></li>
  <li><a href="#structured-streaming-완전-정리">Structured Streaming 완전 정리</a></li>
  <li><a href="#kafka-연동과-실시간-데이터-처리">Kafka 연동과 실시간 데이터 처리</a></li>
  <li><a href="#워터마킹과-지연-데이터-처리">워터마킹과 지연 데이터 처리</a></li>
  <li><a href="#실무-프로젝트-실시간-로그-분석-시스템">실무 프로젝트: 실시간 로그 분석 시스템</a></li>
  <li><a href="#실시간-대시보드-구축">실시간 대시보드 구축</a></li>
  <li><a href="#학습-요약">학습 요약</a></li>
</ol>

<h2 id="spark-streaming-기초">🔄 Spark Streaming 기초</h2>

<h3 id="spark-streaming이란">Spark Streaming이란?</h3>

<p>Spark Streaming은 Spark의 확장 모듈로, <strong>마이크로 배치(Micro-batch)</strong> 방식으로 실시간 데이터를 처리합니다.</p>

<h4 id="핵심-개념"><strong>핵심 개념</strong></h4>
<ul>
  <li><strong>DStream (Discretized Stream)</strong>: 연속적인 데이터 스트림을 작은 배치로 나눈 것</li>
  <li><strong>배치 간격 (Batch Interval)</strong>: 각 배치를 처리하는 시간 간격</li>
  <li><strong>체크포인트 (Checkpoint)</strong>: 장애 복구를 위한 상태 저장</li>
</ul>

<h3 id="dstream-기본-연산">DStream 기본 연산</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark</span> <span class="kn">import</span> <span class="n">SparkContext</span>
<span class="kn">from</span> <span class="n">pyspark.streaming</span> <span class="kn">import</span> <span class="n">StreamingContext</span>

<span class="c1"># StreamingContext 생성 (5초 배치 간격)
</span><span class="n">sc</span> <span class="o">=</span> <span class="nc">SparkContext</span><span class="p">(</span><span class="sh">"</span><span class="s">local[2]</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">StreamingExample</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ssc</span> <span class="o">=</span> <span class="nc">StreamingContext</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 5초 배치 간격
</span>
<span class="c1"># 텍스트 스트림 생성 (소켓 연결)
</span><span class="n">lines</span> <span class="o">=</span> <span class="n">ssc</span><span class="p">.</span><span class="nf">socketTextStream</span><span class="p">(</span><span class="sh">"</span><span class="s">localhost</span><span class="sh">"</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

<span class="c1"># 기본 변환 연산
</span><span class="n">words</span> <span class="o">=</span> <span class="n">lines</span><span class="p">.</span><span class="nf">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">))</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="n">words</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">word_counts</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">.</span><span class="nf">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># 출력
</span><span class="n">word_counts</span><span class="p">.</span><span class="nf">pprint</span><span class="p">()</span>

<span class="c1"># 스트리밍 시작
</span><span class="n">ssc</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
<span class="n">ssc</span><span class="p">.</span><span class="nf">awaitTermination</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="dstream-고급-연산">DStream 고급 연산</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 윈도우 연산
</span><span class="n">windowed_counts</span> <span class="o">=</span> <span class="n">word_counts</span><span class="p">.</span><span class="nf">reduceByKeyAndWindow</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span>  <span class="c1"># reduce 함수
</span>    <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span>  <span class="c1"># inverse reduce 함수
</span>    <span class="mi">30</span><span class="p">,</span>  <span class="c1"># 윈도우 길이 (30초)
</span>    <span class="mi">10</span>   <span class="c1"># 슬라이딩 간격 (10초)
</span><span class="p">)</span>

<span class="c1"># 상태 유지 연산
</span><span class="k">def</span> <span class="nf">update_function</span><span class="p">(</span><span class="n">new_values</span><span class="p">,</span> <span class="n">running_count</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">running_count</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">running_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nf">sum</span><span class="p">(</span><span class="n">new_values</span><span class="p">,</span> <span class="n">running_count</span><span class="p">)</span>

<span class="n">running_counts</span> <span class="o">=</span> <span class="n">word_counts</span><span class="p">.</span><span class="nf">updateStateByKey</span><span class="p">(</span><span class="n">update_function</span><span class="p">)</span>

<span class="c1"># 조인 연산
</span><span class="n">reference_data</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="nf">parallelize</span><span class="p">([(</span><span class="sh">"</span><span class="s">spark</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">framework</span><span class="sh">"</span><span class="p">),</span> <span class="p">(</span><span class="sh">"</span><span class="s">kafka</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">broker</span><span class="sh">"</span><span class="p">)])</span>
<span class="n">reference_dstream</span> <span class="o">=</span> <span class="n">ssc</span><span class="p">.</span><span class="nf">queueStream</span><span class="p">([</span><span class="n">reference_data</span><span class="p">])</span>
<span class="n">joined_stream</span> <span class="o">=</span> <span class="n">word_counts</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rdd</span><span class="p">:</span> <span class="n">rdd</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">reference_data</span><span class="p">))</span>

<span class="c1"># 출력
</span><span class="n">windowed_counts</span><span class="p">.</span><span class="nf">pprint</span><span class="p">()</span>
<span class="n">running_counts</span><span class="p">.</span><span class="nf">pprint</span><span class="p">()</span>
<span class="n">joined_stream</span><span class="p">.</span><span class="nf">pprint</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="structured-streaming-완전-정리">📊 Structured Streaming 완전 정리</h2>

<h3 id="structured-streaming이란">Structured Streaming이란?</h3>

<p>Structured Streaming은 Spark SQL 엔진을 기반으로 한 <strong>고수준 스트리밍 API</strong>입니다.</p>

<h4 id="핵심-특징"><strong>핵심 특징</strong></h4>
<ul>
  <li><strong>정확히 한 번 처리 (Exactly-once processing)</strong></li>
  <li><strong>워터마킹 (Watermarking)</strong> 지원</li>
  <li><strong>이벤트 시간 (Event Time)</strong> 처리</li>
  <li><strong>구조화된 데이터</strong> 처리</li>
</ul>

<h3 id="기본-구조화된-스트리밍">기본 구조화된 스트리밍</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># SparkSession 생성
</span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
    <span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">StructuredStreamingExample</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>

<span class="c1"># 스트리밍 데이터 읽기
</span><span class="n">streaming_df</span> <span class="o">=</span> <span class="n">spark</span> \
    <span class="p">.</span><span class="n">readStream</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">socket</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">host</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">localhost</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">port</span><span class="sh">"</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">load</span><span class="p">()</span>

<span class="c1"># 데이터 변환
</span><span class="n">words_df</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span>
    <span class="nf">explode</span><span class="p">(</span><span class="nf">split</span><span class="p">(</span><span class="n">streaming_df</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">word</span><span class="sh">"</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># 집계
</span><span class="n">word_counts</span> <span class="o">=</span> <span class="n">words_df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">word</span><span class="sh">"</span><span class="p">).</span><span class="nf">count</span><span class="p">()</span>

<span class="c1"># 스트리밍 쿼리 시작
</span><span class="n">query</span> <span class="o">=</span> <span class="n">word_counts</span> \
    <span class="p">.</span><span class="n">writeStream</span> \
    <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">complete</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">trigger</span><span class="p">(</span><span class="n">processingTime</span><span class="o">=</span><span class="sh">"</span><span class="s">10 seconds</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="n">query</span><span class="p">.</span><span class="nf">awaitTermination</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="다양한-데이터-소스">다양한 데이터 소스</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Kafka 스트림
</span><span class="n">kafka_df</span> <span class="o">=</span> <span class="n">spark</span> \
    <span class="p">.</span><span class="n">readStream</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka.bootstrap.servers</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">localhost:9092</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">subscribe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">user-events</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">startingOffsets</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">latest</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">load</span><span class="p">()</span>

<span class="c1"># 2. 파일 스트림
</span><span class="n">file_df</span> <span class="o">=</span> <span class="n">spark</span> \
    <span class="p">.</span><span class="n">readStream</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">json</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/path/to/streaming/data</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">maxFilesPerTrigger</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">load</span><span class="p">()</span>

<span class="c1"># 3. Rate 스트림 (테스트용)
</span><span class="n">rate_df</span> <span class="o">=</span> <span class="n">spark</span> \
    <span class="p">.</span><span class="n">readStream</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">rate</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">rowsPerSecond</span><span class="sh">"</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">load</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="고급-스트리밍-연산">고급 스트리밍 연산</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 이벤트 시간 처리
</span><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">TimestampType</span>

<span class="c1"># 스키마 정의
</span><span class="n">schema</span> <span class="o">=</span> <span class="nc">StructType</span><span class="p">([</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="nc">TimestampType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,</span> <span class="nc">DoubleType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># 스트리밍 데이터 읽기
</span><span class="n">events_df</span> <span class="o">=</span> <span class="n">spark</span> \
    <span class="p">.</span><span class="n">readStream</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka.bootstrap.servers</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">localhost:9092</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">subscribe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">events</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">load</span><span class="p">()</span> \
    <span class="p">.</span><span class="nf">select</span><span class="p">(</span>
        <span class="nf">from_json</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">),</span> <span class="n">schema</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">data.*</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 이벤트 시간 기반 윈도우 집계
</span><span class="n">windowed_events</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
        <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">event_count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_value</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_value</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># 출력
</span><span class="n">query</span> <span class="o">=</span> <span class="n">windowed_events</span> \
    <span class="p">.</span><span class="n">writeStream</span> \
    <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="-kafka-연동과-실시간-데이터-처리">🔗 Kafka 연동과 실시간 데이터 처리</h2>

<h3 id="kafka-설정과-연결">Kafka 설정과 연결</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Kafka 프로듀서 설정
</span><span class="kn">from</span> <span class="n">kafka</span> <span class="kn">import</span> <span class="n">KafkaProducer</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">random</span>

<span class="k">def</span> <span class="nf">create_kafka_producer</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">KafkaProducer</span><span class="p">(</span>
        <span class="n">bootstrap_servers</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">localhost:9092</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">value_serializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">),</span>
        <span class="n">key_serializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="p">)</span>

<span class="c1"># 실시간 데이터 생성 및 전송
</span><span class="k">def</span> <span class="nf">generate_user_events</span><span class="p">():</span>
    <span class="n">producer</span> <span class="o">=</span> <span class="nf">create_kafka_producer</span><span class="p">()</span>
    
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">login</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">logout</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">purchase</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">view</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">click</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">user_ids</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">user_001</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">user_002</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">user_003</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">user_004</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">user_005</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">user_ids</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">actions</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">session_id</span><span class="sh">'</span><span class="p">:</span> <span class="sa">f</span><span class="sh">'</span><span class="s">session_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">ip_address</span><span class="sh">'</span><span class="p">:</span> <span class="sa">f</span><span class="sh">'</span><span class="s">192.168.1.</span><span class="si">{</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="n">producer</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sh">'</span><span class="s">user-events</span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 100ms 간격
</span>    
    <span class="n">producer</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="c1"># 데이터 생성 실행
# generate_user_events()
</span></code></pre></div></div>

<h3 id="spark에서-kafka-데이터-읽기">Spark에서 Kafka 데이터 읽기</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Kafka 스트림 읽기
</span><span class="n">kafka_df</span> <span class="o">=</span> <span class="n">spark</span> \
    <span class="p">.</span><span class="n">readStream</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka.bootstrap.servers</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">localhost:9092</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">subscribe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">user-events</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">startingOffsets</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">earliest</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">failOnDataLoss</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">load</span><span class="p">()</span>

<span class="c1"># JSON 파싱
</span><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">DoubleType</span>

<span class="n">event_schema</span> <span class="o">=</span> <span class="nc">StructType</span><span class="p">([</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="nc">LongType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,</span> <span class="nc">DoubleType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">ip_address</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">parsed_df</span> <span class="o">=</span> <span class="n">kafka_df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span>
    <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka_key</span><span class="sh">"</span><span class="p">),</span>
    <span class="nf">from_json</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">),</span> <span class="n">event_schema</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>
<span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">data.*</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 타임스탬프 변환
</span><span class="n">events_df</span> <span class="o">=</span> <span class="n">parsed_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> 
    <span class="nf">from_unixtime</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="nc">TimestampType</span><span class="p">())</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="실시간-데이터-분석">실시간 데이터 분석</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 실시간 사용자 활동 분석
</span><span class="n">user_activity</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
        <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">30 seconds</span><span class="sh">"</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_events</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_actions</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_value</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">collect_list</span><span class="p">(</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">actions_sequence</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># 액션별 실시간 집계
</span><span class="n">action_metrics</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
        <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">2 minutes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">action</span><span class="sh">"</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">action_count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_users</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_value</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">max_value</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">min</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">min_value</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># 이상 탐지 (실시간)
</span><span class="n">anomaly_detection</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
        <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">2 minutes</span><span class="sh">"</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">event_count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_value</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">event_count</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># 5분에 50개 이상 이벤트
</span>
<span class="c1"># 출력 설정
</span><span class="n">user_activity_query</span> <span class="o">=</span> <span class="n">user_activity</span> \
    <span class="p">.</span><span class="n">writeStream</span> \
    <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="n">action_metrics_query</span> <span class="o">=</span> <span class="n">action_metrics</span> \
    <span class="p">.</span><span class="n">writeStream</span> \
    <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="n">anomaly_query</span> <span class="o">=</span> <span class="n">anomaly_detection</span> \
    <span class="p">.</span><span class="n">writeStream</span> \
    <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="-워터마킹과-지연-데이터-처리">💧 워터마킹과 지연 데이터 처리</h2>

<h3 id="워터마킹이란">워터마킹이란?</h3>

<p>워터마킹은 <strong>지연 데이터(late data)</strong>를 처리하기 위한 메커니즘입니다.</p>

<h4 id="워터마킹-개념"><strong>워터마킹 개념</strong></h4>
<ul>
  <li><strong>이벤트 시간 (Event Time)</strong>: 데이터가 실제로 발생한 시간</li>
  <li><strong>처리 시간 (Processing Time)</strong>: 데이터가 시스템에서 처리되는 시간</li>
  <li><strong>워터마크</strong>: 지연 데이터를 받을 수 있는 최대 지연 시간</li>
</ul>

<h3 id="워터마킹-구현">워터마킹 구현</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 워터마킹을 사용한 윈도우 집계
</span><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">current_timestamp</span>

<span class="c1"># 워터마크 설정 (이벤트 시간으로부터 10분 지연 허용)
</span><span class="n">windowed_events_with_watermark</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
        <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">action</span><span class="sh">"</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_value</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># 지연 데이터 테스트
</span><span class="k">def</span> <span class="nf">test_late_data</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">지연 데이터를 시뮬레이션하는 함수</span><span class="sh">"""</span>
    <span class="kn">import</span> <span class="n">time</span>
    <span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
    
    <span class="n">producer</span> <span class="o">=</span> <span class="nf">create_kafka_producer</span><span class="p">()</span>
    
    <span class="c1"># 정상 데이터
</span>    <span class="n">normal_event</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">user_001</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">click</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="mf">10.0</span>
    <span class="p">}</span>
    
    <span class="c1"># 지연 데이터 (5분 전 데이터)
</span>    <span class="n">late_event</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="nf">int</span><span class="p">((</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">300</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>  <span class="c1"># 5분 전
</span>        <span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">user_002</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">click</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="mf">20.0</span>
    <span class="p">}</span>
    
    <span class="c1"># 매우 지연된 데이터 (15분 전 데이터)
</span>    <span class="n">very_late_event</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="nf">int</span><span class="p">((</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">900</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>  <span class="c1"># 15분 전
</span>        <span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">user_003</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">action</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">click</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="mf">30.0</span>
    <span class="p">}</span>
    
    <span class="c1"># 데이터 전송
</span>    <span class="n">producer</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sh">'</span><span class="s">user-events</span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">normal_event</span><span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">normal_event</span><span class="p">)</span>
    <span class="n">producer</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sh">'</span><span class="s">user-events</span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">late_event</span><span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">late_event</span><span class="p">)</span>
    <span class="n">producer</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sh">'</span><span class="s">user-events</span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">very_late_event</span><span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">very_late_event</span><span class="p">)</span>
    
    <span class="n">producer</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="c1"># 워터마킹 쿼리 실행
</span><span class="n">watermark_query</span> <span class="o">=</span> <span class="n">windowed_events_with_watermark</span> \
    <span class="p">.</span><span class="n">writeStream</span> \
    <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="지연-데이터-처리-전략">지연 데이터 처리 전략</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. 적응형 워터마크
</span><span class="n">adaptive_watermark</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
        <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">2 minutes</span><span class="sh">"</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">event_count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">latest_event_time</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># 2. 지연 데이터 별도 처리
# 정상 데이터
</span><span class="n">normal_data</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nf">current_timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="nf">expr</span><span class="p">(</span><span class="sh">"</span><span class="s">INTERVAL 10 MINUTES</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># 지연 데이터
</span><span class="n">late_data</span> <span class="o">=</span> <span class="n">events_df</span> \
    <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">current_timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="nf">expr</span><span class="p">(</span><span class="sh">"</span><span class="s">INTERVAL 10 MINUTES</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># 3. 지연 데이터 알림
</span><span class="n">late_data_alert</span> <span class="o">=</span> <span class="n">late_data</span> \
    <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">late_event_count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">min</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">earliest_late_event</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span> \
    <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">late_event_count</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># 지연 데이터 알림 쿼리
</span><span class="n">late_alert_query</span> <span class="o">=</span> <span class="n">late_data_alert</span> \
    <span class="p">.</span><span class="n">writeStream</span> \
    <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">update</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="실무-프로젝트-실시간-로그-분석-시스템">🛠 ️ 실무 프로젝트: 실시간 로그 분석 시스템</h2>

<h3 id="프로젝트-구조">프로젝트 구조</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>real-time-log-analysis/
├── src/
│   ├── log_processor.py
│   ├── anomaly_detector.py
│   ├── metrics_calculator.py
│   └── main.py
├── config/
│   ├── kafka_config.py
│   └── streaming_config.yaml
├── docker/
│   ├── docker-compose.yml
│   └── kafka-setup.sh
├── monitoring/
│   ├── grafana-dashboard.json
│   └── prometheus-config.yml
└── README.md
</code></pre></div></div>

<h3 id="1-로그-프로세서">1. 로그 프로세서</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/log_processor.py
</span><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">LogProcessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        
        <span class="c1"># 로그 패턴 정의
</span>        <span class="n">self</span><span class="p">.</span><span class="n">log_patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">apache</span><span class="sh">'</span><span class="p">:</span> <span class="sa">r</span><span class="sh">'</span><span class="s">^(\S+) (\S+) (\S+) \[([\w:/]+\s[+\-]\d{4})\] </span><span class="sh">"</span><span class="s">(\S+) (\S+) (\S+)</span><span class="sh">"</span><span class="s"> (\d{3}) (\S+)</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">nginx</span><span class="sh">'</span><span class="p">:</span> <span class="sa">r</span><span class="sh">'</span><span class="s">^(\S+) - (\S+) \[([\w:/]+\s[+\-]\d{4})\] </span><span class="sh">"</span><span class="s">(\S+) (\S+) (\S+)</span><span class="sh">"</span><span class="s"> (\d{3}) (\S+) </span><span class="sh">"</span><span class="s">([^</span><span class="sh">"</span><span class="s">]*)</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="s">([^</span><span class="sh">"</span><span class="s">]*)</span><span class="sh">"'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">json</span><span class="sh">'</span><span class="p">:</span> <span class="sa">r</span><span class="sh">'</span><span class="s">^{.*}$</span><span class="sh">'</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">parse_apache_log</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">log_line</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Apache 로그 파싱</span><span class="sh">"""</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">log_patterns</span><span class="p">[</span><span class="sh">'</span><span class="s">apache</span><span class="sh">'</span><span class="p">],</span> <span class="n">log_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">ip</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">identity</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">method</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">url</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">protocol</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">8</span><span class="p">)),</span>
                <span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">parse_json_log</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">log_line</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">JSON 로그 파싱</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">create_log_schema</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">로그 스키마 정의</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="nc">StructType</span><span class="p">([</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="nc">TimestampType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">level</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">ip_address</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">request_id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">,</span> <span class="nc">DoubleType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">,</span> <span class="nc">IntegerType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
            <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">error_code</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
        <span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">process_log_stream</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kafka_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">로그 스트림 처리</span><span class="sh">"""</span>
        <span class="c1"># JSON 파싱
</span>        <span class="n">parsed_df</span> <span class="o">=</span> <span class="n">kafka_df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span>
            <span class="nf">from_json</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_log_schema</span><span class="p">()).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">data.*</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 데이터 정제
</span>        <span class="n">cleaned_df</span> <span class="o">=</span> <span class="n">parsed_df</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">)))</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="nc">DoubleType</span><span class="p">()))</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="nc">IntegerType</span><span class="p">()))</span> \
            <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">).</span><span class="nf">isNotNull</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="n">cleaned_df</span>
    
    <span class="k">def</span> <span class="nf">extract_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">logs_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">로그에서 메트릭 추출</span><span class="sh">"""</span>
        <span class="c1"># 응답 시간 분포
</span>        <span class="n">response_time_metrics</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">service</span><span class="sh">"</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">request_count</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_response_time</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">max_response_time</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">min</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">min_response_time</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">stddev</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">stddev_response_time</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># 에러율 계산
</span>        <span class="n">error_rate</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">service</span><span class="sh">"</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_requests</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">error_count</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">error_count</span><span class="sh">"</span><span class="p">)</span> <span class="o">/</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">total_requests</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># IP별 요청 패턴
</span>        <span class="n">ip_patterns</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">ip_address</span><span class="sh">"</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">request_count</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_users</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">collect_set</span><span class="p">(</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">services_used</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">response_time_metrics</span><span class="p">,</span> <span class="n">error_rate</span><span class="p">,</span> <span class="n">ip_patterns</span>
</code></pre></div></div>

<h3 id="2-이상-탐지기">2. 이상 탐지기</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/anomaly_detector.py
</span><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">class</span> <span class="nc">AnomalyDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">detect_response_time_anomalies</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">metrics_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">응답 시간 이상 탐지</span><span class="sh">"""</span>
        <span class="c1"># 이동 평균과 표준편차 계산
</span>        <span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">window</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">anomaly_df</span> <span class="o">=</span> <span class="n">metrics_df</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_avg_response_time</span><span class="sh">"</span><span class="p">,</span> <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span>
                <span class="n">window_spec</span><span class="p">.</span><span class="nf">rowsBetween</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">))</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">stddev_avg_response_time</span><span class="sh">"</span><span class="p">,</span> <span class="nf">stddev</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span>
                <span class="n">window_spec</span><span class="p">.</span><span class="nf">rowsBetween</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">))</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">z_score</span><span class="sh">"</span><span class="p">,</span> 
                <span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_response_time</span><span class="sh">"</span><span class="p">)</span> <span class="o">-</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_avg_response_time</span><span class="sh">"</span><span class="p">))</span> <span class="o">/</span> 
                <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">stddev_avg_response_time</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">z_score</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">z_score</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">anomaly_df</span>
    
    <span class="k">def</span> <span class="nf">detect_error_rate_spikes</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">error_rate_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">에러율 급증 탐지</span><span class="sh">"""</span>
        <span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">window</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">spike_df</span> <span class="o">=</span> <span class="n">error_rate_df</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_error_rate</span><span class="sh">"</span><span class="p">,</span> <span class="nf">lag</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate_change</span><span class="sh">"</span><span class="p">,</span> 
                <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate</span><span class="sh">"</span><span class="p">)</span> <span class="o">-</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_error_rate</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate_change</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10% 이상 증가
</span>        
        <span class="k">return</span> <span class="n">spike_df</span>
    
    <span class="k">def</span> <span class="nf">detect_suspicious_ips</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ip_patterns_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">의심스러운 IP 탐지</span><span class="sh">"""</span>
        <span class="c1"># 높은 요청 빈도
</span>        <span class="n">high_frequency</span> <span class="o">=</span> <span class="n">ip_patterns_df</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">request_count</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
        
        <span class="c1"># 많은 서비스 사용
</span>        <span class="n">multi_service</span> <span class="o">=</span> <span class="n">ip_patterns_df</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">size</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">services_used</span><span class="sh">"</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
        
        <span class="c1"># 의심스러운 패턴 결합
</span>        <span class="n">suspicious_ips</span> <span class="o">=</span> <span class="n">high_frequency</span><span class="p">.</span><span class="nf">intersect</span><span class="p">(</span><span class="n">multi_service</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">suspicious_ips</span>
    
    <span class="k">def</span> <span class="nf">detect_ddos_attacks</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">logs_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">DDoS 공격 탐지</span><span class="sh">"""</span>
        <span class="n">ddos_df</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">ip_address</span><span class="sh">"</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">request_count</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_users</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">request_count</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_users</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">ddos_df</span>
</code></pre></div></div>

<h3 id="3-메트릭-계산기">3. 메트릭 계산기</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/metrics_calculator.py
</span><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>

<span class="k">class</span> <span class="nc">MetricsCalculator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">calculate_sla_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">logs_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">SLA 메트릭 계산</span><span class="sh">"""</span>
        <span class="n">sla_df</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">service</span><span class="sh">"</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_requests</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">fast_requests</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">successful_requests</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">availability</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">successful_requests</span><span class="sh">"</span><span class="p">)</span> <span class="o">/</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">total_requests</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">performance</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">fast_requests</span><span class="sh">"</span><span class="p">)</span> <span class="o">/</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">total_requests</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">sla_df</span>
    
    <span class="k">def</span> <span class="nf">calculate_business_metrics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">logs_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">비즈니스 메트릭 계산</span><span class="sh">"""</span>
        <span class="c1"># 사용자별 활동
</span>        <span class="n">user_activity</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">activity_count</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">services_used</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_response_time</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># 서비스별 인기도
</span>        <span class="n">service_popularity</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">service</span><span class="sh">"</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">request_count</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_users</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">user_activity</span><span class="p">,</span> <span class="n">service_popularity</span>
    
    <span class="k">def</span> <span class="nf">calculate_system_health</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">logs_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">시스템 건강도 계산</span><span class="sh">"""</span>
        <span class="n">health_df</span> <span class="o">=</span> <span class="n">logs_df</span> \
            <span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_requests</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">active_services</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">active_users</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">response_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_response_time</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">error_count</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">error_count</span><span class="sh">"</span><span class="p">)</span> <span class="o">/</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">total_requests</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">health_score</span><span class="sh">"</span><span class="p">,</span> 
                <span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">error_rate</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">otherwise</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">health_df</span>
</code></pre></div></div>

<h3 id="4-메인-애플리케이션">4. 메인 애플리케이션</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">log_processor</span> <span class="kn">import</span> <span class="n">LogProcessor</span>
<span class="kn">from</span> <span class="n">anomaly_detector</span> <span class="kn">import</span> <span class="n">AnomalyDetector</span>
<span class="kn">from</span> <span class="n">metrics_calculator</span> <span class="kn">import</span> <span class="n">MetricsCalculator</span>

<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%(asctime)s - %(name)s - %(levelname)s - %(message)s</span><span class="sh">'</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nf">setup_logging</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Spark 세션 생성
</span>        <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
            <span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">RealTimeLogAnalysis</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.streaming.checkpointLocation</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/tmp/checkpoint</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Spark session created successfully</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 컴포넌트 초기화
</span>        <span class="n">log_processor</span> <span class="o">=</span> <span class="nc">LogProcessor</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">anomaly_detector</span> <span class="o">=</span> <span class="nc">AnomalyDetector</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">metrics_calculator</span> <span class="o">=</span> <span class="nc">MetricsCalculator</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        
        <span class="c1"># Kafka 스트림 읽기
</span>        <span class="n">kafka_df</span> <span class="o">=</span> <span class="n">spark</span> \
            <span class="p">.</span><span class="n">readStream</span> \
            <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka.bootstrap.servers</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">localhost:9092</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">subscribe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">logs</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">startingOffsets</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">latest</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">load</span><span class="p">()</span>
        
        <span class="c1"># 로그 처리
</span>        <span class="n">processed_logs</span> <span class="o">=</span> <span class="n">log_processor</span><span class="p">.</span><span class="nf">process_log_stream</span><span class="p">(</span><span class="n">kafka_df</span><span class="p">)</span>
        
        <span class="c1"># 메트릭 계산
</span>        <span class="n">response_metrics</span><span class="p">,</span> <span class="n">error_rate</span><span class="p">,</span> <span class="n">ip_patterns</span> <span class="o">=</span> <span class="n">log_processor</span><span class="p">.</span><span class="nf">extract_metrics</span><span class="p">(</span><span class="n">processed_logs</span><span class="p">)</span>
        <span class="n">sla_metrics</span> <span class="o">=</span> <span class="n">metrics_calculator</span><span class="p">.</span><span class="nf">calculate_sla_metrics</span><span class="p">(</span><span class="n">processed_logs</span><span class="p">)</span>
        <span class="n">user_activity</span><span class="p">,</span> <span class="n">service_popularity</span> <span class="o">=</span> <span class="n">metrics_calculator</span><span class="p">.</span><span class="nf">calculate_business_metrics</span><span class="p">(</span><span class="n">processed_logs</span><span class="p">)</span>
        <span class="n">system_health</span> <span class="o">=</span> <span class="n">metrics_calculator</span><span class="p">.</span><span class="nf">calculate_system_health</span><span class="p">(</span><span class="n">processed_logs</span><span class="p">)</span>
        
        <span class="c1"># 이상 탐지
</span>        <span class="n">response_anomalies</span> <span class="o">=</span> <span class="n">anomaly_detector</span><span class="p">.</span><span class="nf">detect_response_time_anomalies</span><span class="p">(</span><span class="n">response_metrics</span><span class="p">)</span>
        <span class="n">error_spikes</span> <span class="o">=</span> <span class="n">anomaly_detector</span><span class="p">.</span><span class="nf">detect_error_rate_spikes</span><span class="p">(</span><span class="n">error_rate</span><span class="p">)</span>
        <span class="n">suspicious_ips</span> <span class="o">=</span> <span class="n">anomaly_detector</span><span class="p">.</span><span class="nf">detect_suspicious_ips</span><span class="p">(</span><span class="n">ip_patterns</span><span class="p">)</span>
        <span class="n">ddos_attacks</span> <span class="o">=</span> <span class="n">anomaly_detector</span><span class="p">.</span><span class="nf">detect_ddos_attacks</span><span class="p">(</span><span class="n">processed_logs</span><span class="p">)</span>
        
        <span class="c1"># 쿼리 시작
</span>        <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># 메트릭 출력
</span>        <span class="n">queries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="n">response_metrics</span><span class="p">.</span><span class="n">writeStream</span>
            <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="n">queries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="n">error_rate</span><span class="p">.</span><span class="n">writeStream</span>
            <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="n">queries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="n">system_health</span><span class="p">.</span><span class="n">writeStream</span>
            <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="c1"># 이상 탐지 알림
</span>        <span class="n">queries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="n">response_anomalies</span><span class="p">.</span><span class="n">writeStream</span>
            <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="n">queries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="n">error_spikes</span><span class="p">.</span><span class="n">writeStream</span>
            <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="n">queries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="n">suspicious_ips</span><span class="p">.</span><span class="n">writeStream</span>
            <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="c1"># 모든 쿼리 대기
</span>        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="n">query</span><span class="p">.</span><span class="nf">awaitTermination</span><span class="p">()</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Application failed with error: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">raise</span>
    
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">spark</span><span class="sh">'</span> <span class="ow">in</span> <span class="nf">locals</span><span class="p">():</span>
            <span class="n">spark</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="실시간-대시보드-구축">📊 실시간 대시보드 구축</h2>

<h3 id="grafana-대시보드-설정">Grafana 대시보드 설정</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"dashboard"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Real-time Log Analysis Dashboard"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"panels"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System Health Score"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stat"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avg(health_score)"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Health Score"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Response Time Trends"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"graph"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avg(avg_response_time) by (service)"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Error Rate"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"graph"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avg(error_rate) by (service)"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Request Volume"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"graph"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sum(request_count)"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Total Requests"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Anomaly Alerts"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"table"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anomaly_count"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Anomalies"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="prometheus-메트릭-내보내기">Prometheus 메트릭 내보내기</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 메트릭 내보내기 함수
</span><span class="k">def</span> <span class="nf">export_metrics_to_prometheus</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Prometheus로 메트릭 내보내기</span><span class="sh">"""</span>
    <span class="kn">import</span> <span class="n">requests</span>
    <span class="kn">import</span> <span class="n">time</span>
    
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># 최신 메트릭 수집
</span>        <span class="n">latest_metrics</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">latest_metrics</span><span class="p">:</span>
            <span class="c1"># Prometheus 메트릭 형식으로 변환
</span>            <span class="n">prometheus_metric</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">metric_name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">spark_streaming_metric</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">labels</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">:</span> <span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">],</span>
                    <span class="sh">'</span><span class="s">window</span><span class="sh">'</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">window</span><span class="sh">'</span><span class="p">])</span>
                <span class="p">},</span>
                <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_response_time</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="c1"># Prometheus Pushgateway로 전송
</span>            <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
                <span class="sh">'</span><span class="s">http://localhost:9091/metrics/job/spark_streaming</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">prometheus_metric</span>
            <span class="p">)</span>
        
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10초마다 전송
</span></code></pre></div></div>

<h2 id="실시간-분석-지연시간-최적화">⚡ 실시간 분석 지연시간 최적화</h2>

<h3 id="지연시간-분석-도구">지연시간 분석 도구</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 실시간 지연시간 분석 및 최적화 도구
</span><span class="k">class</span> <span class="nc">StreamingLatencyOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        
    <span class="k">def</span> <span class="nf">analyze_processing_latency</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">,</span> <span class="n">latency_threshold_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">처리 지연시간 분석</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">,</span> <span class="n">unix_timestamp</span><span class="p">,</span> <span class="n">when</span>
        
        <span class="c1"># 이벤트 시간과 처리 시간 사이의 지연 계산
</span>        <span class="n">latency_df</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">(</span><span class="nf">unix_timestamp</span><span class="p">(</span><span class="nf">current_timestamp</span><span class="p">())</span> <span class="o">-</span> <span class="nf">unix_timestamp</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">)</span>
        
        <span class="c1"># 지연시간 통계 계산
</span>        <span class="n">latency_stats</span> <span class="o">=</span> <span class="n">latency_df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span>
            <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">latency_threshold_ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">is_slow</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">).</span><span class="nf">agg</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">avg</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">is_slow</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">sum</span><span class="sh">"</span>
        <span class="p">}).</span><span class="nf">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">total_records</span> <span class="o">=</span> <span class="n">latency_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">max_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">min_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">slow_records_count</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_stats</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">slow_records_ratio</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_stats</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_records</span> <span class="k">if</span> <span class="n">total_records</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_records</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_records</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">latency_threshold_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_threshold_ms</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">optimize_streaming_configuration</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_config</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">스트리밍 설정 최적화</span><span class="sh">"""</span>
        <span class="n">optimized_config</span> <span class="o">=</span> <span class="n">current_config</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        
        <span class="c1"># 배치 간격 최적화 (지연시간에 따라 조정)
</span>        <span class="k">if</span> <span class="n">current_config</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">batch_interval_seconds</span><span class="sh">'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">optimized_config</span><span class="p">[</span><span class="sh">'</span><span class="s">batch_interval_seconds</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1초로 단축
</span>        
        <span class="c1"># 백프레셔 설정 최적화
</span>        <span class="n">optimized_config</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.rateLimit.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.rateLimit.maxOffsetsPerTrigger</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">10000</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.rateLimit.maxRecordsPerSecond</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">5000</span><span class="sh">'</span>
        <span class="p">})</span>
        
        <span class="c1"># 체크포인트 최적화
</span>        <span class="n">optimized_config</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.checkpointLocation</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/optimized_checkpoint</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.minBatchesToRetain</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span>  <span class="c1"># 최소 배치 유지
</span>            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.providerClass</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">org.apache.spark.sql.execution.streaming.state.HDFSBackedStateStoreProvider</span><span class="sh">'</span>
        <span class="p">})</span>
        
        <span class="c1"># 메모리 최적화
</span>        <span class="n">optimized_config</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.maintenanceInterval</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">10s</span><span class="sh">'</span><span class="p">,</span>  <span class="c1"># 상태 정리 간격 단축
</span>            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.minDeltasForSnapshot</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">10</span><span class="sh">'</span>   <span class="c1"># 스냅샷 생성 빈도 증가
</span>        <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">optimized_config</span>
    
    <span class="k">def</span> <span class="nf">implement_adaptive_batching</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">,</span> <span class="n">target_latency_ms</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">적응형 배칭 구현</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">max</span> <span class="k">as</span> <span class="n">spark_max</span>
        
        <span class="c1"># 윈도우 크기를 동적으로 조정하는 함수
</span>        <span class="k">def</span> <span class="nf">create_adaptive_window</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">base_window_size</span><span class="o">=</span><span class="sh">"</span><span class="s">10 seconds</span><span class="sh">"</span><span class="p">):</span>
            <span class="c1"># 현재 시스템 부하에 따라 윈도우 크기 조정
</span>            <span class="n">current_load</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_system_load</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">current_load</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># 높은 부하
</span>                <span class="n">window_size</span> <span class="o">=</span> <span class="sh">"</span><span class="s">30 seconds</span><span class="sh">"</span>
            <span class="k">elif</span> <span class="n">current_load</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># 중간 부하
</span>                <span class="n">window_size</span> <span class="o">=</span> <span class="sh">"</span><span class="s">20 seconds</span><span class="sh">"</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># 낮은 부하
</span>                <span class="n">window_size</span> <span class="o">=</span> <span class="sh">"</span><span class="s">10 seconds</span><span class="sh">"</span>
            
            <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="n">window_size</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nf">create_adaptive_window</span><span class="p">(</span><span class="n">streaming_df</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_system_load</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">시스템 부하 측정</span><span class="sh">"""</span>
        <span class="n">status_tracker</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sparkContext</span><span class="p">.</span><span class="nf">statusTracker</span><span class="p">()</span>
        <span class="n">executor_infos</span> <span class="o">=</span> <span class="n">status_tracker</span><span class="p">.</span><span class="nf">getExecutorInfos</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">executor_infos</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">total_memory</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">maxMemory</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">executor_infos</span><span class="p">)</span>
        <span class="n">used_memory</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">memoryUsed</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">executor_infos</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">used_memory</span> <span class="o">/</span> <span class="n">total_memory</span> <span class="k">if</span> <span class="n">total_memory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">optimize_watermark_strategy</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">,</span> <span class="n">data_lateness_hours</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">워터마크 전략 최적화</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">max</span> <span class="k">as</span> <span class="n">spark_max</span>
        
        <span class="c1"># 데이터 지연 패턴에 따른 적응형 워터마크
</span>        <span class="n">watermark_delay</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_lateness_hours</span><span class="si">}</span><span class="s"> hours</span><span class="sh">"</span>
        
        <span class="c1"># 지연시간이 긴 데이터를 위한 추가 처리
</span>        <span class="n">optimized_df</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="n">watermark_delay</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">optimized_df</span>
    
    <span class="k">def</span> <span class="nf">implement_latency_monitoring</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">지연시간 모니터링 구현</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">,</span> <span class="n">unix_timestamp</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">avg</span>
        
        <span class="c1"># 실시간 지연시간 메트릭 생성
</span>        <span class="n">latency_metrics</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">(</span><span class="nf">unix_timestamp</span><span class="p">(</span><span class="nf">current_timestamp</span><span class="p">())</span> <span class="o">-</span> <span class="nf">unix_timestamp</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">).</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10 minutes</span><span class="sh">"</span><span class="p">).</span><span class="nf">groupBy</span><span class="p">(</span>
            <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">service</span><span class="sh">"</span>
        <span class="p">).</span><span class="nf">agg</span><span class="p">(</span>
            <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">record_count</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_latency_ms</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">latency_metrics</span>

<span class="c1"># 지연시간 최적화 예제
</span><span class="k">def</span> <span class="nf">streaming_latency_optimization_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">StreamingLatencyOptimization</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="nc">StreamingLatencyOptimizer</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># 스트리밍 데이터 생성 (Kafka에서 읽는 것으로 가정)
</span>    <span class="n">streaming_df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">readStream</span> \
        <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka</span><span class="sh">"</span><span class="p">)</span> \
        <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">kafka.bootstrap.servers</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">localhost:9092</span><span class="sh">"</span><span class="p">)</span> \
        <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">subscribe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">logs</span><span class="sh">"</span><span class="p">)</span> \
        <span class="p">.</span><span class="nf">load</span><span class="p">()</span>
    
    <span class="c1"># JSON 파싱
</span>    <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">from_json</span>
    <span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">TimestampType</span>
    
    <span class="n">schema</span> <span class="o">=</span> <span class="nc">StructType</span><span class="p">([</span>
        <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="nc">TimestampType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
        <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
        <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="n">parsed_df</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span>
        <span class="nf">from_json</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">),</span> <span class="n">schema</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">data.*</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 지연시간 분석
</span>    <span class="n">latency_analysis</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">analyze_processing_latency</span><span class="p">(</span><span class="n">parsed_df</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Streaming Latency Analysis ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average Latency: </span><span class="si">{</span><span class="n">latency_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Max Latency: </span><span class="si">{</span><span class="n">latency_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">max_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Slow Records Ratio: </span><span class="si">{</span><span class="n">latency_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">slow_records_ratio</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 설정 최적화
</span>    <span class="n">current_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">batch_interval_seconds</span><span class="sh">'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">checkpoint_location</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/checkpoint</span><span class="sh">'</span>
    <span class="p">}</span>
    
    <span class="n">optimized_config</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_streaming_configuration</span><span class="p">(</span><span class="n">current_config</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Optimized Configuration ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">optimized_config</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 지연시간 모니터링 설정
</span>    <span class="n">latency_metrics</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">implement_latency_monitoring</span><span class="p">(</span><span class="n">parsed_df</span><span class="p">)</span>
    
    <span class="c1"># 스트리밍 쿼리 시작
</span>    <span class="n">query</span> <span class="o">=</span> <span class="n">latency_metrics</span><span class="p">.</span><span class="n">writeStream</span> \
        <span class="p">.</span><span class="nf">outputMode</span><span class="p">(</span><span class="sh">"</span><span class="s">update</span><span class="sh">"</span><span class="p">)</span> \
        <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">console</span><span class="sh">"</span><span class="p">)</span> \
        <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">truncate</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
        <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">query</span>
</code></pre></div></div>

<h3 id="고급-지연시간-최적화-기법">고급 지연시간 최적화 기법</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 고급 지연시간 최적화 클래스
</span><span class="k">class</span> <span class="nc">AdvancedLatencyOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">implement_parallel_processing</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">,</span> <span class="n">parallelism_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">병렬 처리 구현</span><span class="sh">"""</span>
        <span class="c1"># 파티션 수를 증가시켜 병렬 처리 향상
</span>        <span class="n">current_partitions</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span>
        <span class="n">optimized_partitions</span> <span class="o">=</span> <span class="n">current_partitions</span> <span class="o">*</span> <span class="n">parallelism_factor</span>
        
        <span class="k">return</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="n">optimized_partitions</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">optimize_memory_usage_for_low_latency</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">저지연을 위한 메모리 최적화</span><span class="sh">"""</span>
        <span class="c1"># 저지연 처리를 위한 메모리 설정
</span>        <span class="n">memory_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.maintenanceInterval</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">5s</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.minDeltasForSnapshot</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.compression.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.compression.codec</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">lz4</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.rocksdb.compression</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.rocksdb.blockSizeKB</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">64</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.streaming.stateStore.rocksdb.blockCacheSizeMB</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">128</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">memory_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">spark_session</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">memory_configs</span>
    
    <span class="k">def</span> <span class="nf">implement_backpressure_control</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">백프레셔 제어 구현</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">when</span>
        
        <span class="c1"># 데이터 처리 속도를 모니터링하고 조절
</span>        <span class="n">backpressure_df</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">processing_rate</span><span class="sh">"</span><span class="p">,</span>
            <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">long</span><span class="sh">"</span><span class="p">)</span> <span class="o">-</span> <span class="nf">lag</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">long</span><span class="sh">"</span><span class="p">),</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span>
                <span class="nf">window</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">1 minute</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">).</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">should_throttle</span><span class="sh">"</span><span class="p">,</span>
            <span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">processing_rate</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="bp">True</span><span class="p">).</span><span class="nf">otherwise</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># 1초당 1000개 이상이면 스로틀링
</span>        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">backpressure_df</span>
    
    <span class="k">def</span> <span class="nf">optimize_serialization_for_low_latency</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">저지연을 위한 직렬화 최적화</span><span class="sh">"""</span>
        <span class="n">serialization_configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">spark.serializer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">org.apache.spark.serializer.KryoSerializer</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.pyspark.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.maxRecordsPerBatch</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">10000</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">spark.sql.execution.arrow.pyspark.fallback.enabled</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">serialization_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">spark_session</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">serialization_configs</span>
    
    <span class="k">def</span> <span class="nf">implement_caching_for_streaming</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">스트리밍을 위한 캐싱 전략</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark</span> <span class="kn">import</span> <span class="n">StorageLevel</span>
        
        <span class="c1"># 자주 사용되는 데이터를 메모리에 캐싱
</span>        <span class="n">cached_df</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_AND_DISK_SER</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cached_df</span>

<span class="c1"># 고급 지연시간 최적화 예제
</span><span class="k">def</span> <span class="nf">advanced_latency_optimization_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">AdvancedLatencyOptimization</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="nc">AdvancedLatencyOptimizer</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># 스트리밍 데이터 생성
</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="sh">"</span><span class="s">service_</span><span class="si">{</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">message_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># 병렬 처리 최적화
</span>    <span class="n">parallel_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">implement_parallel_processing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Parallel processing partitions: </span><span class="si">{</span><span class="n">parallel_df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="nf">getNumPartitions</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 메모리 최적화
</span>    <span class="n">memory_configs</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_memory_usage_for_low_latency</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Memory Optimization Configs ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">memory_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 직렬화 최적화
</span>    <span class="n">serialization_configs</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">optimize_serialization_for_low_latency</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== Serialization Optimization Configs ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">serialization_configs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 캐싱 전략 적용
</span>    <span class="n">cached_df</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">implement_caching_for_streaming</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">cached_df</span>
</code></pre></div></div>

<h3 id="실시간-지연시간-모니터링-대시보드">실시간 지연시간 모니터링 대시보드</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 실시간 지연시간 모니터링 대시보드
</span><span class="k">class</span> <span class="nc">RealTimeLatencyDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        
    <span class="k">def</span> <span class="nf">create_latency_monitoring_dashboard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">streaming_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">지연시간 모니터링 대시보드 생성</span><span class="sh">"""</span>
        <span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">,</span> <span class="n">unix_timestamp</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="nb">max</span> <span class="k">as</span> <span class="n">spark_max</span><span class="p">,</span> <span class="nb">min</span> <span class="k">as</span> <span class="n">spark_min</span>
        
        <span class="c1"># 실시간 지연시간 메트릭 계산
</span>        <span class="n">latency_metrics</span> <span class="o">=</span> <span class="n">streaming_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">(</span><span class="nf">unix_timestamp</span><span class="p">(</span><span class="nf">current_timestamp</span><span class="p">())</span> <span class="o">-</span> <span class="nf">unix_timestamp</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">).</span><span class="nf">withWatermark</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">5 minutes</span><span class="sh">"</span><span class="p">).</span><span class="nf">groupBy</span><span class="p">(</span>
            <span class="nf">window</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">30 seconds</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">service</span><span class="sh">"</span>
        <span class="p">).</span><span class="nf">agg</span><span class="p">(</span>
            <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">record_count</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_latency_ms</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">spark_max</span><span class="p">(</span><span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">max_latency_ms</span><span class="sh">"</span><span class="p">),</span>
            <span class="nf">spark_min</span><span class="p">(</span><span class="sh">"</span><span class="s">processing_latency_ms</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">min_latency_ms</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># 지연시간 알림 생성
</span>        <span class="n">alerts</span> <span class="o">=</span> <span class="n">latency_metrics</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">alert_level</span><span class="sh">"</span><span class="p">,</span>
            <span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_latency_ms</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">,</span> <span class="sh">"</span><span class="s">CRITICAL</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_latency_ms</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="sh">"</span><span class="s">WARNING</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">when</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_latency_ms</span><span class="sh">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">,</span> <span class="sh">"</span><span class="s">INFO</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">otherwise</span><span class="p">(</span><span class="sh">"</span><span class="s">OK</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">metrics</span><span class="sh">'</span><span class="p">:</span> <span class="n">latency_metrics</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">alerts</span><span class="sh">'</span><span class="p">:</span> <span class="n">alerts</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">export_latency_metrics_to_grafana</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">metrics_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Grafana용 지연시간 메트릭 내보내기</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">requests</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="kn">import</span> <span class="n">time</span>
        
        <span class="k">def</span> <span class="nf">export_to_grafana</span><span class="p">():</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># 최신 메트릭 수집
</span>                    <span class="n">latest_metrics</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
                    
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">latest_metrics</span><span class="p">:</span>
                        <span class="c1"># Grafana 데이터 포인트 형식
</span>                        <span class="n">grafana_data</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="sh">"</span><span class="s">time</span><span class="sh">"</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
                            <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">],</span>
                            <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                                <span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">:</span> <span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">],</span>
                                <span class="sh">"</span><span class="s">window</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">window</span><span class="sh">'</span><span class="p">])</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        
                        <span class="c1"># Grafana API로 전송
</span>                        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
                            <span class="sh">'</span><span class="s">http://localhost:3000/api/datasources/proxy/1/write</span><span class="sh">'</span><span class="p">,</span>
                            <span class="n">json</span><span class="o">=</span><span class="n">grafana_data</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">Content-Type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">application/json</span><span class="sh">'</span><span class="p">}</span>
                        <span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Latency metric exported: </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to export metric: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    
                    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># 30초마다 전송
</span>                    
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error exporting metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># 에러 시 1분 대기
</span>        
        <span class="k">return</span> <span class="n">export_to_grafana</span>
    
    <span class="k">def</span> <span class="nf">create_latency_alerting_system</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">alerts_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">지연시간 알림 시스템 생성</span><span class="sh">"""</span>
        <span class="k">def</span> <span class="nf">process_alerts</span><span class="p">():</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># 최신 알림 수집
</span>                    <span class="n">latest_alerts</span> <span class="o">=</span> <span class="n">alerts_df</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
                    
                    <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">latest_alerts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">alert_level</span><span class="sh">'</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">WARNING</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CRITICAL</span><span class="sh">'</span><span class="p">]:</span>
                            <span class="c1"># 알림 메시지 생성
</span>                            <span class="n">alert_message</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="sh">'</span><span class="s">level</span><span class="sh">'</span><span class="p">:</span> <span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">alert_level</span><span class="sh">'</span><span class="p">],</span>
                                <span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">:</span> <span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">],</span>
                                <span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">],</span>
                                <span class="sh">'</span><span class="s">max_latency_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">max_latency_ms</span><span class="sh">'</span><span class="p">],</span>
                                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">window</span><span class="sh">'</span><span class="p">]),</span>
                                <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Service </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> has high latency: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span>
                            <span class="p">}</span>
                            
                            <span class="c1"># Slack, 이메일, SMS 등으로 알림 전송
</span>                            <span class="n">self</span><span class="p">.</span><span class="nf">_send_alert</span><span class="p">(</span><span class="n">alert_message</span><span class="p">)</span>
                    
                    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># 1분마다 알림 체크
</span>                    
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error processing alerts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>  <span class="c1"># 에러 시 2분 대기
</span>        
        <span class="k">return</span> <span class="n">process_alerts</span>
    
    <span class="k">def</span> <span class="nf">_send_alert</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">alert_message</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">알림 전송 (Slack 예시)</span><span class="sh">"""</span>
        <span class="kn">import</span> <span class="n">requests</span>
        
        <span class="n">slack_webhook_url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK</span><span class="sh">"</span>
        
        <span class="n">slack_message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">🚨 Spark Streaming Latency Alert</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">attachments</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">color</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">danger</span><span class="sh">"</span> <span class="k">if</span> <span class="n">alert_message</span><span class="p">[</span><span class="sh">'</span><span class="s">level</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">CRITICAL</span><span class="sh">'</span> <span class="k">else</span> <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">fields</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Service</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">alert_message</span><span class="p">[</span><span class="sh">'</span><span class="s">service</span><span class="sh">'</span><span class="p">],</span> <span class="sh">"</span><span class="s">short</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Average Latency</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">alert_message</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">short</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Max Latency</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">alert_message</span><span class="p">[</span><span class="sh">'</span><span class="s">max_latency_ms</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">ms</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">short</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Alert Level</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">alert_message</span><span class="p">[</span><span class="sh">'</span><span class="s">level</span><span class="sh">'</span><span class="p">],</span> <span class="sh">"</span><span class="s">short</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">slack_webhook_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">slack_message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Alert sent successfully: </span><span class="si">{</span><span class="n">alert_message</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to send alert: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error sending alert: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 실시간 지연시간 모니터링 예제
</span><span class="k">def</span> <span class="nf">real_time_latency_monitoring_example</span><span class="p">():</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">RealTimeLatencyMonitoring</span><span class="sh">"</span><span class="p">).</span><span class="nf">getOrCreate</span><span class="p">()</span>
    <span class="n">dashboard</span> <span class="o">=</span> <span class="nc">RealTimeLatencyDashboard</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
    
    <span class="c1"># 스트리밍 데이터 생성
</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="sh">"</span><span class="s">service_</span><span class="si">{</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">message_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">])</span>
    
    <span class="c1"># 지연시간 모니터링 대시보드 생성
</span>    <span class="n">dashboard_data</span> <span class="o">=</span> <span class="n">dashboard</span><span class="p">.</span><span class="nf">create_latency_monitoring_dashboard</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="c1"># 메트릭 내보내기 함수
</span>    <span class="n">export_function</span> <span class="o">=</span> <span class="n">dashboard</span><span class="p">.</span><span class="nf">export_latency_metrics_to_grafana</span><span class="p">(</span><span class="n">dashboard_data</span><span class="p">[</span><span class="sh">'</span><span class="s">metrics</span><span class="sh">'</span><span class="p">])</span>
    
    <span class="c1"># 알림 처리 함수
</span>    <span class="n">alert_function</span> <span class="o">=</span> <span class="n">dashboard</span><span class="p">.</span><span class="nf">create_latency_alerting_system</span><span class="p">(</span><span class="n">dashboard_data</span><span class="p">[</span><span class="sh">'</span><span class="s">alerts</span><span class="sh">'</span><span class="p">])</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== Real-time Latency Monitoring Dashboard Created ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Metrics and alerts are being processed in real-time</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 실제 환경에서는 별도 스레드에서 실행
</span>    <span class="c1"># import threading
</span>    <span class="c1"># threading.Thread(target=export_function, daemon=True).start()
</span>    <span class="c1"># threading.Thread(target=alert_function, daemon=True).start()
</span>    
    <span class="k">return</span> <span class="n">dashboard_data</span>
</code></pre></div></div>

<h2 id="학습-요약">📚 학습 요약</h2>

<h3 id="이번-파트에서-학습한-내용">이번 파트에서 학습한 내용</h3>

<ol>
  <li><strong>Spark Streaming 기초</strong>
    <ul>
      <li>DStream과 마이크로 배치 처리</li>
      <li>기본 변환 연산과 윈도우 연산</li>
      <li>상태 유지 연산</li>
    </ul>
  </li>
  <li><strong>Structured Streaming</strong>
    <ul>
      <li>고수준 스트리밍 API</li>
      <li>이벤트 시간 처리</li>
      <li>다양한 데이터 소스</li>
    </ul>
  </li>
  <li><strong>Kafka 연동</strong>
    <ul>
      <li>Kafka 프로듀서/컨슈머 설정</li>
      <li>실시간 데이터 생성과 처리</li>
      <li>JSON 파싱과 스키마 처리</li>
    </ul>
  </li>
  <li><strong>워터마킹과 지연 데이터</strong>
    <ul>
      <li>워터마크 메커니즘 이해</li>
      <li>지연 데이터 처리 전략</li>
      <li>적응형 워터마크</li>
    </ul>
  </li>
  <li><strong>실무 프로젝트</strong>
    <ul>
      <li>실시간 로그 분석 시스템</li>
      <li>이상 탐지와 알림</li>
      <li>메트릭 계산과 모니터링</li>
    </ul>
  </li>
  <li><strong>실시간 대시보드</strong>
    <ul>
      <li>Grafana 대시보드 구축</li>
      <li>Prometheus 메트릭 내보내기</li>
      <li>실시간 모니터링</li>
    </ul>
  </li>
  <li><strong>실시간 분석 지연시간 최적화</strong>
    <ul>
      <li>지연시간 분석 도구</li>
      <li>고급 지연시간 최적화 기법</li>
      <li>실시간 지연시간 모니터링 대시보드</li>
    </ul>
  </li>
</ol>

<h3 id="핵심-기술-스택">핵심 기술 스택</h3>

<table>
  <thead>
    <tr>
      <th>기술</th>
      <th>용도</th>
      <th>중요도</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Spark Streaming</strong></td>
      <td>마이크로 배치 처리</td>
      <td>⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>Structured Streaming</strong></td>
      <td>고수준 스트리밍</td>
      <td>⭐⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>Kafka</strong></td>
      <td>메시지 브로커</td>
      <td>⭐⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>워터마킹</strong></td>
      <td>지연 데이터 처리</td>
      <td>⭐⭐⭐⭐</td>
    </tr>
    <tr>
      <td><strong>Grafana</strong></td>
      <td>실시간 대시보드</td>
      <td>⭐⭐⭐⭐</td>
    </tr>
  </tbody>
</table>

<h3 id="다음-파트-미리보기">다음 파트 미리보기</h3>

<p><strong>Part 4: 모니터링과 성능 튜닝</strong>에서는 다음 내용을 다룹니다:</p>
<ul>
  <li>Spark UI와 메트릭 분석</li>
  <li>성능 모니터링과 프로파일링</li>
  <li>메모리 최적화와 캐싱 전략</li>
  <li>클러스터 튜닝과 확장성</li>
</ul>

<hr />

<p><strong>다음 파트</strong>: <a href="/data-engineering/2025/09/14/apache-spark-monitoring-tuning.html">Part 4: 모니터링과 성능 튜닝</a></p>

<hr />

<p><em>이제 실시간 스트리밍 처리까지 마스터했습니다! 마지막 파트에서는 성능 튜닝과 모니터링으로 완성도를 높이겠습니다.</em> 🚀</p>

  </div>

  
  <div class="post-navigation">
    <div class="nav-links">
      
      
      
        
      
        
      
        
          
          
      
      
        
        
        <a href="/data-engineering/2025/09/12/apache-spark-batch-processing.html" class="nav-link prev">
          ← 이전: Part 2: Apache Spark 대용량 배치 처리와 UDF 활용 - 실무 프로젝트
        </a>
      
      
      
        
        
        <a href="/data-engineering/2025/09/13/apache-spark-monitoring-tuning.html" class="nav-link next">
          다음: Part 4: Apache Spark 모니터링과 성능 튜닝 - 프로덕션 환경 완성 →
        </a>
      
    </div>
    
    <div class="series-overview">
      <a href="/categories/data-engineering/" class="btn btn-secondary">
        📚 시리즈 전체 보기
      </a>
    </div>
  </div>
  
</article>

    </div>
  </main>
  
  
  <footer class="site-footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h3>Data Droid Blog</h3>
        <p>데이터 엔지니어가 다루는 기술 블로그</p>
      </div>
      
      <div class="footer-section">
        <h4>카테고리</h4>
        <ul>
          <li><a href="/categories/data-engineering/">데이터 엔지니어링</a></li>
          <li><a href="/categories/bi-engineering/">BI 엔지니어링</a></li>
          <li><a href="/categories/infrastructure-tools/">인프라 & 도구</a></li>
          <li><a href="/categories/data-quality/">데이터 품질</a></li>
          <li><a href="/categories/data-ai/">Data AI</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>링크</h4>
        <ul>
          <li><a href="/">홈</a></li>
          <li><a href="/blog/">블로그</a></li>
          <li><a href="/about/">소개</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>소셜</h4>
        <ul>
          
          <li><a href="https://github.com/data-droid">GitHub</a></li>
          
          <li><a href="https://www.linkedin.com/in/jaekyung-lee-a61ab2193/">LinkedIn</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 Data Droid Blog. 모든 권리 보유</p>
    </div>
  </div>
</footer>



  
  <script src="/assets/js/main.js"></script>
</body>
</html>
