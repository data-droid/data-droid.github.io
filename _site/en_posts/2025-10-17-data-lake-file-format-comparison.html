<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="/assets/css/style.css">
  <!-- Head includes for Jekyll -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SEO -->

<meta name="description" content="Complete comparison of core data lake file formats Parquet, ORC, and Avro from internal structure to performance, compression ratio, and compatibility with actual benchmarks.">



<title>Parquet vs ORC vs Avro Real-World Comparison - Complete Guide to Data Lake File Formats - Data Droid Blog</title>


<!-- Open Graph -->
<meta property="og:title" content="Parquet vs ORC vs Avro Real-World Comparison - Complete Guide to Data Lake File Formats">
<meta property="og:description" content="Complete comparison of core data lake file formats Parquet, ORC, and Avro from internal structure to performance, compression ratio, and compatibility with actual benchmarks.">
<meta property="og:url" content="http://localhost:4000/en_posts/2025-10-17-data-lake-file-format-comparison.html">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Parquet vs ORC vs Avro Real-World Comparison - Complete Guide to Data Lake File Formats">
<meta name="twitter:description" content="Complete comparison of core data lake file formats Parquet, ORC, and Avro from internal structure to performance, compression ratio, and compatibility with actual benchmarks.">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Data Droid Blog" href="/feed.xml">

<!-- Google Analytics -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GP9LT745PP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GP9LT745PP');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <div class="site-title">
      <a href="/">Data Droid Blog</a>
    </div>
    
    <!-- Mobile menu toggle button -->
    <button class="mobile-menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    
    <nav class="site-nav">
      <ul class="nav-list">
        <li><a href="/">Home</a></li>
                  <li class="dropdown">
            <a href="#" class="dropdown-toggle">Categories</a>
            <ul class="dropdown-menu">

              <li><a href="/en/categories/data-engineering/">Data Engineering</a></li>
              <li><a href="/en/categories/bi-engineering/">BI Engineering</a></li>
              <li><a href="/en/categories/infrastructure-tools/">Infrastructure & Tools</a></li>
              <li><a href="/en/categories/data-quality/">Data Quality</a></li>
              <li><a href="/en/categories/data-ai/">Data AI</a></li>
            </ul>
          </li>
        <li><a href="/en/blog/">Blog</a></li>
        <li><a href="/en/about/">About</a></li>
      </ul>
    </nav>
    
    <div class="language-switcher">
      
        <!-- í¬ìŠ¤íŠ¸ìš© ì–¸ì–´ ì „í™˜ -->
        
          
          <a href="/data-engineering/2025/10/17/data-lake-file-format-comparison.html" class="lang-btn">í•œêµ­ì–´</a>
          <a href="/en_posts/2025-10-17-data-lake-file-format-comparison.html" class="lang-btn active">English</a>
        
      
    </div>
  </div>
</header>

  
  <main class="site-main">
    <div class="container">
      <article class="post">
  <header class="post-header">
    <div class="post-meta">
      <span class="post-category">Data engineering</span>
      <span class="post-date">2025ë…„ 10ì›” 17ì¼</span>
      <span class="post-author">Data Droid</span>
    </div>
    
    <h1 class="post-title">Parquet vs ORC vs Avro Real-World Comparison - Complete Guide to Data Lake File Formats</h1>
    
    
    <div class="post-tags">
      
        <span class="tag">Parquet</span>
      
        <span class="tag">ORC</span>
      
        <span class="tag">Avro</span>
      
        <span class="tag">DataLake</span>
      
        <span class="tag">FileFormat</span>
      
        <span class="tag">Performance</span>
      
        <span class="tag">Compression</span>
      
        <span class="tag">Spark</span>
      
        <span class="tag">Hive</span>
      
    </div>
    
    
    
    <div class="post-series">
      <span class="series-badge">ğŸ“š Cloud data architecture ì‹œë¦¬ì¦ˆ</span>
      <span class="series-order">Part 3</span>
    </div>
    
    
    
    <div class="post-info">
      
        <span class="reading-time">â±ï¸ 55 min</span>
      
      
        <span class="difficulty">ğŸ“Š Intermediate</span>
      
    </div>
    
  </header>

  <div class="post-content">
    <h1 id="ï¸-parquet-vs-orc-vs-avro-real-world-comparison---complete-guide-to-data-lake-file-formats">ğŸ—„ï¸ Parquet vs ORC vs Avro Real-World Comparison - Complete Guide to Data Lake File Formats</h1>

<blockquote>
  <p><strong>â€œChoosing the right file format can make a 10x difference in performance and costâ€</strong> - One of the most important decisions in building a data lake</p>
</blockquote>

<p>When building a data lake, one of the first questions you face is â€œwhich file format should I use?â€ Parquet, ORC, and Avro each have unique characteristics and trade-offs, and the wrong choice can lead to serious performance degradation and cost increases. This post provides internal structure of the three formats, actual benchmark results, and optimal selection guide for each scenario.</p>

<hr />

<h2 id="-table-of-contents">ğŸ“š Table of Contents</h2>

<ul>
  <li><a href="#file-format-overview">File Format Overview</a></li>
  <li><a href="#parquet-internal-structure">Parquet Internal Structure</a></li>
  <li><a href="#orc-internal-structure">ORC Internal Structure</a></li>
  <li><a href="#avro-internal-structure">Avro Internal Structure</a></li>
  <li><a href="#actual-benchmark-comparison">Actual Benchmark Comparison</a></li>
  <li><a href="#optimal-format-selection-by-use-case">Optimal Format Selection by Use Case</a></li>
  <li><a href="#format-conversion-guide">Format Conversion Guide</a></li>
  <li><a href="#learning-summary">Learning Summary</a></li>
</ul>

<hr />

<h2 id="file-format-overview">ğŸ“‹ File Format Overview</h2>

<h3 id="major-file-format-comparison">Major File Format Comparison</h3>

<table>
  <thead>
    <tr>
      <th><strong>Characteristic</strong></th>
      <th><strong>Parquet</strong></th>
      <th><strong>ORC</strong></th>
      <th><strong>Avro</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Storage Method</strong></td>
      <td>Columnar</td>
      <td>Columnar</td>
      <td>Row-based</td>
    </tr>
    <tr>
      <td><strong>Compression Ratio</strong></td>
      <td>High (4-10x)</td>
      <td>Very High (5-12x)</td>
      <td>Medium (2-4x)</td>
    </tr>
    <tr>
      <td><strong>Read Performance</strong></td>
      <td>Very Fast</td>
      <td>Very Fast</td>
      <td>Slow</td>
    </tr>
    <tr>
      <td><strong>Write Performance</strong></td>
      <td>Medium</td>
      <td>Medium</td>
      <td>Fast</td>
    </tr>
    <tr>
      <td><strong>Schema Evolution</strong></td>
      <td>Limited</td>
      <td>Limited</td>
      <td>Excellent</td>
    </tr>
    <tr>
      <td><strong>Ecosystem</strong></td>
      <td>Spark, Presto, Athena</td>
      <td>Hive, Presto</td>
      <td>Kafka, Streaming</td>
    </tr>
    <tr>
      <td><strong>File Size</strong></td>
      <td>Small</td>
      <td>Smaller</td>
      <td>Large</td>
    </tr>
  </tbody>
</table>

<h3 id="when-to-use-which-format">When to Use Which Format?</h3>

<table>
  <thead>
    <tr>
      <th><strong>Use Case</strong></th>
      <th><strong>Recommended Format</strong></th>
      <th><strong>Reason</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Analytics Data Lake</strong></td>
      <td>Parquet</td>
      <td>Versatility, Spark/Athena optimization</td>
    </tr>
    <tr>
      <td><strong>Hive-centric Environment</strong></td>
      <td>ORC</td>
      <td>Perfect integration with Hive</td>
    </tr>
    <tr>
      <td><strong>Real-time Streaming</strong></td>
      <td>Avro</td>
      <td>Fast writes, schema evolution</td>
    </tr>
    <tr>
      <td><strong>Log Collection</strong></td>
      <td>Parquet</td>
      <td>Compression ratio, analytics performance</td>
    </tr>
    <tr>
      <td><strong>CDC Pipeline</strong></td>
      <td>Avro â†’ Parquet</td>
      <td>Streaming + batch conversion</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="parquet-internal-structure">ğŸ”· Parquet Internal Structure</h2>

<h3 id="design-philosophy">Design Philosophy</h3>

<p>Parquet was designed based on Googleâ€™s Dremel paper to <strong>efficiently store nested data structures</strong>.</p>

<h4 id="core-features"><strong>Core Features</strong></h4>
<ul>
  <li><strong>Columnar Storage</strong>: Data stored by column</li>
  <li><strong>Nested Data Support</strong>: Supports complex nested structures</li>
  <li><strong>Efficient Compression</strong>: Optimal compression per column type</li>
  <li><strong>Predicate Pushdown</strong>: Skip unnecessary reads with file-level statistics</li>
</ul>

<h3 id="file-structure">File Structure</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Parquet File Structure:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (Magic: PAR1)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Row Group 1                     â”‚
â”‚  â”œâ”€â”€ Column Chunk A             â”‚
â”‚  â”‚   â”œâ”€â”€ Page 1 (compressed)    â”‚
â”‚  â”‚   â”œâ”€â”€ Page 2 (compressed)    â”‚
â”‚  â”‚   â””â”€â”€ Page 3 (compressed)    â”‚
â”‚  â”œâ”€â”€ Column Chunk B             â”‚
â”‚  â””â”€â”€ Column Chunk C             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Row Group 2                     â”‚
â”‚  â”œâ”€â”€ Column Chunk A             â”‚
â”‚  â”œâ”€â”€ Column Chunk B             â”‚
â”‚  â””â”€â”€ Column Chunk C             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Footer Metadata                 â”‚
â”‚  â”œâ”€â”€ Schema                     â”‚
â”‚  â”œâ”€â”€ Row Group Metadata         â”‚
â”‚  â”œâ”€â”€ Column Statistics          â”‚
â”‚  â””â”€â”€ Compression Codec          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ Footer Size (4 bytes)           â”‚
â”‚ Magic: PAR1 (4 bytes)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<h3 id="row-group-and-page">Row Group and Page</h3>

<h4 id="row-group"><strong>Row Group</strong></h4>
<ul>
  <li><strong>Definition</strong>: Logical group of rows (default 128MB)</li>
  <li><strong>Purpose</strong>: Unit of parallel processing</li>
  <li><strong>Statistics</strong>: Min/Max/Null count per column</li>
</ul>

<h4 id="page"><strong>Page</strong></h4>
<ul>
  <li><strong>Definition</strong>: Unit of compression and encoding (default 1MB)</li>
  <li><strong>Encoding</strong>: Dictionary, RLE, Delta encoding</li>
  <li><strong>Compression</strong>: Snappy, GZIP, LZO, ZSTD</li>
</ul>

<h3 id="parquet-creation-example">Parquet Creation Example</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
    <span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">Parquet Example</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>

<span class="c1"># Generate data
</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mf">100.5</span><span class="p">,</span> <span class="sh">"</span><span class="s">2024-01-15</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">Bob</span><span class="sh">"</span><span class="p">,</span> <span class="mf">200.3</span><span class="p">,</span> <span class="sh">"</span><span class="s">2024-01-15</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sh">"</span><span class="s">Charlie</span><span class="sh">"</span><span class="p">,</span> <span class="mf">150.7</span><span class="p">,</span> <span class="sh">"</span><span class="s">2024-01-15</span><span class="sh">"</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">schema</span> <span class="o">=</span> <span class="nc">StructType</span><span class="p">([</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">IntegerType</span><span class="p">(),</span> <span class="bp">False</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">False</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">amount</span><span class="sh">"</span><span class="p">,</span> <span class="nc">DoubleType</span><span class="p">(),</span> <span class="bp">False</span><span class="p">),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

<span class="c1"># Optimize Parquet settings
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.compression.codec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">snappy</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.block.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">134217728</span><span class="p">)</span>  <span class="c1"># 128MB
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.page.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1048576</span><span class="p">)</span>     <span class="c1"># 1MB
</span>
<span class="c1"># Save
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data/events.parquet</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="parquet-metadata-analysis">Parquet Metadata Analysis</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Read Parquet file metadata
</span><span class="kn">import</span> <span class="n">pyarrow.parquet</span> <span class="k">as</span> <span class="n">pq</span>

<span class="n">parquet_file</span> <span class="o">=</span> <span class="n">pq</span><span class="p">.</span><span class="nc">ParquetFile</span><span class="p">(</span><span class="sh">'</span><span class="s">events.parquet</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Check schema
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Schema:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">parquet_file</span><span class="p">.</span><span class="n">schema</span><span class="p">)</span>

<span class="c1"># Row Group information
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Row Groups: </span><span class="si">{</span><span class="n">parquet_file</span><span class="p">.</span><span class="n">num_row_groups</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Statistics per Row Group
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">parquet_file</span><span class="p">.</span><span class="n">num_row_groups</span><span class="p">):</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="n">parquet_file</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="nf">row_group</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Row Group </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Rows: </span><span class="si">{</span><span class="n">rg</span><span class="p">.</span><span class="n">num_rows</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Total Size: </span><span class="si">{</span><span class="n">rg</span><span class="p">.</span><span class="n">total_byte_size</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Statistics per column
</span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">rg</span><span class="p">.</span><span class="n">num_columns</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">rg</span><span class="p">.</span><span class="nf">column</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Column </span><span class="si">{</span><span class="n">col</span><span class="p">.</span><span class="n">path_in_schema</span><span class="si">}</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Compressed: </span><span class="si">{</span><span class="n">col</span><span class="p">.</span><span class="n">total_compressed_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> KB</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Uncompressed: </span><span class="si">{</span><span class="n">col</span><span class="p">.</span><span class="n">total_uncompressed_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> KB</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    Compression Ratio: </span><span class="si">{</span><span class="n">col</span><span class="p">.</span><span class="n">total_uncompressed_size</span> <span class="o">/</span> <span class="n">col</span><span class="p">.</span><span class="n">total_compressed_size</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">x</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="orc-internal-structure">ğŸ”¶ ORC Internal Structure</h2>

<h3 id="design-philosophy-1">Design Philosophy</h3>

<p>ORC is a format <strong>optimized for Hive workloads</strong>, providing more aggressive compression than Parquet.</p>

<h4 id="core-features-1"><strong>Core Features</strong></h4>
<ul>
  <li><strong>High Compression</strong>: ZLIB default, very high compression ratio</li>
  <li><strong>Built-in Indexes</strong>: Row group, bloom filter, column statistics</li>
  <li><strong>ACID Support</strong>: Hive ACID transaction support</li>
  <li><strong>Predicate Pushdown</strong>: Strong filtering with multi-layer indexes</li>
</ul>

<h3 id="file-structure-1">File Structure</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ORC File Structure:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Postscript                      â”‚
â”‚  â”œâ”€â”€ Compression                â”‚
â”‚  â”œâ”€â”€ Footer Length              â”‚
â”‚  â””â”€â”€ Version                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File Footer                     â”‚
â”‚  â”œâ”€â”€ Schema                     â”‚
â”‚  â”œâ”€â”€ Statistics                 â”‚
â”‚  â”œâ”€â”€ Stripe Information         â”‚
â”‚  â””â”€â”€ User Metadata              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stripe 1                        â”‚
â”‚  â”œâ”€â”€ Index Data                 â”‚
â”‚  â”‚   â”œâ”€â”€ Row Index              â”‚
â”‚  â”‚   â”œâ”€â”€ Bloom Filter           â”‚
â”‚  â”‚   â””â”€â”€ Column Statistics      â”‚
â”‚  â”œâ”€â”€ Data (Compressed)          â”‚
â”‚  â”‚   â”œâ”€â”€ Column A Stream        â”‚
â”‚  â”‚   â”œâ”€â”€ Column B Stream        â”‚
â”‚  â”‚   â””â”€â”€ Column C Stream        â”‚
â”‚  â””â”€â”€ Stripe Footer              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stripe 2                        â”‚
â”‚  â””â”€â”€ ...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<h3 id="stripe-and-index">Stripe and Index</h3>

<h4 id="stripe"><strong>Stripe</strong></h4>
<ul>
  <li><strong>Definition</strong>: Basic processing unit of ORC (default 64MB)</li>
  <li><strong>Composition</strong>: Index Data + Actual Data + Footer</li>
  <li><strong>Parallel Processing</strong>: Distributed processing by stripe</li>
</ul>

<h4 id="index-types"><strong>Index Types</strong></h4>
<ul>
  <li><strong>Row Index</strong>: min/max/sum/count every 10,000 rows</li>
  <li><strong>Bloom Filter</strong>: Fast check for value existence</li>
  <li><strong>Column Statistics</strong>: Stripe-level statistics</li>
</ul>

<h3 id="orc-creation-example">ORC Creation Example</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create ORC in Spark
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">zlib</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.stripe.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">67108864</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.compress.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">262144</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.bloom.filter.columns</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">user_id,product_id</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data/events.orc</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="orc-metadata-analysis">ORC Metadata Analysis</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Analyze ORC file (using PyArrow)
</span><span class="kn">import</span> <span class="n">pyarrow.orc</span> <span class="k">as</span> <span class="n">orc</span>

<span class="n">orc_file</span> <span class="o">=</span> <span class="n">orc</span><span class="p">.</span><span class="nc">ORCFile</span><span class="p">(</span><span class="sh">'</span><span class="s">events.orc</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Schema
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Schema:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">orc_file</span><span class="p">.</span><span class="n">schema</span><span class="p">)</span>

<span class="c1"># Stripe information
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Stripes: </span><span class="si">{</span><span class="n">orc_file</span><span class="p">.</span><span class="n">nstripes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Rows: </span><span class="si">{</span><span class="n">orc_file</span><span class="p">.</span><span class="n">nrows</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Metadata
</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">orc_file</span><span class="p">.</span><span class="n">metadata</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Compression: </span><span class="si">{</span><span class="n">metadata</span><span class="p">.</span><span class="n">compression</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Writer Version: </span><span class="si">{</span><span class="n">metadata</span><span class="p">.</span><span class="n">writer_version</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="avro-internal-structure">ğŸ”¹ Avro Internal Structure</h2>

<h3 id="design-philosophy-2">Design Philosophy</h3>

<p>Avro is a row-based format optimized for <strong>schema evolution and fast serialization</strong>.</p>

<h4 id="core-features-2"><strong>Core Features</strong></h4>
<ul>
  <li><strong>Row-based</strong>: Stores entire records sequentially</li>
  <li><strong>Self-describing</strong>: Schema included in file</li>
  <li><strong>Schema Evolution</strong>: Perfect support for schema changes</li>
  <li><strong>Compact Binary</strong>: Efficient binary encoding</li>
</ul>

<h3 id="file-structure-2">File Structure</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Avro File Structure:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                          â”‚
â”‚  â”œâ”€â”€ Magic: Obj\x01             â”‚
â”‚  â”œâ”€â”€ File Metadata              â”‚
â”‚  â”‚   â”œâ”€â”€ Schema (JSON)          â”‚
â”‚  â”‚   â””â”€â”€ Codec (snappy/deflate) â”‚
â”‚  â””â”€â”€ Sync Marker (16 bytes)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data Block 1                    â”‚
â”‚  â”œâ”€â”€ Record Count               â”‚
â”‚  â”œâ”€â”€ Block Size (compressed)    â”‚
â”‚  â”œâ”€â”€ Records (compressed)       â”‚
â”‚  â”‚   â”œâ”€â”€ Record 1 (all fields)  â”‚
â”‚  â”‚   â”œâ”€â”€ Record 2 (all fields)  â”‚
â”‚  â”‚   â””â”€â”€ Record N (all fields)  â”‚
â”‚  â””â”€â”€ Sync Marker                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data Block 2                    â”‚
â”‚  â””â”€â”€ ...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<h3 id="schema-definition">Schema Definition</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"record"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Event"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.example"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"int"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amount"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"metadata"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"null"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"map"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"values"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
    </span><span class="p">}],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="avro-creation-example">Avro Creation Example</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create Avro in Spark
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">avro</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">snappy</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data/events.avro</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Use Avro in Kafka
</span><span class="kn">from</span> <span class="n">confluent_kafka</span> <span class="kn">import</span> <span class="n">avro</span>
<span class="kn">from</span> <span class="n">confluent_kafka.avro</span> <span class="kn">import</span> <span class="n">AvroProducer</span>

<span class="n">value_schema_str</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
{
   </span><span class="sh">"</span><span class="s">namespace</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">com.example</span><span class="sh">"</span><span class="s">,
   </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">record</span><span class="sh">"</span><span class="s">,
   </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Event</span><span class="sh">"</span><span class="s">,
   </span><span class="sh">"</span><span class="s">fields</span><span class="sh">"</span><span class="s"> : [
     {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">int</span><span class="sh">"</span><span class="s">},
     {</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="s">}
   ]
}
</span><span class="sh">"""</span>

<span class="n">value_schema</span> <span class="o">=</span> <span class="n">avro</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">value_schema_str</span><span class="p">)</span>

<span class="n">avroProducer</span> <span class="o">=</span> <span class="nc">AvroProducer</span><span class="p">({</span>
    <span class="sh">'</span><span class="s">bootstrap.servers</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">localhost:9092</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">schema.registry.url</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">http://localhost:8081</span><span class="sh">'</span>
<span class="p">},</span> <span class="n">default_value_schema</span><span class="o">=</span><span class="n">value_schema</span><span class="p">)</span>

<span class="c1"># Send message
</span><span class="n">avroProducer</span><span class="p">.</span><span class="nf">produce</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="sh">'</span><span class="s">events</span><span class="sh">'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">})</span>
<span class="n">avroProducer</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h2 id="actual-benchmark-comparison">ğŸ“Š Actual Benchmark Comparison</h2>

<h3 id="test-environment">Test Environment</h3>

<table>
  <thead>
    <tr>
      <th><strong>Item</strong></th>
      <th><strong>Configuration</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Dataset</strong></td>
      <td>NYC Taxi (100M records, 100GB CSV)</td>
    </tr>
    <tr>
      <td><strong>Spark Version</strong></td>
      <td>3.4.0</td>
    </tr>
    <tr>
      <td><strong>Instance</strong></td>
      <td>r5.4xlarge Ã— 10</td>
    </tr>
    <tr>
      <td><strong>Compression Codec</strong></td>
      <td>Snappy (Parquet/Avro), ZLIB (ORC)</td>
    </tr>
    <tr>
      <td><strong>Row Group/Stripe</strong></td>
      <td>128MB</td>
    </tr>
  </tbody>
</table>

<h3 id="test-1-file-size-and-compression-ratio">Test 1: File Size and Compression Ratio</h3>

<h4 id="original-data-100gb-csv"><strong>Original Data: 100GB CSV</strong></h4>

<table>
  <thead>
    <tr>
      <th><strong>Format</strong></th>
      <th><strong>Compression Codec</strong></th>
      <th><strong>File Size</strong></th>
      <th><strong>Compression Ratio</strong></th>
      <th><strong>File Count</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>CSV</strong></td>
      <td>None</td>
      <td>100 GB</td>
      <td>1.0x</td>
      <td>1,000</td>
    </tr>
    <tr>
      <td><strong>Parquet</strong></td>
      <td>Snappy</td>
      <td>12.3 GB</td>
      <td><strong>8.1x</strong></td>
      <td>97</td>
    </tr>
    <tr>
      <td><strong>Parquet</strong></td>
      <td>GZIP</td>
      <td>8.9 GB</td>
      <td><strong>11.2x</strong></td>
      <td>70</td>
    </tr>
    <tr>
      <td><strong>ORC</strong></td>
      <td>ZLIB</td>
      <td>9.1 GB</td>
      <td><strong>11.0x</strong></td>
      <td>72</td>
    </tr>
    <tr>
      <td><strong>ORC</strong></td>
      <td>Snappy</td>
      <td>11.8 GB</td>
      <td><strong>8.5x</strong></td>
      <td>93</td>
    </tr>
    <tr>
      <td><strong>Avro</strong></td>
      <td>Snappy</td>
      <td>28.4 GB</td>
      <td><strong>3.5x</strong></td>
      <td>224</td>
    </tr>
    <tr>
      <td><strong>Avro</strong></td>
      <td>Deflate</td>
      <td>24.1 GB</td>
      <td><strong>4.1x</strong></td>
      <td>190</td>
    </tr>
  </tbody>
</table>

<h4 id="compression-time-comparison"><strong>Compression Time Comparison</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>

<span class="c1"># Parquet write
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">output.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">parquet_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># ORC write
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">).</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">output.orc</span><span class="sh">"</span><span class="p">)</span>
<span class="n">orc_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># Avro write
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">avro</span><span class="sh">"</span><span class="p">).</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">output.avro</span><span class="sh">"</span><span class="p">)</span>
<span class="n">avro_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Parquet: </span><span class="si">{</span><span class="n">parquet_time</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># Result: 142.3s
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ORC: </span><span class="si">{</span><span class="n">orc_time</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>          <span class="c1"># Result: 156.8s
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Avro: </span><span class="si">{</span><span class="n">avro_time</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>        <span class="c1"># Result: 98.4s
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th><strong>Format</strong></th>
      <th><strong>Write Time</strong></th>
      <th><strong>Processing Speed</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Parquet (Snappy)</strong></td>
      <td>142.3s</td>
      <td>703 MB/s</td>
    </tr>
    <tr>
      <td><strong>ORC (ZLIB)</strong></td>
      <td>156.8s</td>
      <td>638 MB/s</td>
    </tr>
    <tr>
      <td><strong>Avro (Snappy)</strong></td>
      <td>98.4s</td>
      <td>1,016 MB/s</td>
    </tr>
  </tbody>
</table>

<h3 id="test-2-read-performance-full-scan">Test 2: Read Performance (Full Scan)</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Query: Aggregate entire data</span>
<span class="k">SELECT</span> 
    <span class="n">pickup_date</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">trip_count</span><span class="p">,</span>
    <span class="k">AVG</span><span class="p">(</span><span class="n">fare_amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_fare</span><span class="p">,</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">tip_amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_tips</span>
<span class="k">FROM</span> <span class="n">trips</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">pickup_date</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="read-performance-comparison"><strong>Read Performance Comparison</strong></h4>

<table>
  <thead>
    <tr>
      <th><strong>Format</strong></th>
      <th><strong>Compression</strong></th>
      <th><strong>Scan Time</strong></th>
      <th><strong>Processing Speed</strong></th>
      <th><strong>Memory Usage</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Parquet</strong></td>
      <td>Snappy</td>
      <td>23.4s</td>
      <td>4.3 GB/s</td>
      <td>18.2 GB</td>
    </tr>
    <tr>
      <td><strong>Parquet</strong></td>
      <td>GZIP</td>
      <td>31.2s</td>
      <td>3.2 GB/s</td>
      <td>16.8 GB</td>
    </tr>
    <tr>
      <td><strong>ORC</strong></td>
      <td>ZLIB</td>
      <td>28.7s</td>
      <td>3.5 GB/s</td>
      <td>17.1 GB</td>
    </tr>
    <tr>
      <td><strong>ORC</strong></td>
      <td>Snappy</td>
      <td>24.1s</td>
      <td>4.1 GB/s</td>
      <td>18.5 GB</td>
    </tr>
    <tr>
      <td><strong>Avro</strong></td>
      <td>Snappy</td>
      <td>87.3s</td>
      <td>1.1 GB/s</td>
      <td>32.4 GB</td>
    </tr>
  </tbody>
</table>

<h3 id="test-3-column-selection-query-projection-pushdown">Test 3: Column Selection Query (Projection Pushdown)</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Query: Select specific columns only</span>
<span class="k">SELECT</span> <span class="n">pickup_date</span><span class="p">,</span> <span class="n">fare_amount</span>
<span class="k">FROM</span> <span class="n">trips</span>
<span class="k">WHERE</span> <span class="n">pickup_date</span> <span class="o">=</span> <span class="s1">'2024-01-15'</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="column-selection-performance"><strong>Column Selection Performance</strong></h4>

<table>
  <thead>
    <tr>
      <th><strong>Format</strong></th>
      <th><strong>All Columns</strong></th>
      <th><strong>2 Columns</strong></th>
      <th><strong>Improvement</strong></th>
      <th><strong>Scanned Data</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Parquet</strong></td>
      <td>23.4s</td>
      <td>2.8s</td>
      <td><strong>8.4x</strong></td>
      <td>1.2 GB</td>
    </tr>
    <tr>
      <td><strong>ORC</strong></td>
      <td>28.7s</td>
      <td>3.1s</td>
      <td><strong>9.3x</strong></td>
      <td>1.1 GB</td>
    </tr>
    <tr>
      <td><strong>Avro</strong></td>
      <td>87.3s</td>
      <td>84.2s</td>
      <td><strong>1.0x</strong></td>
      <td>28.4 GB (full)</td>
    </tr>
  </tbody>
</table>

<p><strong>Key Point</strong>: Columnar formats achieve massive performance improvement by reading only specific columns, while Avro must read entire records</p>

<h3 id="test-4-predicate-pushdown">Test 4: Predicate Pushdown</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Query: Filter conditions</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">trips</span>
<span class="k">WHERE</span> <span class="n">fare_amount</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">AND</span> <span class="n">tip_amount</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="predicate-pushdown-effect"><strong>Predicate Pushdown Effect</strong></h4>

<table>
  <thead>
    <tr>
      <th><strong>Format</strong></th>
      <th><strong>Scanned Data</strong></th>
      <th><strong>Actually Read</strong></th>
      <th><strong>Skipped Ratio</strong></th>
      <th><strong>Query Time</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Parquet</strong></td>
      <td>12.3 GB</td>
      <td>3.2 GB</td>
      <td><strong>74%</strong></td>
      <td>8.4s</td>
    </tr>
    <tr>
      <td><strong>ORC</strong></td>
      <td>9.1 GB</td>
      <td>2.1 GB</td>
      <td><strong>77%</strong></td>
      <td>7.2s</td>
    </tr>
    <tr>
      <td><strong>Avro</strong></td>
      <td>28.4 GB</td>
      <td>28.4 GB</td>
      <td><strong>0%</strong></td>
      <td>72.1s</td>
    </tr>
  </tbody>
</table>

<p><strong>Key Point</strong>: ORCâ€™s Row Index and Bloom Filter are most effective</p>

<h3 id="test-5-schema-evolution">Test 5: Schema Evolution</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Schema change test
# 1. Save data with existing schema
</span><span class="n">schema_v1</span> <span class="o">=</span> <span class="nc">StructType</span><span class="p">([</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">IntegerType</span><span class="p">()),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">()),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">amount</span><span class="sh">"</span><span class="p">,</span> <span class="nc">DoubleType</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">df_v1</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">format_type</span><span class="p">).</span><span class="nf">save</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">format_type</span><span class="si">}</span><span class="s">_v1</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2. Schema with new column added
</span><span class="n">schema_v2</span> <span class="o">=</span> <span class="nc">StructType</span><span class="p">([</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="nc">IntegerType</span><span class="p">()),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">()),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">amount</span><span class="sh">"</span><span class="p">,</span> <span class="nc">DoubleType</span><span class="p">()),</span>
    <span class="nc">StructField</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">,</span> <span class="nc">StringType</span><span class="p">())</span>  <span class="c1"># New column
</span><span class="p">])</span>

<span class="n">df_v2</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">format_type</span><span class="p">).</span><span class="nf">save</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">format_type</span><span class="si">}</span><span class="s">_v2</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 3. Read both versions simultaneously
</span><span class="n">df_merged</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">format_type</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">format_type</span><span class="si">}</span><span class="s">_*</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="schema-evolution-support"><strong>Schema Evolution Support</strong></h4>

<table>
  <thead>
    <tr>
      <th><strong>Format</strong></th>
      <th><strong>Add Column</strong></th>
      <th><strong>Drop Column</strong></th>
      <th><strong>Type Change</strong></th>
      <th><strong>Rename Column</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Parquet</strong></td>
      <td>âœ… Possible</td>
      <td>âš ï¸ Caution needed</td>
      <td>âŒ Not possible</td>
      <td>âŒ Not possible</td>
    </tr>
    <tr>
      <td><strong>ORC</strong></td>
      <td>âœ… Possible</td>
      <td>âš ï¸ Caution needed</td>
      <td>âŒ Not possible</td>
      <td>âŒ Not possible</td>
    </tr>
    <tr>
      <td><strong>Avro</strong></td>
      <td>âœ… Full support</td>
      <td>âœ… Full support</td>
      <td>âœ… Partially possible</td>
      <td>âœ… Alias support</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="optimal-format-selection-by-use-case">ğŸ¯ Optimal Format Selection by Use Case</h2>

<h3 id="use-case-1-large-scale-analytics-data-lake">Use Case 1: Large-scale Analytics Data Lake</h3>

<h4 id="scenario"><strong>Scenario</strong></h4>
<ul>
  <li>10TB data collection per day</li>
  <li>Ad-hoc queries with Athena, Spark</li>
  <li>Mainly aggregate queries</li>
</ul>

<h4 id="recommended-parquet-snappy"><strong>Recommended: Parquet (Snappy)</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Optimal settings
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.compression.codec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">snappy</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.block.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">134217728</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.page.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1048576</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.enableVectorizedReader</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>

<span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/analytics/</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Reasons</strong>:</p>
<ul>
  <li>âœ… Perfect Athena support</li>
  <li>âœ… Fast read performance</li>
  <li>âœ… Good compression ratio</li>
  <li>âœ… Versatility</li>
</ul>

<h3 id="use-case-2-hive-centric-data-warehouse">Use Case 2: Hive-centric Data Warehouse</h3>

<h4 id="scenario-1"><strong>Scenario</strong></h4>
<ul>
  <li>Using Hive metastore</li>
  <li>ACID transactions needed</li>
  <li>Frequent UPDATE/DELETE operations</li>
</ul>

<h4 id="recommended-orc-zlib"><strong>Recommended: ORC (ZLIB)</strong></h4>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Create ORC table in Hive</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">events</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="n">name</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">amount</span> <span class="nb">DOUBLE</span><span class="p">,</span>
    <span class="n">event_date</span> <span class="n">STRING</span>
<span class="p">)</span>
<span class="n">PARTITIONED</span> <span class="k">BY</span> <span class="p">(</span><span class="nb">date</span> <span class="n">STRING</span><span class="p">)</span>
<span class="n">STORED</span> <span class="k">AS</span> <span class="n">ORC</span>
<span class="n">TBLPROPERTIES</span> <span class="p">(</span>
    <span class="nv">"orc.compress"</span><span class="o">=</span><span class="nv">"ZLIB"</span><span class="p">,</span>
    <span class="nv">"orc.create.index"</span><span class="o">=</span><span class="nv">"true"</span><span class="p">,</span>
    <span class="nv">"orc.bloom.filter.columns"</span><span class="o">=</span><span class="nv">"id,name"</span>
<span class="p">);</span>

<span class="c1">-- ACID transaction</span>
<span class="k">UPDATE</span> <span class="n">events</span> <span class="k">SET</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mi">1</span><span class="p">.</span><span class="mi">1</span> <span class="k">WHERE</span> <span class="nb">date</span> <span class="o">=</span> <span class="s1">'2024-01-15'</span><span class="p">;</span>
</code></pre></div></div>

<p><strong>Reasons</strong>:</p>
<ul>
  <li>âœ… Hive optimization</li>
  <li>âœ… ACID support</li>
  <li>âœ… Best compression ratio</li>
  <li>âœ… Powerful indexes</li>
</ul>

<h3 id="use-case-3-real-time-streaming-pipeline">Use Case 3: Real-time Streaming Pipeline</h3>

<h4 id="scenario-2"><strong>Scenario</strong></h4>
<ul>
  <li>Real-time data collection with Kafka</li>
  <li>Using Schema Registry</li>
  <li>Frequent schema changes</li>
</ul>

<h4 id="recommended-avro--parquet-hybrid"><strong>Recommended: Avro â†’ Parquet Hybrid</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Real-time: Kafka + Avro
</span><span class="kn">from</span> <span class="n">confluent_kafka</span> <span class="kn">import</span> <span class="n">avro</span>

<span class="c1"># Save to Kafka as Avro
</span><span class="n">avro_producer</span><span class="p">.</span><span class="nf">produce</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="sh">'</span><span class="s">events</span><span class="sh">'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">event_data</span><span class="p">)</span>

<span class="c1"># Batch: Avro â†’ Parquet conversion
</span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">avro</span><span class="sh">"</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/streaming/avro/</span><span class="sh">"</span><span class="p">)</span>

<span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/analytics/parquet/</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Reasons</strong>:</p>
<ul>
  <li>âœ… Avro: Fast writes, schema evolution</li>
  <li>âœ… Parquet: Analytics optimization</li>
  <li>âœ… Leverage both advantages</li>
</ul>

<h3 id="use-case-4-long-term-log-data-storage">Use Case 4: Long-term Log Data Storage</h3>

<h4 id="scenario-3"><strong>Scenario</strong></h4>
<ul>
  <li>50TB log data per day</li>
  <li>Mostly cold storage</li>
  <li>Occasional period-specific analysis</li>
</ul>

<h4 id="recommended-parquet-gzip-or-zstd"><strong>Recommended: Parquet (GZIP or ZSTD)</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Maximum compression ratio settings
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.compression.codec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gzip</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># or zstd
</span>
<span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/logs/</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Automatic transition with lifecycle policy
</span><span class="kn">import</span> <span class="n">boto3</span>

<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="sh">'</span><span class="s">s3</span><span class="sh">'</span><span class="p">)</span>
<span class="n">s3</span><span class="p">.</span><span class="nf">put_bucket_lifecycle_configuration</span><span class="p">(</span>
    <span class="n">Bucket</span><span class="o">=</span><span class="sh">'</span><span class="s">bucket</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">LifecycleConfiguration</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">Rules</span><span class="sh">'</span><span class="p">:</span> <span class="p">[{</span>
            <span class="sh">'</span><span class="s">Id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">TransitionLogs</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Enabled</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Prefix</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">logs/</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Transitions</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="sh">'</span><span class="s">Days</span><span class="sh">'</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="sh">'</span><span class="s">StorageClass</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">STANDARD_IA</span><span class="sh">'</span><span class="p">},</span>
                <span class="p">{</span><span class="sh">'</span><span class="s">Days</span><span class="sh">'</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="sh">'</span><span class="s">StorageClass</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">GLACIER</span><span class="sh">'</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}]</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<p><strong>Reasons</strong>:</p>
<ul>
  <li>âœ… High compression ratio (storage cost savings)</li>
  <li>âœ… S3 Glacier compatible</li>
  <li>âœ… Fast analysis when needed</li>
</ul>

<h3 id="use-case-5-complex-nested-data">Use Case 5: Complex Nested Data</h3>

<h4 id="scenario-4"><strong>Scenario</strong></h4>
<ul>
  <li>JSON event data</li>
  <li>Deep nested structures</li>
  <li>Frequently query only specific fields</li>
</ul>

<h4 id="recommended-parquet"><strong>Recommended: Parquet</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Nested JSON data
</span><span class="n">json_data</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
{
  </span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="s">: {
    </span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">: 123,
    </span><span class="sh">"</span><span class="s">profile</span><span class="sh">"</span><span class="s">: {
      </span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="s">,
      </span><span class="sh">"</span><span class="s">email</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">alice@example.com</span><span class="sh">"</span><span class="s">
    }
  },
  </span><span class="sh">"</span><span class="s">event</span><span class="sh">"</span><span class="s">: {
    </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">purchase</span><span class="sh">"</span><span class="s">,
    </span><span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="s">: [
      {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">: 1, </span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="s">: 100.5},
      {</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="s">: 2, </span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="s">: 50.3}
    ]
  }
}
</span><span class="sh">"""</span>

<span class="c1"># Handle nested structure in Spark
</span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">json</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/raw/events.json</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Save as Parquet (preserving nested structure)
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/processed/events.parquet</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Efficiently read only specific fields
</span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/processed/events.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">user.profile.name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event.type</span><span class="sh">"</span><span class="p">).</span><span class="nf">show</span><span class="p">()</span>
<span class="c1"># Parquet reads only needed columns (nested column pruning)
</span></code></pre></div></div>

<p><strong>Reasons</strong>:</p>
<ul>
  <li>âœ… Perfect nested structure support</li>
  <li>âœ… Nested column pruning</li>
  <li>âœ… Memory efficient</li>
</ul>

<hr />

<h2 id="format-conversion-guide">ğŸ”„ Format Conversion Guide</h2>

<h3 id="csv--parquet-migration">CSV â†’ Parquet Migration</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
    <span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">CSV to Parquet</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>

<span class="c1"># Read CSV (schema inference)
</span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">inferSchema</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">csv</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/raw/csv/*.csv</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Optimize data types
</span><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">amount</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">decimal(10,2)</span><span class="sh">"</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">,</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># Convert to Parquet
</span><span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> \
    <span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">snappy</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/processed/parquet/</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Original CSV: </span><span class="si">{</span><span class="n">df</span><span class="p">.</span><span class="nf">inputFiles</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Rows: </span><span class="si">{</span><span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="migration-results"><strong>Migration Results</strong></h4>

<table>
  <thead>
    <tr>
      <th><strong>Item</strong></th>
      <th><strong>CSV</strong></th>
      <th><strong>Parquet</strong></th>
      <th><strong>Improvement</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>File Size</strong></td>
      <td>100 GB</td>
      <td>12.3 GB</td>
      <td><strong>87% reduction</strong></td>
    </tr>
    <tr>
      <td><strong>Query Time</strong></td>
      <td>245s</td>
      <td>23.4s</td>
      <td><strong>10.5x faster</strong></td>
    </tr>
    <tr>
      <td><strong>S3 Cost</strong></td>
      <td>$2,300/month</td>
      <td>$283/month</td>
      <td><strong>87% savings</strong></td>
    </tr>
    <tr>
      <td><strong>Athena Scan</strong></td>
      <td>$512/query</td>
      <td>$62/query</td>
      <td><strong>88% savings</strong></td>
    </tr>
  </tbody>
</table>

<h3 id="avro--parquet-batch-conversion">Avro â†’ Parquet Batch Conversion</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert Avro collected from streaming to Parquet for analytics
</span><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
    <span class="p">.</span><span class="nf">appName</span><span class="p">(</span><span class="sh">"</span><span class="s">Avro to Parquet Batch</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>

<span class="c1"># Process yesterday's data
</span><span class="n">yesterday</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)).</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y-%m-%d</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Read Avro
</span><span class="n">avro_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">s3://bucket/streaming/avro/date=</span><span class="si">{</span><span class="n">yesterday</span><span class="si">}</span><span class="s">/</span><span class="sh">"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">avro</span><span class="sh">"</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="n">avro_path</span><span class="p">)</span>

<span class="c1"># Data quality check
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Records: </span><span class="si">{</span><span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Duplicates: </span><span class="si">{</span><span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">-</span> <span class="n">df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">().</span><span class="nf">count</span><span class="p">()</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Remove duplicates and sort
</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">])</span> \
    <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">event_time</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Save as Parquet
</span><span class="n">parquet_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">s3://bucket/analytics/parquet/date=</span><span class="si">{</span><span class="n">yesterday</span><span class="si">}</span><span class="s">/</span><span class="sh">"</span>
<span class="n">df</span><span class="p">.</span><span class="nf">repartition</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> \
    <span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">)</span>

<span class="c1"># Validation
</span><span class="n">parquet_df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">==</span> <span class="n">parquet_df</span><span class="p">.</span><span class="nf">count</span><span class="p">(),</span> <span class="sh">"</span><span class="s">Record count mismatch!</span><span class="sh">"</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">âœ“ Migration completed: </span><span class="si">{</span><span class="n">yesterday</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="orc--parquet-mutual-conversion">ORC â†” Parquet Mutual Conversion</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ORC â†’ Parquet
</span><span class="n">orc_df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data.orc</span><span class="sh">"</span><span class="p">)</span>
<span class="n">orc_df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data.parquet</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Parquet â†’ ORC
</span><span class="n">parquet_df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">parquet_df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">).</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data.orc</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Performance comparison
</span><span class="kn">import</span> <span class="n">time</span>

<span class="c1"># ORC read
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="n">orc_df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/large_data.orc</span><span class="sh">"</span><span class="p">)</span>
<span class="n">orc_count</span> <span class="o">=</span> <span class="n">orc_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
<span class="n">orc_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># Parquet read
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="n">parquet_df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/large_data.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">parquet_count</span> <span class="o">=</span> <span class="n">parquet_df</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
<span class="n">parquet_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ORC: </span><span class="si">{</span><span class="n">orc_time</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s, </span><span class="si">{</span><span class="n">orc_count</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s"> rows</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Parquet: </span><span class="si">{</span><span class="n">parquet_time</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s, </span><span class="si">{</span><span class="n">parquet_count</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s"> rows</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="production-optimization-tips">ğŸ› ï¸ Production Optimization Tips</h2>

<h3 id="parquet-optimization">Parquet Optimization</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Choose compression codec
# - Snappy: Fast compression/decompression (real-time analytics)
# - GZIP: High compression ratio (long-term storage)
# - ZSTD: Balanced performance (recommended)
</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.compression.codec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">zstd</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2. Adjust Row Group size
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.block.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">268435456</span><span class="p">)</span>  <span class="c1"># 256MB
</span>
<span class="c1"># 3. Utilize dictionary encoding
# Automatically applied to low cardinality columns
# To manually disable:
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.enableDictionaryEncoding</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 4. Enable vectorized reader
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.enableVectorizedReader</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 5. Binary as string optimization
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.parquet.binaryAsString</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="orc-optimization">ORC Optimization</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Adjust Stripe size
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.orc.stripe.size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">67108864</span><span class="p">)</span>  <span class="c1"># 64MB
</span>
<span class="c1"># 2. Set Bloom filter
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">orc</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.bloom.filter.columns</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">user_id,product_id</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.bloom.filter.fpp</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data.orc</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 3. Choose compression
# - ZLIB: Best compression ratio (default)
# - SNAPPY: Fast performance
# - LZO: Balanced
</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.orc.compression.codec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">zlib</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 4. Index stride (row index interval)
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">orc.row.index.stride</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="avro-optimization">Avro Optimization</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Compression settings
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span> \
    <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="sh">"</span><span class="s">avro</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">option</span><span class="p">(</span><span class="sh">"</span><span class="s">compression</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">snappy</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">s3://bucket/data.avro</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2. Schema registry integration
</span><span class="kn">from</span> <span class="n">confluent_kafka</span> <span class="kn">import</span> <span class="n">avro</span>
<span class="kn">from</span> <span class="n">confluent_kafka.avro</span> <span class="kn">import</span> <span class="n">AvroProducer</span>

<span class="n">producer_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">bootstrap.servers</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">localhost:9092</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">schema.registry.url</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">http://localhost:8081</span><span class="sh">'</span>
<span class="p">}</span>

<span class="n">producer</span> <span class="o">=</span> <span class="nc">AvroProducer</span><span class="p">(</span><span class="n">producer_config</span><span class="p">,</span> <span class="n">default_value_schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="format-selection-decision-tree">Format Selection Decision Tree</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">choose_format</span><span class="p">(</span><span class="n">use_case</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Format selection helper function</span><span class="sh">"""</span>
    
    <span class="c1"># Real-time streaming?
</span>    <span class="k">if</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">streaming</span><span class="sh">"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">schema_changes</span><span class="sh">"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Avro</span><span class="sh">"</span>
    
    <span class="c1"># Hive-centric environment?
</span>    <span class="k">if</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">hive</span><span class="sh">"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">acid</span><span class="sh">"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">ORC</span><span class="sh">"</span>
    
    <span class="c1"># Maximum compression needed?
</span>    <span class="k">if</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">storage_critical</span><span class="sh">"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">ORC with ZLIB</span><span class="sh">"</span>
    
    <span class="c1"># General analytics?
</span>    <span class="k">if</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">analytics</span><span class="sh">"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">athena</span><span class="sh">"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Parquet with Snappy</span><span class="sh">"</span>
    
    <span class="c1"># Fast writes needed?
</span>    <span class="k">if</span> <span class="n">use_case</span><span class="p">[</span><span class="sh">"</span><span class="s">write_heavy</span><span class="sh">"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Avro</span><span class="sh">"</span>
    
    <span class="c1"># Default
</span>    <span class="k">return</span> <span class="sh">"</span><span class="s">Parquet</span><span class="sh">"</span>

<span class="c1"># Usage example
</span><span class="n">use_case</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">streaming</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">schema_changes</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">hive</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">acid</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">storage_critical</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">analytics</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">athena</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">write_heavy</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
<span class="p">}</span>

<span class="n">recommended</span> <span class="o">=</span> <span class="nf">choose_format</span><span class="p">(</span><span class="n">use_case</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Recommended format: </span><span class="si">{</span><span class="n">recommended</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># Output: Recommended format: Parquet with Snappy
</span></code></pre></div></div>

<hr />

<h2 id="learning-summary">ğŸ“š Learning Summary</h2>

<h3 id="key-points">Key Points</h3>

<ol>
  <li><strong>Understanding Format Characteristics</strong>
    <ul>
      <li><strong>Parquet</strong>: General analytics, Athena/Spark optimization</li>
      <li><strong>ORC</strong>: Hive optimization, best compression ratio, ACID support</li>
      <li><strong>Avro</strong>: Streaming, schema evolution, fast writes</li>
    </ul>
  </li>
  <li><strong>Performance Comparison Summary</strong>
    <ul>
      <li><strong>Compression Ratio</strong>: ORC &gt; Parquet &gt; Avro</li>
      <li><strong>Read Performance</strong>: Parquet â‰ˆ ORCÂ Â» Avro</li>
      <li><strong>Write Performance</strong>: Avro &gt; Parquet â‰ˆ ORC</li>
      <li><strong>Column Selection</strong>: Parquet/ORC 8-9x faster</li>
    </ul>
  </li>
  <li><strong>Production Selection Guide</strong>
    <ul>
      <li><strong>Analytics-focused</strong>: Parquet (Snappy)</li>
      <li><strong>Hive Environment</strong>: ORC (ZLIB)</li>
      <li><strong>Streaming</strong>: Avro â†’ Parquet hybrid</li>
      <li><strong>Long-term Storage</strong>: Parquet (GZIP/ZSTD)</li>
    </ul>
  </li>
  <li><strong>Optimization Strategies</strong>
    <ul>
      <li>File size: Maintain 64-256MB</li>
      <li>Compression codec: Choose according to purpose</li>
      <li>Partitioning: Simple and shallow</li>
      <li>Schema design: Optimize data types</li>
    </ul>
  </li>
</ol>

<h3 id="production-checklist">Production Checklist</h3>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use case analysis complete</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Current format performance measured</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Benchmark tests performed</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Format selection and configuration optimized</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Migration plan established</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Validation process defined</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Cost impact analyzed</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Monitoring dashboard built</li>
</ul>

<h3 id="next-steps">Next Steps</h3>

<ul>
  <li><strong>Apache Iceberg/Delta Lake</strong>: Abstracting file formats with table formats</li>
  <li><strong>Parquet Advanced Optimization</strong>: Bloom filter, Column index</li>
  <li><strong>Compression Algorithm Comparison</strong>: ZSTD vs LZ4 vs Brotli</li>
  <li><strong>Schema Evolution Strategy</strong>: Compatibility management</li>
</ul>

<hr />

<blockquote>
  <p><strong>â€œFile format selection is not just a technical decision, but a strategic choice that directly impacts business outcomes.â€</strong></p>
</blockquote>

<p>Data lake file format is difficult to change once decided. Understanding the characteristics of each format accurately and choosing the optimal format for your use case is key to building a successful data lake. We hope this guide helps you make the right choice!</p>

  </div>

  
  <div class="post-navigation">
    <div class="nav-links">
      
      
      
        
      
        
      
        
      
      
      
      
      
        
        
        <a href="/data-engineering/2025/10/21/delta-lake-iceberg-hudi-comparison.html" class="nav-link next">
          ë‹¤ìŒ: Delta Lake vs Iceberg vs Hudi ì‹¤ì „ ë¹„êµ - í…Œì´ë¸” í¬ë§· ì™„ì „ ì •ë³µ â†’
        </a>
      
    </div>
    
    <div class="series-overview">
      <a href="/categories/data-engineering/" class="btn btn-secondary">
        ğŸ“š ì‹œë¦¬ì¦ˆ ì „ì²´ ë³´ê¸°
      </a>
    </div>
  </div>
  
</article>

    </div>
  </main>
  
  
  <footer class="site-footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h3>Data Droid Blog</h3>
        <p>ë°ì´í„° ì—”ì§€ë‹ˆì–´ê°€ ë‹¤ë£¨ëŠ” ê¸°ìˆ  ë¸”ë¡œê·¸</p>
      </div>
      
      <div class="footer-section">
        <h4>Categories</h4>
        <ul>
          <li><a href="/en/categories/data-engineering/">Data Engineering</a></li>
          <li><a href="/en/categories/bi-engineering/">BI Engineering</a></li>
          <li><a href="/en/categories/infrastructure-tools/">Infrastructure & Tools</a></li>
          <li><a href="/en/categories/data-quality/">Data Quality</a></li>
          <li><a href="/en/categories/data-ai/">Data AI</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>Links</h4>
        <ul>
          <li><a href="/en/">Home</a></li>
          <li><a href="/en/blog/">Blog</a></li>
          <li><a href="/en/about/">About</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>Social</h4>
        <ul>
          
          <li><a href="https://github.com/data-droid">GitHub</a></li>
          
          <li><a href="https://www.linkedin.com/in/jaekyung-lee/">LinkedIn</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2026 Data Droid Blog. All rights reserved</p>
    </div>
  </div>
</footer>



  
  <script src="/assets/js/main.js"></script>
</body>
</html>
