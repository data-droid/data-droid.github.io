<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="/assets/css/style.css">
  <!-- Head includes for Jekyll -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SEO -->

<meta name="description" content="Advanced batch processing techniques in Apache Spark, UDF writing, and production environment setup using Docker and Kubernetes.">



<title>Part 2: Apache Spark Large-scale Batch Processing and UDF Usage - Real-world Project - Data Droid Blog</title>


<!-- Open Graph -->
<meta property="og:title" content="Part 2: Apache Spark Large-scale Batch Processing and UDF Usage - Real-world Project">
<meta property="og:description" content="Advanced batch processing techniques in Apache Spark, UDF writing, and production environment setup using Docker and Kubernetes.">
<meta property="og:url" content="http://localhost:4000/en_posts/2025-09-12-apache-spark-batch-processing.html">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Part 2: Apache Spark Large-scale Batch Processing and UDF Usage - Real-world Project">
<meta name="twitter:description" content="Advanced batch processing techniques in Apache Spark, UDF writing, and production environment setup using Docker and Kubernetes.">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Data Droid Blog" href="/feed.xml">

<!-- Google Analytics -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GP9LT745PP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GP9LT745PP');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <div class="site-title">
      <a href="/">Data Droid Blog</a>
    </div>
    
    <!-- Mobile menu toggle button -->
    <button class="mobile-menu-toggle" aria-label="Î©îÎâ¥ Ïó¥Í∏∞/Îã´Í∏∞">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    
    <nav class="site-nav">
      <ul class="nav-list">
        <li><a href="/">Home</a></li>
                  <li class="dropdown">
            <a href="#" class="dropdown-toggle">Categories</a>
            <ul class="dropdown-menu">

              <li><a href="/en/categories/data-engineering/">Data Engineering</a></li>
              <li><a href="/en/categories/bi-engineering/">BI Engineering</a></li>
              <li><a href="/en/categories/infrastructure-tools/">Infrastructure & Tools</a></li>
              <li><a href="/en/categories/data-quality/">Data Quality</a></li>
              <li><a href="/en/categories/data-ai/">Data AI</a></li>
            </ul>
          </li>
        <li><a href="/en/blog/">Blog</a></li>
        <li><a href="/en/about/">About</a></li>
      </ul>
    </nav>
    
    <div class="language-switcher">
      
        <!-- Ìè¨Ïä§Ìä∏Ïö© Ïñ∏Ïñ¥ Ï†ÑÌôò -->
        
          
          <a href="/data-engineering/2025/09/12/apache-spark-batch-processing.html" class="lang-btn">ÌïúÍµ≠Ïñ¥</a>
          <a href="/en_posts/2025-09-12-apache-spark-batch-processing.html" class="lang-btn active">English</a>
        
      
    </div>
  </div>
</header>

  
  <main class="site-main">
    <div class="container">
      <article class="post">
  <header class="post-header">
    <div class="post-meta">
      <span class="post-category">Data engineering</span>
      <span class="post-date">2025ÎÖÑ 09Ïõî 12Ïùº</span>
      <span class="post-author">Data Droid</span>
    </div>
    
    <h1 class="post-title">Part 2: Apache Spark Large-scale Batch Processing and UDF Usage - Real-world Project</h1>
    
    
    <div class="post-tags">
      
        <span class="tag">Apache-Spark</span>
      
        <span class="tag">UDF</span>
      
        <span class="tag">Batch-Processing</span>
      
        <span class="tag">Docker</span>
      
        <span class="tag">Kubernetes</span>
      
        <span class="tag">Airflow</span>
      
        <span class="tag">Performance-Optimization</span>
      
        <span class="tag">Python</span>
      
    </div>
    
    
    
    <div class="post-series">
      <span class="series-badge">üìö Apache spark complete guide ÏãúÎ¶¨Ï¶à</span>
      <span class="series-order">Part 3</span>
    </div>
    
    
    
    <div class="post-info">
      
        <span class="reading-time">‚è±Ô∏è 45 min</span>
      
      
        <span class="difficulty">üìä Advanced</span>
      
    </div>
    
  </header>

  <div class="post-content">
    <h1 id="part-2-apache-spark-large-scale-batch-processing-and-udf-usage---real-world-project">Part 2: Apache Spark Large-scale Batch Processing and UDF Usage - Real-world Project</h1>

<blockquote>
  <p>Advanced batch processing techniques in Apache Spark, UDF writing, and production environment setup using Docker and Kubernetes.</p>
</blockquote>

<h2 id="-table-of-contents">üìñ Table of Contents</h2>

<ol>
  <li><a href="#udf-user-defined-function-complete-guide">UDF (User Defined Function) Complete Guide</a></li>
  <li><a href="#advanced-aggregation-and-window-functions">Advanced Aggregation and Window Functions</a></li>
  <li><a href="#partitioning-strategy-and-performance-optimization">Partitioning Strategy and Performance Optimization</a></li>
  <li><a href="#real-world-project-e-commerce-data-analysis">Real-world Project: E-commerce Data Analysis</a></li>
  <li><a href="#docker-and-kubernetes-deployment">Docker and Kubernetes Deployment</a></li>
  <li><a href="#airflow-scheduling">Airflow Scheduling</a></li>
  <li><a href="#learning-summary">Learning Summary</a></li>
</ol>

<h2 id="-udf-user-defined-function-complete-guide">üîß UDF (User Defined Function) Complete Guide</h2>

<h3 id="what-is-udf">What is UDF?</h3>

<p>UDF is a method to write custom functions that are not provided by Spark for data transformation.</p>

<h3 id="udf-writing-methods">UDF Writing Methods</h3>

<h4 id="1-basic-udf-writing"><strong>1. Basic UDF Writing</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">BooleanType</span>

<span class="c1"># Simple string processing UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">  </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Mathematical calculation UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">discount_rate</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">discount_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">discount_rate</span><span class="p">))</span>

<span class="c1"># Conditional processing UDF
</span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">categorize_price</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Unknown</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Low</span><span class="sh">"</span>
    <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Medium</span><span class="sh">"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">High</span><span class="sh">"</span>

<span class="c1"># Usage example
</span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">  Product A  </span><span class="sh">"</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">Product B</span><span class="sh">"</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mf">600.0</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount_rate</span><span class="sh">"</span><span class="p">])</span>

<span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">clean_name</span><span class="sh">"</span><span class="p">,</span> <span class="nf">clean_text</span><span class="p">(</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">final_price</span><span class="sh">"</span><span class="p">,</span> <span class="nf">calculate_discount</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount_rate</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">price_category</span><span class="sh">"</span><span class="p">,</span> <span class="nf">categorize_price</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">))</span> \
  <span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="2-complex-udf---json-parsing"><strong>2. Complex UDF - JSON Parsing</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">MapType</span><span class="p">,</span> <span class="n">StringType</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">MapType</span><span class="p">(</span><span class="nc">StringType</span><span class="p">(),</span> <span class="nc">StringType</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">parse_json_metadata</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_str</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="c1"># Convert to strings for return
</span>        <span class="k">return</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nf">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="c1"># Usage example
</span><span class="n">json_data</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">electronics</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Samsung</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">rating</span><span class="sh">"</span><span class="s">: 4.5}</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">clothing</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Nike</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">rating</span><span class="sh">"</span><span class="s">: 4.2}</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">'</span><span class="s">invalid json</span><span class="sh">'</span><span class="p">)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">])</span>

<span class="n">json_data</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">parsed_metadata</span><span class="sh">"</span><span class="p">,</span> <span class="nf">parse_json_metadata</span><span class="p">(</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="3-advanced-udf---machine-learning-model-application"><strong>3. Advanced UDF - Machine Learning Model Application</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">FloatType</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">IsolationForest</span>

<span class="c1"># Global model variable
</span><span class="n">model</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">initialize_model</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="c1"># Initialize simple anomaly detection model
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">IsolationForest</span><span class="p">(</span><span class="n">contamination</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="c1"># Train with dummy data
</span>    <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)</span>

<span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">anomaly_score</span><span class="p">(</span><span class="n">features_array</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nf">initialize_model</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">features_array</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">features_array</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">features_array</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">decision_function</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

<span class="c1"># Usage example
</span><span class="n">features_data</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="nf">createDataFrame</span><span class="p">([</span>
    <span class="p">([</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">],),</span>
    <span class="p">([</span><span class="mf">10.5</span><span class="p">,</span> <span class="mf">15.2</span><span class="p">,</span> <span class="mf">8.9</span><span class="p">],),</span>
    <span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],)</span>
<span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">features</span><span class="sh">"</span><span class="p">])</span>

<span class="n">features_data</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">anomaly_score</span><span class="sh">"</span><span class="p">,</span> <span class="nf">anomaly_score</span><span class="p">(</span><span class="sh">"</span><span class="s">features</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="udf-optimization-tips">UDF Optimization Tips</h3>

<h4 id="1-using-vectorized-udf"><strong>1. Using Vectorized UDF</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">pandas_udf</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">FloatType</span>

<span class="c1"># Pandas UDF provides faster performance
</span><span class="nd">@pandas_udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">FloatType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">fast_calculation</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="c1"># Vectorized operations for performance improvement
</span>    <span class="k">return</span> <span class="n">series</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># Usage
</span><span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">fast_result</span><span class="sh">"</span><span class="p">,</span> <span class="nf">fast_calculation</span><span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="2-udf-caching-and-reuse"><strong>2. UDF Caching and Reuse</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define UDF as function for reuse
</span><span class="k">def</span> <span class="nf">create_text_processor</span><span class="p">():</span>
    <span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">process_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">process_text</span>

<span class="c1"># Reuse across multiple DataFrames
</span><span class="n">text_processor</span> <span class="o">=</span> <span class="nf">create_text_processor</span><span class="p">()</span>
<span class="n">df1</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">processed</span><span class="sh">"</span><span class="p">,</span> <span class="nf">text_processor</span><span class="p">(</span><span class="sh">"</span><span class="s">text1</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
<span class="n">df2</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">processed</span><span class="sh">"</span><span class="p">,</span> <span class="nf">text_processor</span><span class="p">(</span><span class="sh">"</span><span class="s">text2</span><span class="sh">"</span><span class="p">)).</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="-advanced-aggregation-and-window-functions">üìä Advanced Aggregation and Window Functions</h2>

<h3 id="advanced-window-functions">Advanced Window Functions</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">row_number</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">lead</span><span class="p">,</span> 
    <span class="n">first_value</span><span class="p">,</span> <span class="n">last_value</span><span class="p">,</span> <span class="n">nth_value</span><span class="p">,</span>
    <span class="n">cume_dist</span><span class="p">,</span> <span class="n">percent_rank</span><span class="p">,</span> <span class="n">ntile</span>
<span class="p">)</span>

<span class="c1"># Define complex window specification
</span><span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Apply various window functions
</span><span class="n">df_advanced</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">row_num</span><span class="sh">"</span><span class="p">,</span> <span class="nf">row_number</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">dense_rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">dense_rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">lag</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">next_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">lead</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">first_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">first_value</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">last_sales</span><span class="sh">"</span><span class="p">,</span> <span class="nf">last_value</span><span class="p">(</span><span class="sh">"</span><span class="s">sales_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">cumulative_dist</span><span class="sh">"</span><span class="p">,</span> <span class="nf">cume_dist</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">percentile_rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">percent_rank</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
    <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">quartile</span><span class="sh">"</span><span class="p">,</span> <span class="nf">ntile</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="advanced-aggregation-functions">Advanced Aggregation Functions</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">collect_list</span><span class="p">,</span> <span class="n">collect_set</span><span class="p">,</span> <span class="n">array_agg</span><span class="p">,</span>
    <span class="n">stddev</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">skewness</span><span class="p">,</span> <span class="n">kurtosis</span><span class="p">,</span>
    <span class="n">corr</span><span class="p">,</span> <span class="n">covar_pop</span><span class="p">,</span> <span class="n">covar_samp</span>
<span class="p">)</span>

<span class="c1"># Statistical aggregation
</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
        <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">stddev</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">stddev_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">variance</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">variance_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">skewness</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">skewness_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">kurtosis</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">kurtosis_price</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">collect_list</span><span class="p">(</span><span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">all_products</span><span class="sh">"</span><span class="p">),</span>
        <span class="nf">collect_set</span><span class="p">(</span><span class="sh">"</span><span class="s">brand</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_brands</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<h2 id="-partitioning-strategy-and-performance-optimization">‚ö° Partitioning Strategy and Performance Optimization</h2>

<h3 id="partitioning-strategy">Partitioning Strategy</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Column-based partitioning
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">year</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">month</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">path/to/partitioned_data</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 2. Bucketing
</span><span class="n">df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">bucketBy</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">user_id</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">sortBy</span><span class="p">(</span><span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">)</span> \
    <span class="p">.</span><span class="nf">saveAsTable</span><span class="p">(</span><span class="sh">"</span><span class="s">bucketed_table</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 3. Dynamic partitioning
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">128MB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="performance-optimization-settings">Performance Optimization Settings</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Memory optimization
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
<span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Caching strategy
</span><span class="n">df</span><span class="p">.</span><span class="nf">cache</span><span class="p">()</span>  <span class="c1"># Memory caching
</span><span class="n">df</span><span class="p">.</span><span class="nf">persist</span><span class="p">(</span><span class="n">StorageLevel</span><span class="p">.</span><span class="n">MEMORY_AND_DISK</span><span class="p">)</span>  <span class="c1"># Memory+disk caching
</span>
<span class="c1"># Broadcast join
</span><span class="n">spark</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">spark.sql.autoBroadcastJoinThreshold</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">10MB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="-real-world-project-e-commerce-data-analysis">üõí Real-world Project: E-commerce Data Analysis</h2>

<h3 id="project-structure">Project Structure</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ecommerce-analysis/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ data_processing.py
‚îÇ   ‚îú‚îÄ‚îÄ analytics.py
‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ spark_config.py
‚îÇ   ‚îî‚îÄ‚îÄ app_config.yaml
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_data_processing.py
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ kubernetes/
‚îÇ   ‚îú‚îÄ‚îÄ spark-job.yaml
‚îÇ   ‚îî‚îÄ‚îÄ airflow-dag.py
‚îî‚îÄ‚îÄ README.md
</code></pre></div></div>

<h3 id="1-data-processing-module">1. Data Processing Module</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/data_processing.py
</span><span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="n">logging</span>

<span class="k">class</span> <span class="nc">EcommerceDataProcessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load data</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Loading data from </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Load from various data sources
</span>        <span class="n">orders_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/orders</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">products_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/products</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customers_df</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s">/customers</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span>
    
    <span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Clean data</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Cleaning data...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Remove duplicates
</span>        <span class="n">orders_clean</span> <span class="o">=</span> <span class="n">orders_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">order_id</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">products_clean</span> <span class="o">=</span> <span class="n">products_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">customers_clean</span> <span class="o">=</span> <span class="n">customers_df</span><span class="p">.</span><span class="nf">dropDuplicates</span><span class="p">([</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">])</span>
        
        <span class="c1"># Handle NULL values
</span>        <span class="n">orders_clean</span> <span class="o">=</span> <span class="n">orders_clean</span><span class="p">.</span><span class="nf">fillna</span><span class="p">({</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">discount</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">products_clean</span> <span class="o">=</span> <span class="n">products_clean</span><span class="p">.</span><span class="nf">fillna</span><span class="p">({</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Unknown</span><span class="sh">"</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span>
    
    <span class="k">def</span> <span class="nf">enrich_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Enrich data</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Enriching data...</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Data enrichment through joins
</span>        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">orders_df</span> \
            <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">products_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">customers_df</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Add calculated columns
</span>        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">,</span> 
            <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">discount</span><span class="sh">"</span><span class="p">))</span>
        <span class="p">)</span>
        
        <span class="c1"># Customer tier calculation UDF
</span>        <span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="nc">StringType</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">calculate_customer_tier</span><span class="p">(</span><span class="n">total_spent</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">VIP</span><span class="sh">"</span>
            <span class="k">elif</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Gold</span><span class="sh">"</span>
            <span class="k">elif</span> <span class="n">total_spent</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Silver</span><span class="sh">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">Bronze</span><span class="sh">"</span>
        
        <span class="c1"># Calculate total purchase amount by customer
</span>        <span class="n">customer_totals</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">enriched_df</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">customer_totals</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_tier</span><span class="sh">"</span><span class="p">,</span> <span class="nf">calculate_customer_tier</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">enriched_df</span>
</code></pre></div></div>

<h3 id="2-advanced-analytics-module">2. Advanced Analytics Module</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/analytics.py
</span><span class="kn">from</span> <span class="n">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="k">class</span> <span class="nc">EcommerceAnalytics</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spark_session</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_session</span>
    
    <span class="k">def</span> <span class="nf">sales_analysis</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Sales analysis</span><span class="sh">"""</span>
        <span class="c1"># Daily sales trend
</span>        <span class="n">daily_sales</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">daily_revenue</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">daily_customers</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_order_value</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Sales analysis by product
</span>        <span class="n">product_sales</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_quantity</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_revenue</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">unique_customers</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span> \
            <span class="p">.</span><span class="nf">orderBy</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="sh">"</span><span class="s">total_revenue</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">daily_sales</span><span class="p">,</span> <span class="n">product_sales</span>
    
    <span class="k">def</span> <span class="nf">customer_analysis</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Customer analysis</span><span class="sh">"""</span>
        <span class="c1"># Purchase patterns by customer
</span>        <span class="n">customer_patterns</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">customer_tier</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_orders</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">total_spent</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">avg</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">avg_order_value</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">min</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">first_purchase</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">last_purchase</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># RFM analysis (Recency, Frequency, Monetary)
</span>        <span class="n">rfm_analysis</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span>
                <span class="nf">datediff</span><span class="p">(</span><span class="nf">current_date</span><span class="p">(),</span> <span class="nf">max</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">recency</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">count</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">frequency</span><span class="sh">"</span><span class="p">),</span>
                <span class="nf">sum</span><span class="p">(</span><span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">monetary</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">customer_patterns</span><span class="p">,</span> <span class="n">rfm_analysis</span>
    
    <span class="k">def</span> <span class="nf">advanced_analytics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Advanced analytics</span><span class="sh">"""</span>
        <span class="c1"># Cohort analysis
</span>        <span class="n">cohort_analysis</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_month</span><span class="sh">"</span><span class="p">,</span> <span class="nf">date_format</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yyyy-MM</span><span class="sh">"</span><span class="p">))</span> \
            <span class="p">.</span><span class="nf">groupBy</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_month</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">agg</span><span class="p">(</span><span class="nf">countDistinct</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">alias</span><span class="p">(</span><span class="sh">"</span><span class="s">cohort_size</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="c1"># Collaborative filtering foundation for product recommendation
</span>        <span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">partitionBy</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">).</span><span class="nf">orderBy</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="sh">"</span><span class="s">order_date</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="n">customer_product_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">product_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">total_amount</span><span class="sh">"</span><span class="p">)</span> \
            <span class="p">.</span><span class="nf">withColumn</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">,</span> <span class="nf">row_number</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">))</span> \
            <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">col</span><span class="p">(</span><span class="sh">"</span><span class="s">rank</span><span class="sh">"</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># Recent 10 purchased products
</span>        
        <span class="k">return</span> <span class="n">cohort_analysis</span><span class="p">,</span> <span class="n">customer_product_matrix</span>
</code></pre></div></div>

<h3 id="3-configuration-files">3. Configuration Files</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/spark_config.py
</span><span class="k">def</span> <span class="nf">get_spark_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">spark.app.name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">EcommerceAnalysis</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.master</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">local[*]</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.coalescePartitions.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.advisoryPartitionSizeInBytes</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">128MB</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.serializer</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">org.apache.spark.serializer.KryoSerializer</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.execution.arrow.pyspark.enabled</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionFactor</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">5</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">256MB</span><span class="sh">"</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/app_config.yaml</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">input_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/input"</span>
  <span class="na">output_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/output"</span>
  <span class="na">checkpoint_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/data/checkpoint"</span>

<span class="na">processing</span><span class="pi">:</span>
  <span class="na">batch_size</span><span class="pi">:</span> <span class="m">10000</span>
  <span class="na">parallelism</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">cache_enabled</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">output</span><span class="pi">:</span>
  <span class="na">format</span><span class="pi">:</span> <span class="s2">"</span><span class="s">parquet"</span>
  <span class="na">compression</span><span class="pi">:</span> <span class="s2">"</span><span class="s">snappy"</span>
  <span class="na">partition_by</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">year"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">month"</span><span class="pi">]</span>
</code></pre></div></div>

<h2 id="-docker-and-kubernetes-deployment">üê≥ Docker and Kubernetes Deployment</h2>

<h3 id="1-dockerfile">1. Dockerfile</h3>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="s"> openjdk:8-jdk-alpine</span>

<span class="c"># Install Python</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> python3 py3-pip

<span class="c"># Install Spark</span>
<span class="k">ENV</span><span class="s"> SPARK_VERSION=3.4.0</span>
<span class="k">ENV</span><span class="s"> HADOOP_VERSION=3</span>
<span class="k">ENV</span><span class="s"> SPARK_HOME=/opt/spark</span>
<span class="k">ENV</span><span class="s"> PATH=$PATH:$SPARK_HOME/bin</span>

<span class="k">RUN </span>wget <span class="nt">-q</span> https://archive.apache.org/dist/spark/spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span>/spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">tar </span>xzf spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">mv </span>spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span> <span class="k">${</span><span class="nv">SPARK_HOME</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">rm </span>spark-<span class="k">${</span><span class="nv">SPARK_VERSION</span><span class="k">}</span><span class="nt">-bin-hadoop</span><span class="k">${</span><span class="nv">HADOOP_VERSION</span><span class="k">}</span>.tgz

<span class="c"># Install Python dependencies</span>
<span class="k">COPY</span><span class="s"> requirements.txt /app/</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># Copy application code</span>
<span class="k">COPY</span><span class="s"> src/ /app/src/</span>
<span class="k">COPY</span><span class="s"> config/ /app/config/</span>

<span class="c"># Grant execution permission</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /app/src/main.py

<span class="c"># Expose ports</span>
<span class="k">EXPOSE</span><span class="s"> 4040 8080</span>

<span class="c"># Execute command</span>
<span class="k">CMD</span><span class="s"> ["python3", "/app/src/main.py"]</span>
</code></pre></div></div>

<h3 id="2-kubernetes-job-configuration">2. Kubernetes Job Configuration</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubernetes/spark-job.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ecommerce-analysis-job</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spark-driver</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">ecommerce-analysis:latest</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">python3"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/app/src/main.py"</span><span class="pi">]</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_MASTER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">k8s://https://kubernetes.default.svc.cluster.local:443"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_APP_NAME</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ecommerce-analysis"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_DRIVER_HOST</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.podIP</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_DRIVER_PORT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">7077"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SPARK_UI_PORT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">4040"</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">4Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/data</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app/config</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data-volume</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">data-pvc</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">app-config</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
  <span class="na">backoffLimit</span><span class="pi">:</span> <span class="m">3</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">data-pvc</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">100Gi</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">app-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-engineering</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">app_config.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">data:</span>
      <span class="s">input_path: "/data/input"</span>
      <span class="s">output_path: "/data/output"</span>
    <span class="s">processing:</span>
      <span class="s">batch_size: 10000</span>
      <span class="s">parallelism: 4</span>
</code></pre></div></div>

<h3 id="3-spark-application-execution">3. Spark Application Execution</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># src/main.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="n">data_processing</span> <span class="kn">import</span> <span class="n">EcommerceDataProcessor</span>
<span class="kn">from</span> <span class="n">analytics</span> <span class="kn">import</span> <span class="n">EcommerceAnalytics</span>
<span class="kn">from</span> <span class="n">config.spark_config</span> <span class="kn">import</span> <span class="n">get_spark_config</span>

<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%(asctime)s - %(name)s - %(levelname)s - %(message)s</span><span class="sh">'</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nf">setup_logging</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create Spark session
</span>        <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">.</span><span class="n">builder</span> \
            <span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="nf">get_spark_config</span><span class="p">())</span> \
            <span class="p">.</span><span class="nf">getOrCreate</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Spark session created successfully</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Initialize data processor
</span>        <span class="n">processor</span> <span class="o">=</span> <span class="nc">EcommerceDataProcessor</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">analytics</span> <span class="o">=</span> <span class="nc">EcommerceAnalytics</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        
        <span class="c1"># Set data paths
</span>        <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">INPUT_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/data/input</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">OUTPUT_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/data/output</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Load and process data
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">load_data</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Cleaning data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">clean_data</span><span class="p">(</span>
            <span class="n">orders_df</span><span class="p">,</span> <span class="n">products_df</span><span class="p">,</span> <span class="n">customers_df</span>
        <span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Enriching data...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">enriched_df</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">enrich_data</span><span class="p">(</span>
            <span class="n">orders_clean</span><span class="p">,</span> <span class="n">products_clean</span><span class="p">,</span> <span class="n">customers_clean</span>
        <span class="p">)</span>
        
        <span class="c1"># Perform analysis
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing sales analysis...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">daily_sales</span><span class="p">,</span> <span class="n">product_sales</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">sales_analysis</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing customer analysis...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customer_patterns</span><span class="p">,</span> <span class="n">rfm_analysis</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">customer_analysis</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Performing advanced analytics...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">cohort_analysis</span><span class="p">,</span> <span class="n">customer_product_matrix</span> <span class="o">=</span> <span class="n">analytics</span><span class="p">.</span><span class="nf">advanced_analytics</span><span class="p">(</span><span class="n">enriched_df</span><span class="p">)</span>
        
        <span class="c1"># Save results
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Saving results...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">enriched_df</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/enriched_data</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">daily_sales</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/daily_sales</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">product_sales</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/product_sales</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">customer_patterns</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/customer_patterns</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rfm_analysis</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="nf">mode</span><span class="p">(</span><span class="sh">"</span><span class="s">overwrite</span><span class="sh">"</span><span class="p">).</span><span class="nf">parquet</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/rfm_analysis</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Job completed successfully!</span><span class="sh">"</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Job failed with error: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">spark</span><span class="sh">'</span> <span class="ow">in</span> <span class="nf">locals</span><span class="p">():</span>
            <span class="n">spark</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="-airflow-scheduling">üîÑ Airflow Scheduling</h2>

<h3 id="airflow-dag">Airflow DAG</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubernetes/airflow-dag.py
</span><span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="n">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="n">airflow.kubernetes</span> <span class="kn">import</span> <span class="n">KubernetesPodOperator</span>
<span class="kn">from</span> <span class="n">airflow.operators.dummy</span> <span class="kn">import</span> <span class="n">DummyOperator</span>
<span class="kn">from</span> <span class="n">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>

<span class="c1"># Default arguments
</span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">owner</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-engineering</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">depends_on_past</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="nf">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">email_on_failure</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">email_on_retry</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">retries</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">retry_delay</span><span class="sh">'</span><span class="p">:</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Define DAG
</span><span class="n">dag</span> <span class="o">=</span> <span class="nc">DAG</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">ecommerce_analysis_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">E-commerce data analysis pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="sh">'</span><span class="s">0 2 * * *</span><span class="sh">'</span><span class="p">,</span>  <span class="c1"># Run daily at 2 AM
</span>    <span class="n">catchup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">ecommerce</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">spark</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">analytics</span><span class="sh">'</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Start task
</span><span class="n">start_task</span> <span class="o">=</span> <span class="nc">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">start_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Data validation task
</span><span class="k">def</span> <span class="nf">validate_input_data</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">os</span>
    <span class="n">input_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/input</span><span class="sh">"</span>
    <span class="n">required_files</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">orders</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">products</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">customers</span><span class="sh">"</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">required_files</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Required file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Input data validation completed successfully</span><span class="sh">"</span><span class="p">)</span>

<span class="n">validate_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">validate_input_data</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">validate_input_data</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Spark analysis task
</span><span class="n">spark_analysis_task</span> <span class="o">=</span> <span class="nc">KubernetesPodOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">spark_ecommerce_analysis</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="sh">'</span><span class="s">data-engineering</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="sh">'</span><span class="s">ecommerce-analysis:latest</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">spark-analysis-pod</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">cmds</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">python3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">/app/src/main.py</span><span class="sh">'</span><span class="p">],</span>
    <span class="n">env_vars</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">INPUT_PATH</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data/input</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">OUTPUT_PATH</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data/output</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">SPARK_MASTER</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">k8s://https://kubernetes.default.svc.cluster.local:443</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">SPARK_APP_NAME</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ecommerce-analysis</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">request_memory</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2Gi</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">request_cpu</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">limit_memory</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">4Gi</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">limit_cpu</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">volumes</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-volume</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">persistentVolumeClaim</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">claimName</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-pvc</span><span class="sh">'</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="n">volume_mounts</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">data-volume</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">mountPath</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/data</span><span class="sh">'</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="n">get_logs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">is_delete_operator_pod</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Output validation task
</span><span class="k">def</span> <span class="nf">validate_output_data</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">os</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/output</span><span class="sh">"</span>
    <span class="n">required_outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">enriched_data</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">daily_sales</span><span class="sh">"</span><span class="p">,</span> 
        <span class="sh">"</span><span class="s">product_sales</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">customer_patterns</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">rfm_analysis</span><span class="sh">"</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">required_outputs</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Output directory not found: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Check if files exist
</span>        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Output directory is empty: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Output data validation completed successfully</span><span class="sh">"</span><span class="p">)</span>

<span class="n">validate_output_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">validate_output_data</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">validate_output_data</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Notification task
</span><span class="k">def</span> <span class="nf">send_completion_notification</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Ecommerce analysis pipeline completed successfully!</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># In real environment, send notifications via Slack, Email, etc.
</span>    <span class="c1"># slack_webhook_url = os.getenv('SLACK_WEBHOOK_URL')
</span>    <span class="c1"># send_slack_notification(slack_webhook_url, "Pipeline completed successfully")
</span>
<span class="n">notification_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">send_completion_notification</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">send_completion_notification</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># End task
</span><span class="n">end_task</span> <span class="o">=</span> <span class="nc">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="sh">'</span><span class="s">end_pipeline</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Define task dependencies
</span><span class="n">start_task</span> <span class="o">&gt;&gt;</span> <span class="n">validate_task</span> <span class="o">&gt;&gt;</span> <span class="n">spark_analysis_task</span> <span class="o">&gt;&gt;</span> <span class="n">validate_output_task</span> <span class="o">&gt;&gt;</span> <span class="n">notification_task</span> <span class="o">&gt;&gt;</span> <span class="n">end_task</span>
</code></pre></div></div>

<h3 id="deployment-script">Deployment Script</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># deploy.sh</span>

<span class="nb">echo</span> <span class="s2">"Building Docker image..."</span>
docker build <span class="nt">-t</span> ecommerce-analysis:latest <span class="nb">.</span>

<span class="nb">echo</span> <span class="s2">"Loading image to Kubernetes cluster..."</span>
kind load docker-image ecommerce-analysis:latest

<span class="nb">echo</span> <span class="s2">"Applying Kubernetes manifests..."</span>
kubectl apply <span class="nt">-f</span> kubernetes/spark-job.yaml

<span class="nb">echo</span> <span class="s2">"Deploying Airflow DAG..."</span>
kubectl <span class="nb">cp </span>kubernetes/airflow-dag.py airflow-web-0:/opt/airflow/dags/

<span class="nb">echo</span> <span class="s2">"Deployment completed!"</span>
</code></pre></div></div>

<h2 id="-learning-summary">üìö Learning Summary</h2>

<h3 id="what-we-learned-in-this-part">What We Learned in This Part</h3>

<ol>
  <li><strong>UDF (User Defined Function)</strong>
    <ul>
      <li>Basic UDF writing and usage</li>
      <li>Complex UDF (JSON parsing, ML model application)</li>
      <li>UDF optimization techniques</li>
    </ul>
  </li>
  <li><strong>Advanced Aggregation and Window Functions</strong>
    <ul>
      <li>Various window function usage</li>
      <li>Statistical aggregation functions</li>
      <li>Advanced analysis like RFM analysis</li>
    </ul>
  </li>
  <li><strong>Performance Optimization</strong>
    <ul>
      <li>Partitioning strategies</li>
      <li>Memory optimization settings</li>
      <li>Caching strategies</li>
    </ul>
  </li>
  <li><strong>Real-world Project</strong>
    <ul>
      <li>E-commerce data analysis system</li>
      <li>Modularized code structure</li>
      <li>Error handling and logging</li>
    </ul>
  </li>
  <li><strong>Production Deployment</strong>
    <ul>
      <li>Docker containerization</li>
      <li>Kubernetes Job deployment</li>
      <li>Airflow scheduling</li>
    </ul>
  </li>
</ol>

<h3 id="core-technology-stack">Core Technology Stack</h3>

<table>
  <thead>
    <tr>
      <th>Technology</th>
      <th>Purpose</th>
      <th>Importance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>UDF</strong></td>
      <td>Custom data transformation</td>
      <td>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td>
    </tr>
    <tr>
      <td><strong>Window Functions</strong></td>
      <td>Advanced analysis</td>
      <td>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td>
    </tr>
    <tr>
      <td><strong>Docker</strong></td>
      <td>Containerization</td>
      <td>‚≠ê‚≠ê‚≠ê‚≠ê</td>
    </tr>
    <tr>
      <td><strong>Kubernetes</strong></td>
      <td>Orchestration</td>
      <td>‚≠ê‚≠ê‚≠ê‚≠ê</td>
    </tr>
    <tr>
      <td><strong>Airflow</strong></td>
      <td>Workflow management</td>
      <td>‚≠ê‚≠ê‚≠ê‚≠ê</td>
    </tr>
  </tbody>
</table>

<h3 id="next-part-preview">Next Part Preview</h3>

<p><strong>Part 3: Real-time Streaming Processing</strong> will cover:</p>
<ul>
  <li>Spark Streaming and Structured Streaming</li>
  <li>Kafka integration and real-time data processing</li>
  <li>Watermarking and late data processing</li>
  <li>Real-time analysis dashboard construction</li>
</ul>

<hr />

<p><strong>Next Part</strong>: <a href="/en/data-engineering/2025/09/13/apache-spark-streaming.html">Part 3: Real-time Streaming Processing and Kafka Integration</a></p>

<hr />

<p><em>You‚Äôve now mastered large-scale batch processing and production deployment! In the next part, we‚Äôll enter the world of real-time streaming processing.</em> üöÄ</p>

  </div>

  
  <div class="post-navigation">
    <div class="nav-links">
      
      
      
        
      
        
      
        
      
        
      
        
      
      
      
      
      
        
        
        <a href="/data-engineering/2024/09/12/apache-spark-streaming.html" class="nav-link next">
          Îã§Ïùå: Part 3: Apache Spark Ïã§ÏãúÍ∞Ñ Ïä§Ìä∏Î¶¨Î∞ç Ï≤òÎ¶¨ÏôÄ Kafka Ïó∞Îèô - Ïã§Î¨¥ ÌîÑÎ°úÏ†ùÌä∏ ‚Üí
        </a>
      
    </div>
    
    <div class="series-overview">
      <a href="/categories/data-engineering/" class="btn btn-secondary">
        üìö ÏãúÎ¶¨Ï¶à Ï†ÑÏ≤¥ Î≥¥Í∏∞
      </a>
    </div>
  </div>
  
</article>

    </div>
  </main>
  
  
  <footer class="site-footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h3>Data Droid Blog</h3>
        <p>Îç∞Ïù¥ÌÑ∞ ÏóîÏßÄÎãàÏñ¥Í∞Ä Îã§Î£®Îäî Í∏∞Ïà† Î∏îÎ°úÍ∑∏</p>
      </div>
      
      <div class="footer-section">
        <h4>Categories</h4>
        <ul>
          <li><a href="/en/categories/data-engineering/">Data Engineering</a></li>
          <li><a href="/en/categories/bi-engineering/">BI Engineering</a></li>
          <li><a href="/en/categories/infrastructure-tools/">Infrastructure & Tools</a></li>
          <li><a href="/en/categories/data-quality/">Data Quality</a></li>
          <li><a href="/en/categories/data-ai/">Data AI</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>Links</h4>
        <ul>
          <li><a href="/en/">Home</a></li>
          <li><a href="/en/blog/">Blog</a></li>
          <li><a href="/en/about/">About</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>Social</h4>
        <ul>
          
          <li><a href="https://github.com/data-droid">GitHub</a></li>
          
          <li><a href="https://www.linkedin.com/in/jaekyung-lee-a61ab2193/">LinkedIn</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 Data Droid Blog. All rights reserved</p>
    </div>
  </div>
</footer>



  
  <script src="/assets/js/main.js"></script>
</body>
</html>
